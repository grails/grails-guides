<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>6 Building Analytics app</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/guide.css" type="text/css" media="screen, print" title="Style" charset="utf-8" />            
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Grails Framework Guide 
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/training.html"><strong>1</strong><span>Training</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/gettingStarted.html"><strong>2</strong><span>Getting Started</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/runningTheApp.html"><strong>3</strong><span>Application Overview</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/kakfaDocker.html"><strong>4</strong><span>Running Kafka</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/originalAppGrails.html"><strong>5</strong><span>Books Application</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/buildingAnalytics.html"><strong>6</strong><span>Building Analytics app</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/running.html"><strong>7</strong><span>Running the apps</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/nextSteps.html"><strong>8</strong><span>Next Steps</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/helpWithGrails.html"><strong>9</strong><span>Do you need help with Grails?</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/originalAppGrails.html">&lt;&lt; <strong>5</strong><span>Books Application</span></a></div>
                

                
                    <div class="toc-item next-right"><a href="../guide/running.html"><strong>7</strong><span>Running the apps</span> >></a></div>
                


                

                

<h1 id="buildingAnalytics">6 Building Analytics app</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-micronaut-kakfa/edit/master/src/main/docs/guide/buildingAnalytics.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a new Grails application for this additional app. For example by using
<a href="http://start.grails.org/">Grails Application Forge</a> or the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ grails create-app example.grails.complete-analytics --profile=rest-api</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the multi app part of this guide we will need to be able to run both apps simultaneously. To avoid a running port conflict update your app&#8217;s <code>application.yml</code> to include the following:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="key">server</span>:
    <span class="key">port</span>: <span class="string"><span class="content">8081</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a Domain class <code>BookAnalytics</code> which will keep track of how many times a book has been viewed:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/domain/example/grails/BookAnalytics.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.grails

<span class="type">class</span> <span class="class">BookAnalytics</span> {
    <span class="predefined-type">String</span> isbn
    <span class="predefined-type">Long</span> count

    <span class="directive">static</span> constraints = {
        isbn <span class="key">unique</span>: <span class="predefined-constant">true</span>, <span class="key">blank</span>: <span class="predefined-constant">false</span>, <span class="key">nullable</span>: <span class="predefined-constant">false</span>
        count <span class="key">blank</span>: <span class="predefined-constant">false</span>, <span class="key">nullable</span>: <span class="predefined-constant">false</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a GORM Data service for this domain class:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/example/grails/BookAnalyticsGormService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.grails

<span class="keyword">import</span> <span class="include">grails.gorm.services.Query</span>
<span class="keyword">import</span> <span class="include">grails.gorm.services.Service</span>
<span class="keyword">import</span> <span class="include">javax.inject.Singleton</span>

<span class="annotation">@Singleton</span>
<span class="annotation">@Service</span>(BookAnalytics)
<span class="type">interface</span> BookAnalyticsGormService {

    <span class="predefined-type">List</span>&lt;BookAnalytics&gt; findAll()

    BookAnalytics findByIsbn(<span class="predefined-type">String</span> isbn)

    BookAnalytics saveBookAnalytics(BookAnalytics bookAnalytics)

    <span class="annotation">@Query</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">update </span><span class="inline"><span class="inline-delimiter">${</span>BookAnalytics bookAnalytics<span class="inline-delimiter">}</span></span><span class="content"> set </span><span class="inline"><span class="inline-delimiter">${</span>bookAnalytics.count<span class="inline-delimiter">}</span></span><span class="content"> = </span><span class="inline"><span class="inline-delimiter">$</span>newCount</span><span class="content"> where bookAnalytics.isbn = </span><span class="inline"><span class="inline-delimiter">$</span>isbn</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="type">void</span> updateCount(<span class="predefined-type">String</span> isbn, <span class="predefined-type">Long</span> newCount)

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Implement update operations using JPA-QL</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a controller which uses the previous service:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/example/grails/AnalyticsController.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.grails

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">AnalyticsController</span> {
    BookAnalyticsGormService bookAnalyticsGormService

    <span class="keyword">def</span> <span class="function">index</span>() {
        [<span class="key">analytics</span>: bookAnalyticsGormService.findAll()]
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create two JSON Views:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/views/analytics/_bookAnalytics.gson</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">example.grails.BookAnalytics</span>
model {
    BookAnalytics bookAnalytics
}
json {
    isbn bookAnalytics.id
    count bookAnalytics.count
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/views/analytics/index.gson</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">example.grails.BookAnalytics</span>
model {
    <span class="predefined-type">List</span>&lt;BookAnalytics&gt; analytics = <span class="type">[]</span>
}
json tmpl.bookAnalytics(analytics)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a new class to act as a consumer of the messages sent to Kafka by the books microservice. The Micronaut framework will implement logic to invoke the consumer at compile time. Create the <code>AnalyticsListener</code> class:</p>
</div>
<div class="listingblock">
<div class="title">src/main/groovy/example/grails/AnalyticsListener.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.grails

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">io.micronaut.configuration.kafka.annotation.KafkaListener</span>
<span class="keyword">import</span> <span class="include">io.micronaut.configuration.kafka.annotation.Topic</span>
<span class="keyword">import</span> <span class="include">io.micronaut.context.annotation.Requires</span>
<span class="keyword">import</span> <span class="include">io.micronaut.context.env.Environment</span>
<span class="keyword">import</span> <span class="include">org.springframework.beans.factory.annotation.Autowired</span>

<span class="annotation">@CompileStatic</span>
<span class="annotation">@Requires</span>(notEnv = Environment.TEST) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@KafkaListener</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="type">class</span> <span class="class">AnalyticsListener</span> {

    <span class="directive">private</span> <span class="directive">final</span> BookAnalyticsGormService bookAnalyticsGormService <i class="conum" data-value="3"></i><b>(3)</b>

    AnalyticsListener(BookAnalyticsGormService bookAnalyticsGormService) { <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="local-variable">this</span>.bookAnalyticsGormService = bookAnalyticsGormService
    }

    <span class="annotation">@Topic</span>(<span class="string"><span class="delimiter">'</span><span class="content">analytics</span><span class="delimiter">'</span></span>) <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="type">void</span> updateAnalytics(<span class="predefined-type">Map</span> payload) {

        <span class="keyword">if</span> (payload.containsKey(<span class="string"><span class="delimiter">'</span><span class="content">isbn</span><span class="delimiter">'</span></span>)) {
            BookAnalytics bookAnalytics = bookAnalyticsGormService.findByIsbn(payload.isbn <span class="keyword">as</span> <span class="predefined-type">String</span>)
            <span class="keyword">if</span> (bookAnalytics) {
                bookAnalyticsGormService.updateCount(payload.isbn <span class="keyword">as</span> <span class="predefined-type">String</span>, bookAnalytics.count + <span class="integer">1</span>)
            } <span class="keyword">else</span> {
                bookAnalytics = <span class="keyword">new</span> BookAnalytics(<span class="key">isbn</span>: payload.isbn <span class="keyword">as</span> <span class="predefined-type">String</span>, <span class="key">count</span>: <span class="integer">1L</span>)
                bookAnalyticsGormService.saveBookAnalytics(bookAnalytics)
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Do not load this bean for the test environment - this lets us run the tests without having Kafka running</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate the class with @KafkaListener to indicate that this bean will consume messages from Kafka</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Constructor injection for <code>BookAnalyticsGormService</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Annotate the method with <code>@Topic</code> and specify the topic name to use</td>
</tr>
</table>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/originalAppGrails.html">&lt;&lt; <strong>5</strong><span>Books Application</span></a></div>
                
                    <div class="toc-item next-right"><a href="../guide/running.html"><strong>7</strong><span>Running the apps</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title" style="text-align: right"><a href="https://travis-ci.org/grails-guides/grails-micronaut-kakfa"><img src="https://travis-ci.org/grails-guides/grails-micronaut-kakfa.svg?branch=master" /></a></div>            
                 <div class="local-title">
                    <a href="https://github.com/grails-guides/grails-micronaut-kakfa">
                    <svg height="35" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="35" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></a> &nbsp;&nbsp;Get the Code
                </div>
                <div class="menu">
                    <div class="input-group">                        
                        <button href="#" onclick="document.getElementById('github-url').value='git@github.com:grails-guides/grails-micronaut-kakfa.git'" class="codeButton">SSH</button>
                        <button onclick="document.getElementById('github-url').value='https://github.com/grails-guides/grails-micronaut-kakfa.git'" class="codeButton">HTTPS</button>
                        <button onclick="document.getElementById('github-url').value='https://github.com/grails-guides/grails-micronaut-kakfa'" class="codeButton">Subversion</button>
                    </div>
       
                    <div class="input-group">                    
                        <!-- Target -->
                        <input id="github-url" value="git@github.com:grails-guides/grails-micronaut-kakfa.git" type="text" />

                        <!-- Trigger -->
                        <button class="clipbtn" type="button" data-clipboard-target="#github-url">

                            <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
                        </button>       

                    </div>
                    <div class="input-group">
                      <a href="https://github.com/grails-guides/grails-micronaut-kakfa/archive/master.zip" class="downloadButton">Download ZIP</a>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
