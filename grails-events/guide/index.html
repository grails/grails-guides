<!DOCTYPE html>
<html>
  <head>
    <meta name='google-site-verification' content='REYQ1_I6HGowAE7LOLVqfQbnKaB4IfFpMlGzMbJj55Q' />
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <link rel='icon' href='/images/favicon.ico' />
    <link rel='mask-icon' href='//images/grails-pinned-icon.svg' color='feb672' />
    <meta charset='UTF-8' />
    <title>Grails Events | Grails Guides | Grails Framework</title>
    <meta name='description' content='Grails Events. Grails Events to handle a common scenario. A user registers himself in an application and the app sends the user a welcome email.' />
    <link rel='stylesheet' href='../css/main.css' />
    <link rel='stylesheet' href='../css/screen.css' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js'></script>
  </head>
  <body class='guide'><header class='mainheader'>
  <div class='content'>
    <a href='https://grails.org/index.html'><img class='grailslogo' src='/images/grails_logo.svg' alt='Grails Logo' /></a>
    <a href='javascript:show(&apos;topmenus&apos;, &apos;showNavigationLink&apos;)' id='showNavigationLink' class='mobile align-center'>Show Navigation</a>
    <div id='topmenus'>
      <nav class='secondarymenu' id='secondarymenu'><ul>
  <li>
    <a href='https://grails.org/learning.html'>Learning</a>
  </li>
  <li>
    <a href='https://grails.org/community.html'>Community</a>
  </li>
  <li>
    <a href='https://grails.org/search.html'>Search</a>
  </li>
</ul></nav>
      <nav class='mainmenu' id='mainmenu'><ul>
  <li>
    <a href='https://grails.org/documentation.html'>Documentation</a>
  </li>
  <li>
    <a href='https://grails.org/download.html'>Download</a>
  </li>
  <li>
    <a href='https://plugins.grails.org'>Plugins</a>
  </li>
  <li>
    <a href='https://guides.grails.org/index.html'>Guides</a>
  </li>
  <li>
    <a href='https://grails.org/faq.html'>FAQ</a>
  </li>
  <li>
    <a href='https://grails.org/support.html'>Support</a>
  </li>
</ul></nav>
    </div>
  </div>
</header><div class='fullwidth'><article class="guide">
    <aside>
        <a href="https://travis-ci.org/grails-guides/grails-events"><img src="https://travis-ci.org/grails-guides/grails-events.svg?branch=master"></a>

        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/grails-guides/grails-events&quot;"><img height="15" src="../img/github_white.svg" alt="Github"/><span>&nbsp;Get the Code</span></button>


        <ul class="githublinks">
            <li><button type="button" class="btn btn-default" href="#" onclick="document.getElementById('github-url').value='git@github.com:grails-guides/grails-events.git'" class="codeButton">SSH</button></li>
            <li><button type="button" class="btn btn-default" onclick="document.getElementById('github-url').value='https://github.com/grails-guides/grails-events.git'" class="codeButton">HTTPS</button></li>
        </ul>
        <div class="input-group">
            <!-- Target -->
            <input id="github-url" value="git@github.com:grails-guides/grails-events.git" type="text" />
            <!-- Trigger -->
            <button type="button" class="clippy btn btn-default" type="button" data-clipboard-target="#github-url">
                <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
            </button>
        </div>
        <script>var clipboard = new Clipboard('.clippy');</script>
        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/grails-guides/grails-events/archive/master.zip&quot;">Download ZIP</button>
        
        <div id="table-of-content">
            <h3>Table of Contents</h3>
            
            <div class="toc-item" style="margin-left:0px"><a href="#gettingStarted"><strong>1</strong><span>Getting Started</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#requirements"><strong>1.1</strong><span>What you will need</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#howto"><strong>1.2</strong><span>How to complete the guide</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#writingTheApp"><strong>2</strong><span>Writing the Application</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#domain"><strong>2.1</strong><span>Domain Classes</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#dataServices"><strong>2.2</strong><span>Data Services</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#urlMapping"><strong>2.3</strong><span>Url Mapping</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#view"><strong>2.4</strong><span>View</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#services"><strong>2.5</strong><span>Services</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#controllers"><strong>2.6</strong><span>Controller</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#testing"><strong>2.7</strong><span>Testing</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#runningTheApp"><strong>3</strong><span>Running the Tests</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#helpWithGrails"><strong>4</strong><span>Help with Grails</span></a></div>
            
            <div style="clear:both" ></div>
        </div>
        
    </aside>
    <header>
        <h1>Grails Events</h1>
        <p>Grails Events to handle a common scenario. A user registers himself in an application and the app sends the user a welcome email.</p>
        <p><strong>Authors:</strong> Sergio del Amo</p>
        <p><strong>Grails Version:</strong> 5.0.1</p>
    </header>
    

<h1 id="gettingStarted">1 Getting Started</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/gettingStarted.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>In this guide, you are going to use <a href="https://async.grails.org/latest/guide/index.html#events">Grails Events</a> to handle a common scenario. A user registers in an application and the app sends the user a welcome email. For example, asking him to verify his email address.
We are going to trigger the Email Notification by publishing an event when the user is registered.</p>
</div>


<h2 id="requirements">1.1 What you will need</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/requirements.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 1.8 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
</ul>
</div>


<h2 id="howto">1.2 How to complete the guide</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/howto.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To get started do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/grails-guides/grails-events/archive/master.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone the <a href="https://git-scm.com/">Git</a> repository:<br>
<code>git clone <a href="https://github.com/grails-guides/grails-events.git" class="bare">https://github.com/grails-guides/grails-events.git</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Grails guides repositories contain two folders:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>initial</code>  Initial project. Often a simple Grails app with some additional code to give you a head-start.</p>
</li>
<li>
<p><code>complete</code> A completed example. It is the result of working through the steps presented by the guide and applying those changes to the <code>initial</code> folder.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To complete the guide, go to the <code>initial</code> folder</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cd</code> into <code>grails-guides/grails-events/initial</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>and follow the instructions in the next sections.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can go right to the <strong>completed example</strong> if you <code>cd</code> into <code>grails-guides/grails-events/complete</code>
</td>
</tr>
</table>
</div>


<h1 id="writingTheApp">2 Writing the Application</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Grails 3.3 introduces a new Events API that replaces the previous implementation that was based on Reactor 2.x (which is no longer maintained and deprecated).</p>
</div>
<div class="paragraph">
<p>In Grails 3.3 and above a new EventBus abstraction has been introduced. Like the PromiseFactory notion, there are implementations of the EventBus interface for common asynchronous frameworks like GPars and RxJava.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Your project already contains the events dependency:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails.plugins:events</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Grails Events capabilites documentation can be found in <a href="https://async.grails.org/latest/guide/index.html#events">async.grails.org</a>.</p>
</div>


<h2 id="domain">2.1 Domain Classes</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/domain.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Add two domain classes.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/domain/demo/User.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="type">class</span> <span class="class">User</span> {
    <span class="predefined-type">String</span> firstName
    <span class="predefined-type">String</span> lastName
    <span class="predefined-type">String</span> email

    <span class="directive">static</span> constraints = {
        firstName <span class="key">nullable</span>: <span class="predefined-constant">false</span>
        lastName <span class="key">nullable</span>: <span class="predefined-constant">false</span>
        email <span class="key">nullable</span>: <span class="predefined-constant">false</span>, <span class="key">email</span>: <span class="predefined-constant">true</span>, <span class="key">unique</span>: <span class="predefined-constant">true</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/domain/demo/Notification.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="type">class</span> <span class="class">Notification</span> {
    <span class="predefined-type">String</span> email
    <span class="predefined-type">String</span> subject

    <span class="directive">static</span> constraints = {
        subject <span class="key">nullable</span>: <span class="predefined-constant">false</span>
        email <span class="key">nullable</span>: <span class="predefined-constant">false</span>, <span class="key">email</span>: <span class="predefined-constant">true</span>
    }
}</code></pre>
</div>
</div>


<h2 id="dataServices">2.2 Data Services</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/dataServices.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Introduced in GORM 6.1, <a href="http://gorm.grails.org/latest/hibernate/manual/index.html#dataServices">Data Services</a> take the work out of implemented service layer logic by adding the ability to automatically implement abstract classes or interfaces using GORM logic.</p>
</div>
<div class="paragraph">
<p>Add two data services classes for the previous domain classes.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/demo/UserService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.gorm.services.Service</span>

<span class="annotation">@Service</span>(User)
<span class="type">interface</span> UserService {
    <span class="type">int</span> count()
    <span class="type">void</span> deleteByEmail(<span class="predefined-type">String</span> email)
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/services/demo/NotificationService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.gorm.services.Service</span>

<span class="annotation">@Service</span>(<span class="predefined-type">Notification</span>)
<span class="type">interface</span> NotificationService {
    <span class="type">int</span> count()
    <span class="type">void</span> deleteByEmail(<span class="predefined-type">String</span> email)
}</code></pre>
</div>
</div>


<h2 id="urlMapping">2.3 Url Mapping</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/urlMapping.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Modify <code>UrlMappings</code> to map the endpoints which handle User registration.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/demo/UrlMappings.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">        <span class="string"><span class="delimiter">&quot;</span><span class="content">/signup</span><span class="delimiter">&quot;</span></span>(<span class="key">controller</span>: <span class="string"><span class="delimiter">'</span><span class="content">register</span><span class="delimiter">'</span></span>, <span class="key">action</span>: <span class="string"><span class="delimiter">'</span><span class="content">index</span><span class="delimiter">'</span></span>)
        <span class="string"><span class="delimiter">&quot;</span><span class="content">/register</span><span class="delimiter">&quot;</span></span>(<span class="key">controller</span>: <span class="string"><span class="delimiter">'</span><span class="content">register</span><span class="delimiter">'</span></span>, <span class="key">action</span>: <span class="string"><span class="delimiter">'</span><span class="content">save</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>/signup</code> presents a registration form.</p>
</div>
<div class="paragraph">
<p><code>/register</code> handles a POST submission which saves a user.</p>
</div>


<h2 id="view">2.4 View</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/view.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a GSP file which contains the user registration form.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/views/register/index.gsp</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Sign Up&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">title&gt;</span></span><span class="error">
</span>    &lt;meta name=<span class="string"><span class="delimiter">&quot;</span><span class="content">layout</span><span class="delimiter">&quot;</span></span> content=<span class="string"><span class="delimiter">&quot;</span><span class="content">main</span><span class="delimiter">&quot;</span></span> /&gt;
    &lt;style type=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/css</span><span class="delimiter">&quot;</span></span>&gt;
        ol li {
            list-style-<span class="key">type</span>: none;
            <span class="key">margin</span>: <span class="integer">10</span>px auto;
        }
        ol li label {
            <span class="key">width</span>: <span class="integer">120</span>px;
        }
    &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">style&gt;</span></span><span class="error">
</span>&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">head&gt;</span></span><span class="error">
</span>&lt;body&gt;
&lt;div id=<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span> role=<span class="string"><span class="delimiter">&quot;</span><span class="content">main</span><span class="delimiter">&quot;</span></span>&gt;
    &lt;<span class="key">g</span>:hasErrors bean=<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span>signUpInstance<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>&gt;
    &lt;ul <span class="type">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">errors</span><span class="delimiter">&quot;</span></span>&gt;
        &lt;<span class="class">g</span>:eachError bean=<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span>signUpInstance<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>&gt;
            &lt;li&gt;&lt;<span class="key">g</span>:message error=<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span><span class="local-variable">it</span><span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>/&gt;&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">li&gt;</span></span><span class="error">
</span>        &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">g:eachError&gt;</span></span><span class="error">
</span>    &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">ul&gt;</span></span><span class="error">
</span>    &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">g:hasErrors&gt;</span></span><span class="error">
</span>    &lt;p <span class="type">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>&gt;<span class="error">$</span>{flash.message}&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">p&gt;</span></span><span class="error">
</span>
    &lt;h1&gt;&lt;<span class="key">g</span>:message code=<span class="string"><span class="delimiter">&quot;</span><span class="content">register.title</span><span class="delimiter">&quot;</span></span> <span class="keyword">default</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Register Form</span><span class="delimiter">&quot;</span></span>/&gt;&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">h1&gt;</span></span><span class="error">
</span>    &lt;<span class="key">g</span>:form controller=<span class="string"><span class="delimiter">&quot;</span><span class="content">register</span><span class="delimiter">&quot;</span></span> action=<span class="string"><span class="delimiter">&quot;</span><span class="content">save</span><span class="delimiter">&quot;</span></span> method=<span class="string"><span class="delimiter">&quot;</span><span class="content">POST</span><span class="delimiter">&quot;</span></span>&gt;
        &lt;ol&gt;
            &lt;li&gt;
                &lt;label <span class="keyword">for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>&gt;First <span class="predefined-type">Name</span>&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">label&gt;</span></span><span class="error">
</span>                &lt;<span class="key">g</span>:textField name=<span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span> id=<span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span> value=<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span>signUpInstance.firstName<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span> /&gt;
            &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">li&gt;</span></span><span class="error">
</span>            &lt;li&gt;
                &lt;label <span class="keyword">for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span>&gt;Last <span class="predefined-type">Name</span>&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">label&gt;</span></span><span class="error">
</span>                &lt;<span class="key">g</span>:textField name=<span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span> id=<span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span> value=<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span>signUpInstance.lastName<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span> /&gt;
            &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">li&gt;</span></span><span class="error">
</span>            &lt;li&gt;
                &lt;label <span class="keyword">for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span>&gt;Email&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">label&gt;</span></span><span class="error">
</span>                &lt;<span class="key">g</span>:textField name=<span class="string"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span> id=<span class="string"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span> value=<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span>signUpInstance.email<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span> /&gt;
            &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">li&gt;</span></span><span class="error">
</span>            &lt;li&gt;
                &lt;<span class="key">g</span>:submitButton name=<span class="string"><span class="delimiter">&quot;</span><span class="content">Submit</span><span class="delimiter">&quot;</span></span> id=<span class="string"><span class="delimiter">&quot;</span><span class="content">submit</span><span class="delimiter">&quot;</span></span>/&gt;
            &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">li&gt;</span></span><span class="error">
</span>
        &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">ol&gt;</span></span><span class="error">
</span>
    &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">g:form&gt;</span></span><span class="error">
</span>&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">div&gt;</span></span><span class="error">
</span>&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">body&gt;</span></span><span class="error">
</span>&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">html&gt;</span></span></code></pre>
</div>
</div>


<h2 id="services">2.5 Services</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/services.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Add a service which handles the registration of a user in the database.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/demo/RegisterService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.events.annotation.Publisher</span>
<span class="keyword">import</span> <span class="include">grails.gorm.transactions.Transactional</span>
<span class="keyword">import</span> <span class="include">grails.validation.ValidationException</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">org.springframework.context.MessageSource</span>
<span class="keyword">import</span> <span class="include">org.springframework.dao.DuplicateKeyException</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">RegisterService</span> {

    MessageSource messageSource

    <span class="annotation">@Transactional</span>
    <span class="annotation">@Publisher</span> <i class="conum" data-value="1"></i><b>(1)</b>
    User saveUser(User user) {
        user.save(<span class="key">failOnError</span>: <span class="predefined-constant">true</span>) <i class="conum" data-value="2"></i><b>(2)</b>
        user
    }

    SaveUserResult register(RegisterCommand cmd, <span class="predefined-type">Locale</span> locale) {
        User user = cmd <span class="keyword">as</span> User
        <span class="keyword">try</span> {
            saveUser(user)
            <span class="keyword">return</span> <span class="keyword">new</span> SaveUserResult(<span class="key">message</span>: userSavedMessage(cmd.email, locale))
        } <span class="keyword">catch</span> (ValidationException | DuplicateKeyException validationException) {
            <span class="keyword">return</span> <span class="keyword">new</span> SaveUserResult(<span class="key">error</span>: userSavedErrorMessage(cmd.email, locale))
        }
    }

    <span class="predefined-type">String</span> userSavedErrorMessage(<span class="predefined-type">String</span> email, <span class="predefined-type">Locale</span> locale) {
        messageSource.getMessage(<span class="string"><span class="delimiter">'</span><span class="content">user.saved.error</span><span class="delimiter">'</span></span>,
                [email] <span class="keyword">as</span> <span class="predefined-type">Object</span><span class="type">[]</span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Error while saving user with </span><span class="inline"><span class="inline-delimiter">${</span>email<span class="inline-delimiter">}</span></span><span class="content"> email address</span><span class="delimiter">&quot;</span></span>,
                locale)
    }

    <span class="predefined-type">String</span> userSavedMessage(<span class="predefined-type">String</span> email, <span class="predefined-type">Locale</span> locale) {
        messageSource.getMessage(<span class="string"><span class="delimiter">'</span><span class="content">user.saved</span><span class="delimiter">'</span></span>,
                [email] <span class="keyword">as</span> <span class="predefined-type">Object</span><span class="type">[]</span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">User saved with </span><span class="inline"><span class="inline-delimiter">${</span>email<span class="inline-delimiter">}</span></span><span class="content"> email address</span><span class="delimiter">&quot;</span></span>,
                locale)
    }
}

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">SaveUserResult</span> {
    <span class="predefined-type">String</span> message
    <span class="predefined-type">String</span> error
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the method with <code>@Publisher</code>. The event Id uses the method name <code>saveUser</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Raise an exception if the validation fails. This rollbacks the transaction. If the transaction is rollbacked, no event is triggered.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We consume the event in a different service. The consumer is completely decoupled from the sender.
In a real application you will probably send an email to the user who just registered asking him to verify his email address.
In this guide, we save a <code>Notification</code> in the database.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/demo/WelcomeEmailService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.events.annotation.Subscriber</span>
<span class="keyword">import</span> <span class="include">grails.gorm.transactions.Transactional</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">groovy.util.logging.Slf4j</span>

<span class="annotation">@Slf4j</span>
<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">WelcomeEmailService</span> {

    <span class="annotation">@Transactional</span>
    <span class="annotation">@Subscriber</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="type">void</span> saveUser(User user) {
        <span class="predefined-type">Notification</span> notification = <span class="keyword">new</span> <span class="predefined-type">Notification</span>(<span class="key">email</span>: user.email, <span class="key">subject</span>: <span class="string"><span class="delimiter">'</span><span class="content">Welcome to Grails App</span><span class="delimiter">'</span></span>)
        <span class="comment">// TODO Send Email</span>
        <span class="keyword">if</span> ( !notification.save() ) {
            log.error(<span class="string"><span class="delimiter">'</span><span class="content">unable to save notification {}</span><span class="delimiter">'</span></span>, notification.errors.toString())
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To consume an event use the <a href="https://async.grails.org/latest/api/grails/events/annotation/Subscriber.html">Subscriber</a> annotation. The method name <code>saveUser</code> is  used by default for the event id, although it can start with the word "on". In other words either a method name of <code>saveUser</code> or <code>onSaveUser</code> would work for the this guide example.</td>
</tr>
</table>
</div>


<h2 id="controllers">2.6 Controller</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/controllers.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a Command Object to handle the form data binding and validation.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/demo/RegisterCommand.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.validation.Validateable</span>

<span class="type">class</span> <span class="class">RegisterCommand</span> <span class="directive">implements</span> Validateable {
    <span class="predefined-type">String</span> firstName
    <span class="predefined-type">String</span> lastName
    <span class="predefined-type">String</span> email

    <span class="directive">static</span> constraints = {
        firstName <span class="key">nullable</span>: <span class="predefined-constant">false</span>
        lastName <span class="key">nullable</span>: <span class="predefined-constant">false</span>
        email <span class="key">nullable</span>: <span class="predefined-constant">false</span>, <span class="key">email</span>: <span class="predefined-constant">true</span>
    }

    <span class="predefined-type">Object</span> asType(<span class="predefined-type">Class</span> clazz) {
        <span class="keyword">if</span> (clazz == User) {
            <span class="keyword">def</span> user = <span class="keyword">new</span> User()
            copyProperties(<span class="local-variable">this</span>, user)
            <span class="keyword">return</span> user
        }
        <span class="keyword">else</span> {
            <span class="local-variable">super</span>.asType(clazz)
        }
    }

    <span class="keyword">def</span> <span class="function">copyProperties</span>(source, target) {
        source.properties.each { key, value -&gt;
            <span class="keyword">if</span> (target.hasProperty(key) &amp;&amp; !(key <span class="keyword">in</span> [<span class="string"><span class="delimiter">'</span><span class="content">class</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">metaClass</span><span class="delimiter">'</span></span>])) {
                target[key] = value
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a controller with two actions, one action presents the registration form the other action handles the form submission.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/demo/RegisterController.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">RegisterController</span> {

    <span class="directive">static</span> allowedMethods = [<span class="key">index</span>: <span class="string"><span class="delimiter">'</span><span class="content">GET</span><span class="delimiter">'</span></span>, <span class="key">save</span>: <span class="string"><span class="delimiter">'</span><span class="content">POST</span><span class="delimiter">'</span></span>]

    RegisterService registerService

    <span class="keyword">def</span> <span class="function">index</span>() {
        [<span class="key">signUpInstance</span>:  <span class="keyword">new</span> RegisterCommand()]
    }

    <span class="keyword">def</span> <span class="function">save</span>(RegisterCommand cmd) {

        <span class="keyword">if</span> ( cmd.hasErrors() ) {
            render <span class="key">view</span>: <span class="string"><span class="delimiter">'</span><span class="content">index</span><span class="delimiter">'</span></span>, <span class="key">model</span>: [<span class="key">signUpInstance</span>: cmd]
            <span class="keyword">return</span>
        }

        SaveUserResult result = registerService.register(cmd, request.locale)
        flash.message = result.message
        <span class="keyword">if</span> ( result.error ) {
            flash.error = result.error
            render <span class="key">view</span>: <span class="string"><span class="delimiter">'</span><span class="content">index</span><span class="delimiter">'</span></span>, <span class="key">model</span>: [<span class="key">signUpInstance</span>: cmd]
            <span class="keyword">return</span>
        }
        redirect <span class="key">action</span>: <span class="string"><span class="delimiter">'</span><span class="content">index</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>


<h2 id="testing">2.7 Testing</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/testing.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a functional test which verifies that a <code>Notification</code> instance is created, due to the event triggering, when a <code>User</code> is created.</p>
</div>
<div class="listingblock">
<div class="title">src/integration-test/groovy/demo/SignUpPage.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">geb.Page</span>
<span class="keyword">import</span> <span class="include">geb.module.TextInput</span>

<span class="type">class</span> <span class="class">SignUpPage</span> <span class="directive">extends</span> Page {

    <span class="directive">static</span> url = <span class="string"><span class="delimiter">'</span><span class="content">/signup</span><span class="delimiter">'</span></span>

    <span class="directive">static</span> content = {
        firstNameInput { <span class="error">$</span>(<span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>).module(TextInput) }
        lastNameInput { <span class="error">$</span>(<span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span>).module(TextInput) }
        emailInput { <span class="error">$</span>(<span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span>).module(TextInput) }
        submitButton {  <span class="error">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#submit</span><span class="delimiter">'</span></span>) }
    }

    <span class="type">void</span> submit(<span class="predefined-type">String</span> firstName, <span class="predefined-type">String</span> lastName, <span class="predefined-type">String</span> email) {
        firstNameInput.text = firstName
        lastNameInput.text = lastName
        emailInput.text = email
        submitButton.click()
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/integration-test/groovy/demo/RegisterControllerSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">geb.spock.GebSpec</span>
<span class="keyword">import</span> <span class="include">grails.gorm.transactions.Rollback</span>
<span class="keyword">import</span> <span class="include">grails.testing.mixin.integration.Integration</span>

<span class="annotation">@Integration</span>
<span class="type">class</span> <span class="class">RegisterControllerSpec</span> <span class="directive">extends</span> GebSpec {

    NotificationService notificationService

    UserService userService

    <span class="annotation">@Rollback</span>
    <span class="keyword">def</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">If you signup a User, an Event triggers which causes a Notification to be saved</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">you signup with a non existing user</span><span class="delimiter">'</span></span>
        SignUpPage page = to SignUpPage
        page.submit(<span class="string"><span class="delimiter">'</span><span class="content">Sergio</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">del Amo</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">delamos@email.com</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">the user gets created and a notification is saved due to the event being triggered</span><span class="delimiter">'</span></span>
        userService.count() == old(userService.count()) + <span class="integer">1</span>
        notificationService.count() == old(notificationService.count()) + <span class="integer">1</span>

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">you try to signup with a user which is already in the database</span><span class="delimiter">'</span></span>
        page = to SignUpPage
        page.submit(<span class="string"><span class="delimiter">'</span><span class="content">Sergio</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">del Amo</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">delamos@email.com</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">The user is not saved and no event gets triggered</span><span class="delimiter">'</span></span>
        noExceptionThrown()
        userService.count() == old(userService.count())
        notificationService.count() == old(notificationService.count())

        <span class="key">cleanup</span>:
        userService.deleteByEmail(<span class="string"><span class="delimiter">'</span><span class="content">delamos@email.com</span><span class="delimiter">'</span></span>)
        notificationService.deleteByEmail(<span class="string"><span class="delimiter">'</span><span class="content">delamos@email.com</span><span class="delimiter">'</span></span>)
    }
}</code></pre>
</div>
</div>


<h1 id="runningTheApp">3 Running the Tests</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/runningTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To run the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./grailsw
grails&gt; test-app
grails&gt; open test-report</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./gradlew check
open build/reports/tests/index.html</code></pre>
</div>
</div>


<h1 id="helpWithGrails">4 Help with Grails</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/helpWithGrails.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<h3 style="color: #333; margin-bottom:25px;"><a href="https://objectcomputing.com/" target="_blank">Object Computing, Inc.</a> (OCI) sponsored the creation of this Guide. A variety of consulting and support services are available.</h3>

<!-- BEGIN HubSpot Consultation Form -->

<!--[if lte IE 8]>
<script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2-legacy.js"></script>
<![endif]-->
<script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2.js"></script>
<script>
  hbspt.forms.create({
	portalId: "4547412",
	formId: "f8bc9b16-d5f6-4226-a24e-da0eb8b73363"
});
</script>

<!-- END HubSpot Consultation Form -->

<h3 style="color: #333;">OCI is Home to Grails</h3>

<p><a href="https://objectcomputing.com/products/2gm-team" target="_blank">Meet the Team</a></p>

</article></div><footer>
  <div class='content'>
    <div class='ocihometograils'>
      <span>Sponsored by</span>
      <a href='https://objectcomputing.com/products/grails/'><img class='' src='/images/oci_home_to_grails.svg' alt='Object Computing - Home to Grails' width='300px' /></a>
    </div>
    <nav class='socialmedianav'><ul>
  <li>
    <a href='https://slack.grails.org'><img class='' src='/images/slack.svg' alt='Slack Icon' /></a>
  </li>
  <li>
    <a href='https://www.youtube.com/watch?v=XnRNfDGkBVg&amp;list=PLI74De5M9T73uH3WilDCePP2qfSDpMaGu'><img class='' src='/images/youtube.svg' alt='Youtube Icon' /></a>
  </li>
  <li>
    <a href='https://www.linkedin.com/groups/39757'><img class='' src='/images/linkedin.svg' alt='LinkedIn Icon' /></a>
  </li>
  <li>
    <a href='https://github.com/grails/'><img class='' src='/images/github.svg' alt='Github Icon' /></a>
  </li>
  <li>
    <a href='https://twitter.com/grailsframework'><img class='' src='/images/twitter.svg' alt='Twitter Icon' /></a>
  </li>
</ul></nav>
    <nav class='partnersnav'><ul>
  <li>Grails' repositories are hosted by
    <a href='https://repo.grails.org/'>Artifactory</a>
  </li>
  <li>Website hosting provided by
    <a href='https://aws.amazon.com/'>AWS</a>
  </li>
  <li>JetBrains supports Grails with its 
    <a href='https://www.jetbrains.com/idea/'>IntelliJ IDEA IDE</a>
  </li>
  <li>YourKit supports Grails with its 
    <a href='https://www.yourkit.com/java/profiler/index.jsp'>Java Profiler</a>
  </li>
  <li>Grails is Open Source
    <a href='http://www.apache.org/licenses/LICENSE-2.0.html'>Apache 2 License</a>
  </li>
  <li>
    <a href='https://grails.org/buildstatus.html'>Build Status</a>
  </li>
</ul></nav>
  </div>
</footer><div>
  <script type='text/javascript'>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-82213539-2', 'auto');
              ga('send', 'pageview');
</script>
  <script type='text/javascript'>
adroll_adv_id = "HBWJH4CQCJGS5DJRSB4Z4D";
adroll_pix_id = "IVEQYFOZXZAPZMDVQH7BFE";
/* OPTIONAL: provide email to improve user identification */
/* adroll_email = "username@example.com"; */
(function () {
    var _onload = function(){
        if (document.readyState && !/loaded|complete/.test(document.readyState)){setTimeout(_onload, 10);return}
        if (!window.__adroll_loaded){__adroll_loaded=true;setTimeout(_onload, 50);return}
        var scr = document.createElement("script");
        var host = (("https:" == document.location.protocol) ? "https://s.adroll.com" : "http://a.adroll.com");
        scr.setAttribute('async', 'true');
        scr.type = "text/javascript";
        scr.src = host + "/j/roundtrip.js";
        ((document.getElementsByTagName('head') || [null])[0] ||
            document.getElementsByTagName('script')[0].parentNode).appendChild(scr);
    };
    if (window.addEventListener) {window.addEventListener('load', _onload, false);}
    else {window.attachEvent('onload', _onload)}
}());            
</script>
</div></body>
</html>
