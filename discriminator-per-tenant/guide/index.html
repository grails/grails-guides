<!DOCTYPE html>
<html>
  <head>
    <meta name='google-site-verification' content='REYQ1_I6HGowAE7LOLVqfQbnKaB4IfFpMlGzMbJj55Q' />
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <link rel='icon' href='/images/favicon.ico' />
    <link rel='mask-icon' href='//images/grails-pinned-icon.svg' color='feb672' />
    <meta charset='UTF-8' />
    <title>Single Database Multi-Tenancy - Discriminator Column | Grails Guides | Grails Framework</title>
    <meta name='description' content='Single Database Multi-Tenancy - Discriminator Column. Learn how to leverage Multi-Tenancy features of GORM to build an application which uses a single database, but it partitions its data using a discriminator column.' />
    <link rel='stylesheet' href='../css/main.css' />
    <link rel='stylesheet' href='../css/screen.css' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js'></script>
  </head>
  <body class='guide'><header class='mainheader'>
  <div class='content'>
    <a href='https://grails.org/index.html'><img class='grailslogo' src='/images/grails_logo.svg' alt='Grails Logo' /></a>
    <a href='javascript:show(&apos;topmenus&apos;, &apos;showNavigationLink&apos;)' id='showNavigationLink' class='mobile align-center'>Show Navigation</a>
    <div id='topmenus'>
      <nav class='secondarymenu' id='secondarymenu'><ul>
  <li>
    <a href='https://grails.org/learning.html'>Learning</a>
  </li>
  <li>
    <a href='https://grails.org/community.html'>Community</a>
  </li>
  <li>
    <a href='https://grails.org/search.html'>Search</a>
  </li>
</ul></nav>
      <nav class='mainmenu' id='mainmenu'><ul>
  <li>
    <a href='https://grails.org/documentation.html'>Documentation</a>
  </li>
  <li>
    <a href='https://grails.org/download.html'>Download</a>
  </li>
  <li>
    <a href='https://plugins.grails.org'>Plugins</a>
  </li>
  <li>
    <a href='https://guides.grails.org/index.html'>Guides</a>
  </li>
  <li>
    <a href='https://grails.org/faq.html'>FAQ</a>
  </li>
  <li>
    <a href='https://grails.org/support.html'>Support</a>
  </li>
</ul></nav>
    </div>
  </div>
</header><div class='fullwidth'><article class="guide">
    <aside>
        <a href="https://travis-ci.org/grails-guides/discriminator-per-tenant"><img src="https://travis-ci.org/grails-guides/discriminator-per-tenant.svg?branch=master"></a>

        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/grails-guides/discriminator-per-tenant&quot;"><img height="15" src="../img/github_white.svg" alt="Github"/><span>&nbsp;Get the Code</span></button>


        <ul class="githublinks">
            <li><button type="button" class="btn btn-default" href="#" onclick="document.getElementById('github-url').value='git@github.com:grails-guides/discriminator-per-tenant.git'" class="codeButton">SSH</button></li>
            <li><button type="button" class="btn btn-default" onclick="document.getElementById('github-url').value='https://github.com/grails-guides/discriminator-per-tenant.git'" class="codeButton">HTTPS</button></li>
        </ul>
        <div class="input-group">
            <!-- Target -->
            <input id="github-url" value="git@github.com:grails-guides/discriminator-per-tenant.git" type="text" />
            <!-- Trigger -->
            <button type="button" class="clippy btn btn-default" type="button" data-clipboard-target="#github-url">
                <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
            </button>
        </div>
        <script>var clipboard = new Clipboard('.clippy');</script>
        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/grails-guides/discriminator-per-tenant/archive/master.zip&quot;">Download ZIP</button>
        
        <div id="table-of-content">
            <h3>Table of Contents</h3>
            
            <div class="toc-item" style="margin-left:0px"><a href="#training"><strong>1</strong><span>Grails Training</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#gettingStarted"><strong>2</strong><span>Getting Started</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#requirements"><strong>2.1</strong><span>What you will need</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#howto"><strong>2.2</strong><span>How to complete the guide</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#writingTheApp"><strong>3</strong><span>Writing the Application</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#setupMultitenancy"><strong>3.1</strong><span>Setup Multi-Tenancy</span></a></div>
            
            <div class="toc-item" style="margin-left:20px"><a href="#multiTenancyMode"><strong>3.1.1</strong><span>The Multi-Tenancy Mode</span></a></div>
            
            <div class="toc-item" style="margin-left:20px"><a href="#multiTenancyResolver"><strong>3.1.2</strong><span>The TenantResolver</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#domainClasses"><strong>3.2</strong><span>Creating the Domain Classes</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#seedData"><strong>3.3</strong><span>Setup Test Data</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#tenantSelection"><strong>3.4</strong><span>Implementing Tenant Selection</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#multiTenantLogic"><strong>3.5</strong><span>Writing Multi-Tenant Aware Data Logic</span></a></div>
            
            <div class="toc-item" style="margin-left:20px"><a href="#readingData"><strong>3.5.1</strong><span>Executing Multi-Tenant Aware Queries</span></a></div>
            
            <div class="toc-item" style="margin-left:20px"><a href="#writingData"><strong>3.5.2</strong><span>Executing Multi-Tenant Updates</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#testingTheApp"><strong>4</strong><span>Multi-Tenancy Unit Testing</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#integrationTest"><strong>5</strong><span>Functional Tests</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#runningTheApp"><strong>6</strong><span>Running the Application</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#helpWithGrails"><strong>7</strong><span>Do you need help with Grails?</span></a></div>
            
            <div style="clear:both" ></div>
        </div>
        
    </aside>
    <header>
        <h1>Single Database Multi-Tenancy - Discriminator Column</h1>
        <p>Learn how to leverage Multi-Tenancy features of GORM to build an application which uses a single database, but it partitions its data using a discriminator column.</p>
        <p><strong>Authors:</strong> Sergio del Amo</p>
        <p><strong>Grails Version:</strong> 4.0.1</p>
    </header>
    

<h1 id="training">1 Grails Training</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/discriminator-per-tenant/edit/master/src/main/docs/guide/training.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p><strong>Grails Training</strong> - Developed and delivered by the folks who created and actively maintain the Grails framework!.</p>
</div>
<div id="ocitraining"></div>
<script type="text/javascript">
var getJSON = function(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.responseType = 'json';
    xhr.onload = function() {
      var status = xhr.status;
      if (status == 200) {
        callback(null, xhr.response);
      } else {
        callback(status);
      }
    };
    xhr.send();
};
getJSON('https://training.grails.org/training', function(err, data) {
  var msg = '';
  if (err != null) {
      msg = 'Something went wrong while retrieving OCI training offerings';

  } else {
      if ( data.length == 0 ) {
         msg = '<p><b>Nothing scheduled at the moment - please check back again soon!</b></p>.';

      } else {
        msg += '<table>';
        msg += '<thead>';
        msg += '<tr><th>Course</th><th>Date(s)</th><th>Instructor(s)</th><th>Hour(s)</th></tr>';
        msg += '</thead>';
        msg += '<tbody>';

        var hrefs = new Array();
        for (var i = 0; i < data.length; i++) {
            var href = data[i].enrollmentLink;
            if (hrefs.indexOf(href) == -1) {
                msg += '<tr><td><a href="'+ href + '">'+ data[i].course + '</a></td><td>'+ data[i].dates + '</td><td>'+ data[i].instructors + '</td><td>'+ data[i].hours + '</td></tr>';
                hrefs.push(href);
            }

        }
        msg += '</tbody>';
        msg += '</table>';
      }
  }
  var ociTraining = document.getElementById("ocitraining");
  ociTraining.innerHTML = msg;
});
</script>


<h1 id="gettingStarted">2 Getting Started</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/discriminator-per-tenant/edit/master/src/main/docs/guide/gettingStarted.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>In this guide you are going to build a Multi-Tenant application which partitions
its data using a discriminator column with Grails and GORM.</p>
</div>
<div class="paragraph">
<p>Using a discriminator column allows you handle different tenants (users)
with a unique tenant identifier within the same database.</p>
</div>


<h2 id="requirements">2.1 What you will need</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/discriminator-per-tenant/edit/master/src/main/docs/guide/requirements.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 1.8 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
</ul>
</div>


<h2 id="howto">2.2 How to complete the guide</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/discriminator-per-tenant/edit/master/src/main/docs/guide/howto.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To get started do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/grails-guides/discriminator-per-tenant/archive/master.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone the <a href="https://git-scm.com/">Git</a> repository:<br>
<code>git clone <a href="https://github.com/grails-guides/discriminator-per-tenant.git" class="bare">https://github.com/grails-guides/discriminator-per-tenant.git</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Grails guides repositories contain two folders:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>initial</code>  Initial project. Often a simple Grails app with some additional code to give you a head-start.</p>
</li>
<li>
<p><code>complete</code> A completed example. It is the result of working through the steps presented by the guide and applying those changes to the <code>initial</code> folder.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To complete the guide, go to the <code>initial</code> folder</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cd</code> into <code>grails-guides/discriminator-per-tenant/initial</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>and follow the instructions in the next sections.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can go right to the <strong>completed example</strong> if you <code>cd</code> into <code>grails-guides/discriminator-per-tenant/complete</code>
</td>
</tr>
</table>
</div>


<h1 id="writingTheApp">3 Writing the Application</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/discriminator-per-tenant/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>





<h2 id="setupMultitenancy">3.1 Setup Multi-Tenancy</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/discriminator-per-tenant/edit/master/src/main/docs/guide/setupMultitenancy.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>





<h2 id="multiTenancyMode">3.1.1 The Multi-Tenancy Mode</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/discriminator-per-tenant/edit/master/src/main/docs/guide/writingTheApp/setupMultitenancy/multiTenancyMode.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>In order to use Multi-Tenancy you need to setup the Multi-Tenancy mode that GORM uses, given that three distinct modes are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://gorm.grails.org/latest/api//org/grails/datastore/mapping/multitenancy/MultiTenancySettings.MultiTenancyMode.html#DATABASE">DATABASE</a> - Use a distinct database connection per tenant</p>
</li>
<li>
<p><a href="http://gorm.grails.org/latest/api//org/grails/datastore/mapping/multitenancy/MultiTenancySettings.MultiTenancyMode.html#SCHEMA">SCHEMA</a> - Use a single database, but different physical schemas per tenant</p>
</li>
<li>
<p><a href="http://gorm.grails.org/latest/api//org/grails/datastore/mapping/multitenancy/MultiTenancySettings.MultiTenancyMode.html#DISCRIMINATOR">DISCRIMINATOR</a> - Use a single database, but partition the data using a discriminator column</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Generally <code>DATABASE</code> and <code>SCHEMA</code> modes can both be considered to be physically separated, whilst <code>DISCRIMINATOR</code> mode requires more care since different tenants' data is stored in the same physical database:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/multi-tenancy-modes.png" alt="multi tenancy modes">
</div>
</div>
<div class="paragraph">
<p>In this case the required Multi-Tenancy mode is <code>DISCRIMINATOR</code> and it can be configured using the <code>grails.gorm.multiTenancy.mode</code> setting:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">grails</span>:
    <span class="key">gorm</span>:
        <span class="key">multiTenancy</span>:
            <span class="key">mode</span>: DISCRIMINATOR
            <span class="key">tenantResolverClass</span>: org.grails.datastore.mapping.multitenancy.web.SessionTenantResolver</code></pre>
</div>
</div>


<h2 id="multiTenancyResolver">3.1.2 The TenantResolver</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/discriminator-per-tenant/edit/master/src/main/docs/guide/writingTheApp/setupMultitenancy/multiTenancyResolver.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Note that, in addition to the mode, the above example configures the <code>tenantResolverClass</code> to use to resolve the tenant.</p>
</div>
<div class="paragraph">
<p>The <code>tenantResolverClass</code> is a class that implements the <a href="http://gorm.grails.org/latest/api//org/grails/datastore/mapping/multitenancy/TenantResolver.html">TenantResolver</a> interface.</p>
</div>
<div class="paragraph">
<p>Included within GORM there are several built-in <code>TenantResolver</code> implementations including:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Available TenantResolver Implementations</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://gorm.grails.org/latest/api//org/grails/datastore/mapping/multitenancy/web/SessionTenantResolver.html">SessionTenantResolver</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolves the tenant id from the HTTP session using an attribute called <code>gorm.tenantId</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://gorm.grails.org/latest/api//org/grails/datastore/mapping/multitenancy/web/CookieTenantResolver.html">CookieTenantResolver</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolves the tenant id from the HTTP cookie using an attribute called <code>gorm.tenantId</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://gorm.grails.org/latest/api//org/grails/datastore/mapping/multitenancy/web/SubDomainTenantResolver.html">SubDomainTenantResolver</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolves the tenant id from the current sub-domain. For example if the subdomain is <code>foo.mycompany.com</code>, the tenant id would be <code>foo</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://gorm.grails.org/latest/api//org/grails/datastore/mapping/multitenancy/resolvers/SystemPropertyTenantResolver.html">SystemPropertyTenantResolver</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolves the tenant id from a system property called <code>gorm.tenantId</code>. Mainly useful for testing</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The above implementations are useful to have out-of-the-box, however GORM is flexible and you can implement your own strategy by implementing the <code>TenantResolver</code> interface.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
For example if you are using Spring Security you could write a <code>TenantResolver</code> that resolves the tenant id from the currently logged in user.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For this example we are going to be using <code>SessionTenantResolver</code> and storing the tenant id within the current user session.</p>
</div>


<h2 id="domainClasses">3.2 Creating the Domain Classes</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/discriminator-per-tenant/edit/master/src/main/docs/guide/writingTheApp/domainClasses.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>When creating domain classes for your application you will typically have domain classes that
are Multi-Tenant and others that are not.</p>
</div>
<div class="paragraph">
<p>For domain classes which won&#8217;t be using Multi-Tenancy simply define them as you
would normally do.</p>
</div>
<div class="paragraph">
<p>For this example, the <code>Manufacturer</code> will be the provider of tenant ids. The name
of the <code>Manufacturer</code> will be used as the tenant identifier.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/domain/example/Manufacturer.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example

<span class="keyword">import</span> <span class="include">grails.compiler.GrailsCompileStatic</span>

<span class="annotation">@GrailsCompileStatic</span>
<span class="type">class</span> <span class="class">Manufacturer</span> {
    <span class="predefined-type">String</span> name

    <span class="directive">static</span> constraints = {
        name <span class="key">blank</span>: <span class="predefined-constant">false</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next step is to define domain classes that can only be accessed by a given tenant:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/domain/example/Engine.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example

<span class="keyword">import</span> <span class="include">grails.gorm.MultiTenant</span>

<span class="type">class</span> <span class="class">Engine</span> <span class="directive">implements</span> MultiTenant&lt;Engine&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="predefined-type">Integer</span> cylinders
    <span class="predefined-type">String</span> manufacturer  <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="directive">static</span> constraints = {
        cylinders <span class="key">nullable</span>: <span class="predefined-constant">false</span>
    }

    <span class="directive">static</span> mapping = {
        tenantId <span class="key">name</span>:<span class="string"><span class="delimiter">'</span><span class="content">manufacturer</span><span class="delimiter">'</span></span>  <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/domain/example/Vehicle.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example

<span class="keyword">import</span> <span class="include">grails.gorm.MultiTenant</span>

<span class="type">class</span> <span class="class">Vehicle</span> <span class="directive">implements</span> MultiTenant&lt;Vehicle&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="predefined-type">String</span> model
    <span class="predefined-type">Integer</span> year
    <span class="predefined-type">String</span> manufacturer <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="directive">static</span> hasMany = [<span class="key">engines</span>: Engine]
    <span class="directive">static</span> constraints = {
        model <span class="key">blank</span>:<span class="predefined-constant">false</span>
        year <span class="key">min</span>:<span class="integer">1980</span>
    }

    <span class="directive">static</span> mapping = {
        tenantId <span class="key">name</span>:<span class="string"><span class="delimiter">'</span><span class="content">manufacturer</span><span class="delimiter">'</span></span>  <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Both domain classes implement the <a href="http://gorm.grails.org/latest/api//grails/gorm/MultiTenant.html">MultiTenant trait</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><em>manufacturer</em> property is used as the tenant id discriminator column.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>Vehicle</code> and <code>Engine</code> domain classes both implement the
<a href="http://gorm.grails.org/latest/api//grails/gorm/MultiTenant.html">MultiTenant</a> trait. GORM resolves the
entities to use from the resulting tenant id
returned from the configured
<a href="http://gorm.grails.org/latest/api//org/grails/datastore/mapping/multitenancy/TenantResolver.html">TenantResolver</a> by
using the tenant identifier discriminator column.</p>
</div>


<h2 id="seedData">3.3 Setup Test Data</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/discriminator-per-tenant/edit/master/src/main/docs/guide/writingTheApp/seedData.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To setup some test data you can modify the <code>Application</code> class to implement the <code>ApplicationRunner</code> interface to run transactional logic on startup:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/example/Application.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example

<span class="keyword">import</span> <span class="include">grails.boot.GrailsApp</span>
<span class="keyword">import</span> <span class="include">grails.boot.config.GrailsAutoConfiguration</span>
<span class="keyword">import</span> <span class="include">org.springframework.boot.ApplicationArguments</span>
<span class="keyword">import</span> <span class="include">org.springframework.boot.ApplicationRunner</span>
<span class="keyword">import</span> <span class="include">grails.gorm.transactions.Transactional</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">Application</span> <span class="directive">extends</span> GrailsAutoConfiguration <span class="directive">implements</span> ApplicationRunner { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        GrailsApp.run(Application, args)
    }

    <span class="annotation">@Override</span>
    <span class="annotation">@Transactional</span>
    <span class="type">void</span> run(ApplicationArguments args) <span class="directive">throws</span> <span class="exception">Exception</span> { <i class="conum" data-value="2"></i><b>(2)</b>
        Manufacturer.saveAll( <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="keyword">new</span> Manufacturer(<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">Audi</span><span class="delimiter">'</span></span>),
            <span class="keyword">new</span> Manufacturer(<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">Ford</span><span class="delimiter">'</span></span>)
        )
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Implement the <code>ApplicationRunner</code> interface</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Mark the <code>run</code> method as transactional with <code>@Transactional</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use <code>saveAll</code> to save two <code>Manufacturer</code> instances</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the example about two <code>Manufacturer</code> instances are saved that will correspond
to the two tenants supported by this application.</p>
</div>


<h2 id="tenantSelection">3.4 Implementing Tenant Selection</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/discriminator-per-tenant/edit/master/src/main/docs/guide/writingTheApp/tenantSelection.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The first step to supporting Multi-Tenancy in your application is implementing some form of tenant selection. This could be to resolve the tenant via a DNS subdomain, or it could be part of your applications registration process if you are using authentication with Spring Security.</p>
</div>
<div class="paragraph">
<p>To keep things simple for the example we are going to implement a simple mechanism that provides a UI to store the <code>tenantId</code> within the users HTTP session.</p>
</div>
<div class="paragraph">
<p>First, create a GORM Data service to <code>Manufacturer</code>:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/example/ManufacturerService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">Unresolved directive <span class="keyword">in</span> &lt;stdin&gt; - <span class="key">include</span>::<span class="regexp"><span class="delimiter">/</span><span class="content">home</span><span class="delimiter">/</span></span>runner/work/discriminator-per-tenant/discriminator-per-tenant/complete/grails-app/init/example/ManufacturerService.groovy<span class="type">[]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, create a new <code>ManufacturerController</code> use <code>create-controller</code> or your preferred IDE:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ grails create-controller Manufacturer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next modify the <code>UrlMappings.groovy</code> file to map the root of the application to the <code>index</code> action:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/example/UrlMappings.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>(<span class="key">controller</span>: <span class="string"><span class="delimiter">'</span><span class="content">manufacturer</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then define an <code>index</code> action that lists of all the Manufacturers and renders the <code>grails-app/views/index.gsp</code> view.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/example/ManufacturerController.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example

<span class="keyword">import</span> <span class="include">org.grails.datastore.mapping.multitenancy.web.SessionTenantResolver</span>
<span class="keyword">import</span> <span class="include">grails.gorm.transactions.ReadOnly</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">ManufacturerController</span> {
    <span class="annotation">@ReadOnly</span>
    <span class="keyword">def</span> <span class="function">index</span>() {
        render <span class="key">view</span>: <span class="string"><span class="delimiter">'</span><span class="content">/index</span><span class="delimiter">'</span></span>, <span class="key">model</span>: [<span class="key">manufacturers</span>: manufacturerService.findAll()]
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Within the <code>grails-app/views/index.gsp</code> file, simply iterate through each result and create a link to the <code>select</code> action</p>
</div>
<div class="listingblock">
<div class="title">grails-app/views/index.gsp</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;div</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">controllers</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">role</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">navigation</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;h2&gt;</span>Available Manufacturers:<span class="tag">&lt;/h2&gt;</span>
    <span class="tag">&lt;ul&gt;</span>
        <span class="tag">&lt;g:each</span> <span class="attribute-name">var</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">m</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">in</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${manufacturers}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;li</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">controller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;g:link</span> <span class="attribute-name">controller</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">manufacturer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">action</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">select</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${m.name}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${m.name}<span class="tag">&lt;/g:link&gt;</span>
            <span class="tag">&lt;/li&gt;</span>
        <span class="tag">&lt;/g:each&gt;</span>
    <span class="tag">&lt;/ul&gt;</span>
<span class="tag">&lt;/div&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>select</code> action, selects the current tenant and stores the tenant within the current user&#8217;s HTTP session:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/example/ManufacturerController.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@ReadOnly</span>
<span class="keyword">def</span> <span class="function">select</span>(<span class="predefined-type">String</span> id) {
    Manufacturer m = manufacturerService.findByName(id) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="keyword">if</span> ( m ) {
        session.setAttribute(SessionTenantResolver.ATTRIBUTE, m.name.toLowerCase()) <i class="conum" data-value="2"></i><b>(2)</b>
        redirect <span class="key">controller</span>: <span class="string"><span class="delimiter">'</span><span class="content">vehicle</span><span class="delimiter">'</span></span> <i class="conum" data-value="3"></i><b>(3)</b>
    }
    <span class="keyword">else</span> {
        render <span class="key">status</span>: <span class="integer">404</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Fetches a Manufacturer identified by the supplied <code>id</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The selected tenant is stored within a session attribute.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>select</code> action will find a <code>Manufacturer</code> and store the name of the <code>Manufacturer</code>
in lower case as the current tenant within the HTTP session.</p>
</div>
<div class="paragraph">
<p>This causes <a href="http://gorm.grails.org/latest/api//org/grails/datastore/mapping/multitenancy/web/SessionTenantResolver.html">SessionTenantResolver</a> to resolve the correct tenant id from the HTTP session.</p>
</div>
<div class="paragraph">
<p>Finally, to improve error handling you can map every occurrence of <code>TenantNotFoundException</code> to redirect back to the list of manufacturers:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/example/UrlMappings.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="string"><span class="delimiter">'</span><span class="content">500</span><span class="delimiter">'</span></span> (<span class="key">controller</span>: <span class="string"><span class="delimiter">'</span><span class="content">manufacturer</span><span class="delimiter">'</span></span>, <span class="key">exception</span>: TenantNotFoundException)</code></pre>
</div>
</div>
<div class="paragraph">
<p>With these changes in place you will able to select each tenant from the homepage:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/available-tenants.png" alt="available tenants">
</div>
</div>
<div class="paragraph">
<p>Now that it is possible to select a tenant, lets create a logic that is able to use the currently active tenant.</p>
</div>


<h2 id="multiTenantLogic">3.5 Writing Multi-Tenant Aware Data Logic</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/discriminator-per-tenant/edit/master/src/main/docs/guide/writingTheApp/multiTenantLogic.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>GORM features a set of
<a href="http://gorm.grails.org/latest/api//grails/gorm/multitenancy/package-summary.html">Multi-Tenancy transformations</a>
which facilitate the resolution of the tenant and the binding of a Hibernate Session
for that particular tenant in the scope of a method.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Multi Tenancy Transformations</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://gorm.grails.org/latest/api//grails/gorm/multitenancy/CurrentTenant.html">CurrentTenant</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolves the current tenant and binds a Hibernate session for the scope of the method</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://gorm.grails.org/latest/api//grails/gorm/multitenancy/Tenant.html">Tenant</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolves a specific tenant and binds a Hibernate session for the scope of the method</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://gorm.grails.org/latest/api//grails/gorm/multitenancy/WithoutTenant.html">WithoutTenant</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execute some logic within a method without a tenant present</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>These should generally be applied to services in a Grails application and they
work really well when combined with the <a href="http://gorm.grails.org/latest/hibernate/manual/index.html#dataServices">GORM Data Services</a>
concept introduced in GORM 6.1.</p>
</div>
<div class="paragraph">
<p>To implement the logic to save and retrieve <code>Vehicle</code> instances create a new <br>
<code>grails-app/services/example/VehicleService.groovy</code>
file and annotate it within the <a href="http://gorm.grails.org/latest/api//grails/gorm/multitenancy/CurrentTenant.html">CurrentTenant</a>
and <a href="http://gorm.grails.org/latest/api//grails/gorm/services/Service.html">Service</a> annotations:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/example/VehicleService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.gorm.multitenancy.CurrentTenant</span>
<span class="keyword">import</span> <span class="include">grails.gorm.services.Service</span>
<span class="keyword">import</span> <span class="include">grails.gorm.transactions.Transactional</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@Service</span>(Vehicle) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@CurrentTenant</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="annotation">@CompileStatic</span>
<span class="directive">abstract</span> <span class="type">class</span> <span class="class">VehicleService</span> {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <a href="http://gorm.grails.org/latest/api//grails/gorm/services/Service.html">Service</a> transformation will ensure any abstract methods that can be implemented by GORM are implemented</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <a href="http://gorm.grails.org/latest/api//grails/gorm/multitenancy/CurrentTenant.html">CurrentTenant</a> transformation will ensure any method that is executed on the service resolves the current tenant first and binds a Hibernate session.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The class is <code>abstract</code> because many of the methods will be implemented for you by GORM.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now lets take a look at how to implement querying logic for a Multi-Tenant application.</p>
</div>


<h2 id="readingData">3.5.1 Executing Multi-Tenant Aware Queries</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/discriminator-per-tenant/edit/master/src/main/docs/guide/writingTheApp/multiTenantLogic/readingData.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To implement Multi-Tenant queries in a GORM Data Service simply add abstract methods that correspond to <a href="http://gorm.grails.org/latest/hibernate/manual/index.html#_data_service_queries">one of the supported conventions in GORM</a>:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/example/VehicleService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="directive">abstract</span> <span class="predefined-type">List</span>&lt;Vehicle&gt; list(<span class="predefined-type">Map</span> args ) <i class="conum" data-value="1"></i><b>(1)</b>

<span class="directive">abstract</span> <span class="predefined-type">Integer</span> count() <i class="conum" data-value="2"></i><b>(2)</b>

<span class="directive">abstract</span> Vehicle find(<span class="predefined-type">Serializable</span> id) <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>list</code> method returns a list of <code>Vehicle</code> instances and takes optional arguments as a map to perform pagination</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>count</code> method counts the number of <code>Vehicle</code> instances</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>find</code> method finds a single <code>Vehicle</code> by <code>id</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now it is time to write a controller that can use these newly defined methods. First, create a
new <code>grails-app/controllers/example/VehicleController.groovy</code> class with either
the <code>create-controller</code> command or your preferred IDE.</p>
</div>
<div class="paragraph">
<p>The <code>VehicleController</code> should define a property referencing the previously created <code>VehicleService</code>:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/example/VehicleController.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">static</span> <span class="include">org.springframework.http.HttpStatus.NOT_FOUND</span>
<span class="keyword">import</span> <span class="include">grails.gorm.multitenancy.CurrentTenant</span>
<span class="keyword">import</span> <span class="include">grails.validation.ValidationException</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">VehicleController</span>  {

    <span class="directive">static</span> allowedMethods = [<span class="key">save</span>: <span class="string"><span class="delimiter">'</span><span class="content">POST</span><span class="delimiter">'</span></span>, <span class="key">update</span>: <span class="string"><span class="delimiter">'</span><span class="content">PUT</span><span class="delimiter">'</span></span>, <span class="key">delete</span>: <span class="string"><span class="delimiter">'</span><span class="content">DELETE</span><span class="delimiter">'</span></span>]

    VehicleService vehicleService
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now run <code>grails generate-views</code> to generate some default GSP views that can render the <code>Vehicle</code> instances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ grails generate-views example.Vehicle</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next add an entry into the <code>UrlMappings.groovy</code> file to map the <code>/vehicles</code> URI:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/example/UrlMappings.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="string"><span class="delimiter">'</span><span class="content">/vehicles</span><span class="delimiter">'</span></span>(<span class="key">resources</span>: <span class="string"><span class="delimiter">'</span><span class="content">vehicle</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you are ready to add the query logic to read <code>Vehicle</code> instances for each tenant. Update <code>VehicleController</code> with the following read operations:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/example/VehicleController.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> <span class="function">index</span>(<span class="predefined-type">Integer</span> max) {
    params.max = <span class="predefined-type">Math</span>.min(max ?: <span class="integer">10</span>, <span class="integer">100</span>)
    respond vehicleService.list(params), <span class="key">model</span>: [<span class="key">vehicleCount</span>: vehicleService.count()]
}

<span class="keyword">def</span> <span class="function">show</span>(<span class="predefined-type">Long</span> id) {
    Vehicle vehicle = id ? vehicleService.find(id) : <span class="predefined-constant">null</span>
    respond vehicle
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both the <code>find</code> and <code>show</code> actions use the <code>VehicleService</code> to locate <code>Vehicle</code> instances. The <code>VehicleService</code> will ensure the correct tenant is resolved and the correct data returned for each tenant.</p>
</div>


<h2 id="writingData">3.5.2 Executing Multi-Tenant Updates</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/discriminator-per-tenant/edit/master/src/main/docs/guide/writingTheApp/multiTenantLogic/writingData.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To add logic to perform write operations you can simply modify the <code>VehicleService</code> and add new abstract methods for <code>save</code> and <code>delete</code>:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/example/VehicleService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="directive">abstract</span> Vehicle save(<span class="predefined-type">String</span> model,
                        <span class="predefined-type">Integer</span> year)

<span class="directive">abstract</span> Vehicle delete(<span class="predefined-type">Serializable</span> id)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above <code>save</code> and <code>delete</code> methods will be implemented automatically for you.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
GORM Data Services are smart about adding appropriate transaction semantics to each method (for example, <code>readOnly</code> for read operations). However you can override the transaction semantics by adding the <code>@Transactional</code> annotation yourself.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To implement updates you can add a new method that calls the existing abstract <code>find</code> method:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/example/VehicleService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Transactional</span>
Vehicle update( <span class="predefined-type">Serializable</span> id, <i class="conum" data-value="5"></i><b>(5)</b>
                <span class="predefined-type">String</span> model,
                <span class="predefined-type">Integer</span> year) {
    Vehicle vehicle = find(id)
    <span class="keyword">if</span> (vehicle != <span class="predefined-constant">null</span>) {
        vehicle.model = model
        vehicle.year = year
        vehicle.save(<span class="key">failOnError</span>:<span class="predefined-constant">true</span>)
    }
    vehicle
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This demonstrates an important concept of GORM Data Services: It is possible to easily mix methods you define with ones that are automatically implemented for you by GORM.</p>
</div>
<div class="paragraph">
<p>The corresponding controller actions to call <code>VehicleService</code> and expose these write operations are also trivial:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/example/VehicleController.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> <span class="function">save</span>(<span class="predefined-type">String</span> model, <span class="predefined-type">Integer</span> year) {
    <span class="keyword">try</span> {
        Vehicle vehicle = vehicleService.save(model, year)
        flash.message = <span class="string"><span class="delimiter">'</span><span class="content">Vehicle created</span><span class="delimiter">'</span></span>
        redirect vehicle
    } <span class="keyword">catch</span> (ValidationException e) {
        respond e.errors, <span class="key">view</span>: <span class="string"><span class="delimiter">'</span><span class="content">create</span><span class="delimiter">'</span></span>
    }
}

<span class="keyword">def</span> <span class="function">update</span>(<span class="predefined-type">Long</span> id, <span class="predefined-type">String</span> model, <span class="predefined-type">Integer</span> year) {
    <span class="keyword">try</span> {
        Vehicle vehicle = vehicleService.update(id, model, year)
        <span class="keyword">if</span> (vehicle == <span class="predefined-constant">null</span>) {
            notFound()
        } <span class="keyword">else</span> <span class="keyword">if</span> ( vehicle.hasErrors() ) {
            redirect <span class="key">action</span>: <span class="string"><span class="delimiter">'</span><span class="content">edit</span><span class="delimiter">'</span></span>, <span class="key">params</span>: [<span class="key">id</span>: id]
        }
        <span class="keyword">else</span> {
            flash.message = <span class="string"><span class="delimiter">'</span><span class="content">Vehicle updated</span><span class="delimiter">'</span></span>
            redirect vehicle
        }
    } <span class="keyword">catch</span> (ValidationException e) {
        respond e.errors, <span class="key">view</span>: <span class="string"><span class="delimiter">'</span><span class="content">edit</span><span class="delimiter">'</span></span>
    }
}

<span class="directive">protected</span> <span class="type">void</span> notFound() {
    flash.message = <span class="string"><span class="delimiter">'</span><span class="content">Vehicle not found</span><span class="delimiter">'</span></span>
    redirect <span class="key">uri</span>: <span class="string"><span class="delimiter">'</span><span class="content">/vehicles</span><span class="delimiter">'</span></span>, <span class="key">status</span>: NOT_FOUND
}

<span class="keyword">def</span> <span class="function">delete</span>(<span class="predefined-type">Long</span> id) {
    Vehicle vehicle = vehicleService.delete(id)
    <span class="keyword">if</span> (vehicle == <span class="predefined-constant">null</span>) {
        notFound()
    }
    <span class="keyword">else</span> {
        flash.message = <span class="string"><span class="delimiter">'</span><span class="content">Vehicle Deleted</span><span class="delimiter">'</span></span>
        redirect <span class="key">action</span>: <span class="string"><span class="delimiter">'</span><span class="content">index</span><span class="delimiter">'</span></span>, <span class="key">method</span>: <span class="string"><span class="delimiter">'</span><span class="content">GET</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>


<h1 id="testingTheApp">4 Multi-Tenancy Unit Testing</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/discriminator-per-tenant/edit/master/src/main/docs/guide/testingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Testing controller logic that uses Multi-Tenancy requires special considerations.</p>
</div>
<div class="paragraph">
<p>Luckily GORM 6.1 makes it relatively simple to write unit tests.</p>
</div>
<div class="paragraph">
<p>To write a unit test for the <code>VehicleController</code> class create a new<br>
<code>src/test/groovy/example/VehicleControllerSpec.groovy</code> Spock specification:</p>
</div>
<div class="listingblock">
<div class="title">src/test/groovy/example/VehicleControllerSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">VehicleControllerSpec</span> <span class="directive">extends</span> HibernateSpec <span class="directive">implements</span> ControllerUnitTest&lt;VehicleController&gt; {
        ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see above the test extends <code>HibernateSpec</code>.</p>
</div>
<div class="paragraph">
<p>To make testing simpler override the <code>tenantResolverClass</code> by overriding the <code>getConfiguration()</code> method of <code>HibernateSpec</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/test/groovy/example/VehicleControllerSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Override</span>
<span class="predefined-type">Map</span> getConfiguration() {
    <span class="local-variable">super</span>.getConfiguration() + [(Settings.SETTING_MULTI_TENANT_RESOLVER_CLASS): SystemPropertyTenantResolver]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will allow you to use <a href="http://gorm.grails.org/latest/api//org/grails/datastore/mapping/multitenancy/resolvers/SystemPropertyTenantResolver.html">SystemPropertyTenantResolver</a> for changing the tenant id within the test.</p>
</div>
<div class="paragraph">
<p>Next step is to provide a <code>setup</code> method that configures the <code>VehicleService</code> for the controller:</p>
</div>
<div class="listingblock">
<div class="title">src/test/groovy/example/VehicleControllerSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">VehicleService vehicleService <i class="conum" data-value="1"></i><b>(1)</b>

<span class="keyword">def</span> <span class="function">setup</span>() {
    <span class="predefined-type">System</span>.setProperty(SystemPropertyTenantResolver.PROPERTY_NAME, <span class="string"><span class="delimiter">'</span><span class="content">audi</span><span class="delimiter">'</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
    vehicleService = hibernateDatastore.getService(VehicleService) <i class="conum" data-value="3"></i><b>(3)</b>
    controller.vehicleService = vehicleService <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define a <code>vehicleService</code> as a property of the unit test</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the tenant id to <code>audi</code> for the purposes of the test</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Lookup the <code>VehicleService</code> implementation from GORM</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Assign the <code>VehicleService</code> to the controller under test</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To ensure proper cleanup you should also clear the tenant id in a <code>cleanup</code> method:</p>
</div>
<div class="listingblock">
<div class="title">src/test/groovy/example/VehicleControllerSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> <span class="function">cleanupSpec</span>() {
    <span class="predefined-type">System</span>.setProperty(SystemPropertyTenantResolver.PROPERTY_NAME, <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With that done it is trivial to test the controller logic, for example to test the <code>index</code> action with no data:</p>
</div>
<div class="listingblock">
<div class="title">src/test/groovy/example/VehicleControllerSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">Test the index action returns the correct model</span><span class="delimiter">'</span></span>() {

    <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">The index action is executed</span><span class="delimiter">'</span></span>
    controller.index()

    <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">The model is correct</span><span class="delimiter">'</span></span>
    !model.vehicleList
    model.vehicleCount == <span class="integer">0</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also write tests to test the case where no tenant id is present by clearing the tenant id:</p>
</div>
<div class="listingblock">
<div class="title">src/test/groovy/example/VehicleControllerSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">Test the index action with no tenant id</span><span class="delimiter">'</span></span>() {
    <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">there is no tenant id</span><span class="delimiter">'</span></span>
    <span class="predefined-type">System</span>.setProperty(SystemPropertyTenantResolver.PROPERTY_NAME, <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>)
    controller.index()

    <span class="key">then</span>:
    thrown(TenantNotFoundException)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Testing more complex interactions like saving data is possible too:</p>
</div>
<div class="listingblock">
<div class="title">src/test/groovy/example/VehicleControllerSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">Test the save action correctly persists an instance</span><span class="delimiter">'</span></span>() {

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">The save action is executed with an invalid instance</span><span class="delimiter">'</span></span>
        request.contentType = FORM_CONTENT_TYPE
        request.method = <span class="string"><span class="delimiter">'</span><span class="content">POST</span><span class="delimiter">'</span></span>
        controller.save(<span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>, <span class="integer">1900</span>)

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">The create view is rendered again with the correct model</span><span class="delimiter">'</span></span>
        model.vehicle != <span class="predefined-constant">null</span>
        view == <span class="string"><span class="delimiter">'</span><span class="content">create</span><span class="delimiter">'</span></span>

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">The save action is executed with a valid instance</span><span class="delimiter">'</span></span>
        controller.save(<span class="string"><span class="delimiter">'</span><span class="content">A5</span><span class="delimiter">'</span></span>, <span class="integer">2011</span>)

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">A redirect is issued to the show action</span><span class="delimiter">'</span></span>
        controller.flash.message != <span class="predefined-constant">null</span>
        vehicleService.count() == <span class="integer">1</span>
        response.redirectedUrl == <span class="string"><span class="delimiter">'</span><span class="content">/vehicles/1</span><span class="delimiter">'</span></span>

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">The show action is executed with a null domain</span><span class="delimiter">'</span></span>
        controller.show(<span class="predefined-constant">null</span>)

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">A 404 error is returned</span><span class="delimiter">'</span></span>
        response.status == <span class="integer">404</span>

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">Update is called for a domain instance that doesn</span><span class="char">\'</span><span class="content">t exist</span><span class="delimiter">'</span></span>
        response.reset()
        request.contentType = FORM_CONTENT_TYPE
        request.method = <span class="string"><span class="delimiter">'</span><span class="content">PUT</span><span class="delimiter">'</span></span>
        controller.update(<span class="integer">999</span>, <span class="string"><span class="delimiter">'</span><span class="content">A5</span><span class="delimiter">'</span></span>, <span class="integer">2011</span>)

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">A 404 error is returned</span><span class="delimiter">'</span></span>
        response.redirectedUrl == <span class="string"><span class="delimiter">'</span><span class="content">/vehicles</span><span class="delimiter">'</span></span>
        flash.message != <span class="predefined-constant">null</span>

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">An invalid domain instance is passed to the update action</span><span class="delimiter">'</span></span>
        response.reset()
        controller.update(<span class="integer">1</span>, <span class="string"><span class="delimiter">'</span><span class="content">A5</span><span class="delimiter">'</span></span>, <span class="integer">1900</span>)

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">The edit view is rendered again with the invalid instance</span><span class="delimiter">'</span></span>
        view == <span class="string"><span class="delimiter">'</span><span class="content">edit</span><span class="delimiter">'</span></span>
        model.vehicle <span class="keyword">instanceof</span> Vehicle

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">A valid domain instance is passed to the update action</span><span class="delimiter">'</span></span>
        response.reset()
        controller.update(<span class="integer">1</span>, <span class="string"><span class="delimiter">'</span><span class="content">A5</span><span class="delimiter">'</span></span>, <span class="integer">2012</span>)

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">A redirect is issued to the show action</span><span class="delimiter">'</span></span>
        response.redirectedUrl == <span class="string"><span class="delimiter">'</span><span class="content">/vehicles/1</span><span class="delimiter">'</span></span>
        flash.message != <span class="predefined-constant">null</span>

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">The delete action is called for a null instance</span><span class="delimiter">'</span></span>
        response.reset()
        request.contentType = FORM_CONTENT_TYPE
        request.method = <span class="string"><span class="delimiter">'</span><span class="content">DELETE</span><span class="delimiter">'</span></span>
        controller.delete(<span class="predefined-constant">null</span>)

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">A 404 is returned</span><span class="delimiter">'</span></span>
        response.redirectedUrl == <span class="string"><span class="delimiter">'</span><span class="content">/vehicles</span><span class="delimiter">'</span></span>
        flash.message != <span class="predefined-constant">null</span>
        vehicleService.count() == <span class="integer">1</span>

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">A domain instance is created</span><span class="delimiter">'</span></span>
        response.reset()
        controller.delete(<span class="integer">1</span>)

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">The instance is deleted</span><span class="delimiter">'</span></span>
        vehicleService.count() == <span class="integer">0</span>
        response.redirectedUrl == <span class="string"><span class="delimiter">'</span><span class="content">/vehicles</span><span class="delimiter">'</span></span>
        flash.message != <span class="predefined-constant">null</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that within the assertions of the above test we use the <code>vehicleService</code> which makes sure the correct tenant is used when making the assertion.</p>
</div>


<h1 id="integrationTest">5 Functional Tests</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/discriminator-per-tenant/edit/master/src/main/docs/guide/integrationTest.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We map the CRUD pages with the help of Geb Pages:</p>
</div>
<div class="listingblock">
<div class="title">src/integration-test/groovy/example/ManufacturersPage.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example

<span class="keyword">import</span> <span class="include">geb.Page</span>

<span class="type">class</span> <span class="class">ManufacturersPage</span> <span class="directive">extends</span> Page {

    <span class="directive">static</span> at = { <span class="error">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">h2</span><span class="delimiter">'</span></span>).text().contains(<span class="string"><span class="delimiter">'</span><span class="content">Available Manufacturers</span><span class="delimiter">'</span></span>) }

    <span class="directive">static</span> content = {
        audiLink { <span class="error">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">a</span><span class="delimiter">'</span></span>, <span class="key">text</span>: <span class="string"><span class="delimiter">'</span><span class="content">Audi</span><span class="delimiter">'</span></span>) }
        fordLink { <span class="error">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">a</span><span class="delimiter">'</span></span>, <span class="key">text</span>: <span class="string"><span class="delimiter">'</span><span class="content">Ford</span><span class="delimiter">'</span></span>) }
    }

    <span class="type">void</span> selectAudi() {
        audiLink.click()
    }

    <span class="type">void</span> selectFord() {
        fordLink.click()
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/integration-test/groovy/example/NewVehiclePage.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example

<span class="keyword">import</span> <span class="include">geb.Page</span>

<span class="type">class</span> <span class="class">NewVehiclePage</span> <span class="directive">extends</span> Page {

    <span class="directive">static</span> at = { title.contains(<span class="string"><span class="delimiter">'</span><span class="content">Create Vehicle</span><span class="delimiter">'</span></span>) }

    <span class="directive">static</span> content = {
        inputModel { <span class="error">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">input</span><span class="delimiter">'</span></span>, <span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">model</span><span class="delimiter">'</span></span>) }
        inputYear { <span class="error">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">input</span><span class="delimiter">'</span></span>, <span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">year</span><span class="delimiter">'</span></span>) }
        createButton { <span class="error">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">input</span><span class="delimiter">'</span></span>, <span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">create</span><span class="delimiter">'</span></span>) }
    }

    <span class="type">void</span> newVehicle(<span class="predefined-type">String</span> model, <span class="type">int</span> year) {
        inputModel &lt;&lt; model
        inputYear = year
        createButton.click()
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/integration-test/groovy/example/ShowVehiclePage.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example

<span class="keyword">import</span> <span class="include">geb.Page</span>

<span class="type">class</span> <span class="class">ShowVehiclePage</span> <span class="directive">extends</span> Page {

    <span class="directive">static</span> at = { title.contains(<span class="string"><span class="delimiter">'</span><span class="content">Show Vehicle</span><span class="delimiter">'</span></span>) }

    <span class="directive">static</span> content = {
        listButton { <span class="error">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">a</span><span class="delimiter">'</span></span>, <span class="key">text</span>: <span class="string"><span class="delimiter">'</span><span class="content">Vehicle List</span><span class="delimiter">'</span></span>) }
    }

    <span class="type">void</span> vehicleList() {
        listButton.click()
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/integration-test/groovy/example/VehiclesPage.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example

<span class="keyword">import</span> <span class="include">geb.Page</span>

<span class="type">class</span> <span class="class">VehiclesPage</span> <span class="directive">extends</span> Page {

    <span class="directive">static</span> at = { title.contains(<span class="string"><span class="delimiter">'</span><span class="content">Vehicle List</span><span class="delimiter">'</span></span>) }

    <span class="directive">static</span> content = {
        newVehicleLink { <span class="error">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">a</span><span class="delimiter">'</span></span>, <span class="key">text</span>: <span class="string"><span class="delimiter">'</span><span class="content">New Vehicle</span><span class="delimiter">'</span></span>) }
        vehiclesRows { <span class="error">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">tbody tr</span><span class="delimiter">'</span></span>) }
    }

    <span class="type">void</span> newVehicle() {
        newVehicleLink.click()
    }

    <span class="type">int</span> numberOfVehicles() {
        vehiclesRows.size()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We test tenant selection with the help of a functional test:</p>
</div>
<div class="listingblock">
<div class="title">src/integration-test/groovy/example/TenantSelectionFuncSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example

<span class="keyword">import</span> <span class="include">geb.spock.GebSpec</span>
<span class="keyword">import</span> <span class="include">grails.testing.mixin.integration.Integration</span>

<span class="annotation">@Integration</span>
<span class="type">class</span> <span class="class">TenantSelectionFuncSpec</span> <span class="directive">extends</span> GebSpec {

    <span class="keyword">def</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">it is possible to change tenants and get different lists of vehicles</span><span class="delimiter">&quot;</span></span>() {

        <span class="key">when</span>:
        go <span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>

        <span class="key">then</span>:
        at ManufacturersPage

        <span class="key">when</span>:
        ManufacturersPage page = browser.page(ManufacturersPage)
        page.selectAudi()

        <span class="key">then</span>:
        at VehiclesPage

        <span class="key">when</span>:
        VehiclesPage vehiclesPage = browser.page(VehiclesPage)
        vehiclesPage.newVehicle()

        <span class="key">then</span>:
        at NewVehiclePage

        <span class="key">when</span>:
        NewVehiclePage newVehiclePage = browser.page(NewVehiclePage)
        newVehiclePage.newVehicle(<span class="string"><span class="delimiter">'</span><span class="content">A5</span><span class="delimiter">'</span></span>, <span class="integer">2000</span>)

        <span class="key">then</span>:
        at ShowVehiclePage

        <span class="key">when</span>:
        ShowVehiclePage showVehiclePage = browser.page(ShowVehiclePage)
        showVehiclePage.vehicleList()

        <span class="key">then</span>:
        at VehiclesPage

        <span class="key">when</span>:
        vehiclesPage = browser.page(VehiclesPage)

        <span class="key">then</span>:
        vehiclesPage.numberOfVehicles() == <span class="integer">1</span>

        <span class="key">when</span>:
        vehiclesPage.newVehicle()

        <span class="key">then</span>:
        at NewVehiclePage

        <span class="key">when</span>:
        newVehiclePage = browser.page(NewVehiclePage)
        newVehiclePage.newVehicle(<span class="string"><span class="delimiter">'</span><span class="content">A3</span><span class="delimiter">'</span></span>, <span class="integer">2001</span>)

        <span class="key">then</span>:
        at ShowVehiclePage

        <span class="key">when</span>:
        showVehiclePage = browser.page(ShowVehiclePage)
        showVehiclePage.vehicleList()

        <span class="key">then</span>:
        at VehiclesPage

        <span class="key">when</span>:
        vehiclesPage = browser.page(VehiclesPage)

        <span class="key">then</span>:
        vehiclesPage.numberOfVehicles() == <span class="integer">2</span>

        <span class="key">when</span>:
        go <span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>

        <span class="key">then</span>:
        at ManufacturersPage

        <span class="key">when</span>:
        ManufacturersPage manufacturersPage = browser.page(ManufacturersPage)
        manufacturersPage.selectFord()

        <span class="key">then</span>:
        at VehiclesPage

        <span class="key">when</span>:
        vehiclesPage = browser.page(VehiclesPage)
        vehiclesPage.newVehicle()

        <span class="key">then</span>:
        at NewVehiclePage

        <span class="key">when</span>:
        newVehiclePage = browser.page(NewVehiclePage)
        newVehiclePage.newVehicle(<span class="string"><span class="delimiter">'</span><span class="content">KA</span><span class="delimiter">'</span></span>, <span class="integer">1996</span>)

        <span class="key">then</span>:
        at ShowVehiclePage

        <span class="key">when</span>:
        showVehiclePage = browser.page(ShowVehiclePage)
        showVehiclePage.vehicleList()

        <span class="key">then</span>:
        at VehiclesPage

        <span class="key">when</span>:
        vehiclesPage = browser.page(VehiclesPage)

        <span class="key">then</span>:
        vehiclesPage.numberOfVehicles() == <span class="integer">1</span>
    }

}</code></pre>
</div>
</div>


<h1 id="runningTheApp">6 Running the Application</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/discriminator-per-tenant/edit/master/src/main/docs/guide/runningTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To run the application use the <code>./gradlew bootRun</code> command which will start the application on port 8080.</p>
</div>
<div class="paragraph">
<p>Now perform the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to the home page and select "Audi"</p>
</li>
<li>
<p>Enter data for a <code>Vehicle</code> to create a new <code>Vehicle</code></p>
</li>
<li>
<p>Note that the data will be created with <code>audi</code> as the value for the discriminator column <code>manufacturer</code> in the <code>vehicle</code> table.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you then navigate back to the homepage and select "Ford" the current tenant
is switched. The webapp displays the data for the tenant <code>ford</code>. The discriminator column
effectively isolates the data between the two tenants.</p>
</div>


<h1 id="helpWithGrails">7 Do you need help with Grails?</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/discriminator-per-tenant/edit/master/src/main/docs/guide/helpWithGrails.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<h3 style="color: #333; margin-bottom:25px;"><a href="https://objectcomputing.com/" target="_blank">Object Computing, Inc.</a> (OCI) sponsored the creation of this Guide. A variety of consulting and support services are available.</h3>

<!-- BEGIN HubSpot Consultation Form -->

<!--[if lte IE 8]>
<script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2-legacy.js"></script>
<![endif]-->
<script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2.js"></script>
<script>
  hbspt.forms.create({
	portalId: "4547412",
	formId: "f8bc9b16-d5f6-4226-a24e-da0eb8b73363"
});
</script>

<!-- END HubSpot Consultation Form -->

<h3 style="color: #333;">OCI is Home to Grails</h3>

<p><a href="https://objectcomputing.com/products/2gm-team" target="_blank">Meet the Team</a></p>

</article></div><footer>
  <div class='content'>
    <div class='ocihometograils'>
      <span>Sponsored by</span>
      <a href='https://objectcomputing.com/products/grails/'><img class='' src='/images/oci_home_to_grails.svg' alt='Object Computing - Home to Grails' width='300px' /></a>
    </div>
    <nav class='socialmedianav'><ul>
  <li>
    <a href='https://slack.grails.org'><img class='' src='/images/slack.svg' alt='Slack Icon' /></a>
  </li>
  <li>
    <a href='https://www.youtube.com/watch?v=XnRNfDGkBVg&amp;list=PLI74De5M9T73uH3WilDCePP2qfSDpMaGu'><img class='' src='/images/youtube.svg' alt='Youtube Icon' /></a>
  </li>
  <li>
    <a href='https://www.linkedin.com/groups/39757'><img class='' src='/images/linkedin.svg' alt='LinkedIn Icon' /></a>
  </li>
  <li>
    <a href='https://github.com/grails/'><img class='' src='/images/github.svg' alt='Github Icon' /></a>
  </li>
  <li>
    <a href='https://twitter.com/grailsframework'><img class='' src='/images/twitter.svg' alt='Twitter Icon' /></a>
  </li>
</ul></nav>
    <nav class='partnersnav'><ul>
  <li>Grails' repositories are hosted by
    <a href='https://repo.grails.org/'>Artifactory</a>
  </li>
  <li>Website hosting provided by
    <a href='https://aws.amazon.com/'>AWS</a>
  </li>
  <li>JetBrains supports Grails with its 
    <a href='https://www.jetbrains.com/idea/'>IntelliJ IDEA IDE</a>
  </li>
  <li>YourKit supports Grails with its 
    <a href='https://www.yourkit.com/java/profiler/index.jsp'>Java Profiler</a>
  </li>
  <li>Grails is Open Source
    <a href='http://www.apache.org/licenses/LICENSE-2.0.html'>Apache 2 License</a>
  </li>
  <li>
    <a href='https://grails.org/buildstatus.html'>Build Status</a>
  </li>
</ul></nav>
  </div>
</footer><div>
  <script type='text/javascript'>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-82213539-2', 'auto');
              ga('send', 'pageview');
</script>
  <script type='text/javascript'>
adroll_adv_id = "HBWJH4CQCJGS5DJRSB4Z4D";
adroll_pix_id = "IVEQYFOZXZAPZMDVQH7BFE";
/* OPTIONAL: provide email to improve user identification */
/* adroll_email = "username@example.com"; */
(function () {
    var _onload = function(){
        if (document.readyState && !/loaded|complete/.test(document.readyState)){setTimeout(_onload, 10);return}
        if (!window.__adroll_loaded){__adroll_loaded=true;setTimeout(_onload, 50);return}
        var scr = document.createElement("script");
        var host = (("https:" == document.location.protocol) ? "https://s.adroll.com" : "http://a.adroll.com");
        scr.setAttribute('async', 'true');
        scr.type = "text/javascript";
        scr.src = host + "/j/roundtrip.js";
        ((document.getElementsByTagName('head') || [null])[0] ||
            document.getElementsByTagName('script')[0].parentNode).appendChild(scr);
    };
    if (window.addEventListener) {window.addEventListener('load', _onload, false);}
    else {window.attachEvent('onload', _onload)}
}());            
</script>
</div></body>
</html>
