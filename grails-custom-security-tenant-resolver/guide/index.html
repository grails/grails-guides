<!DOCTYPE html>
<html>
  <head>
    <meta name='google-site-verification' content='REYQ1_I6HGowAE7LOLVqfQbnKaB4IfFpMlGzMbJj55Q' />
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <link rel='icon' href='../img/favicon.ico' />
    <link rel='mask-icon' href='/../img/grails-pinned-icon.svg' color='feb672' />
    <meta charset='UTF-8' />
    <title>Custom Tenant Resolver by Current Logged in User | Grails Guides | Grails Framework</title>
    <meta name='description' content='Custom Tenant Resolver by Current Logged in User. Learn how to create a custom tenant resolver and use Grails Multi-Tenancy capabilities to switch tenants based on the current logged user or by a JWT.' />
    <link rel='stylesheet' href='../css/main.css' />
    <link rel='stylesheet' href='../css/screen.css' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js'></script>
  </head>
  <body class='guide'><header class='mainheader'>
  <div class='content'>
    <a href='https://grails.org/index.html'><img class='grailslogo' src='/images/grails_logo.svg' alt='Grails Logo' /></a>
    <a href='javascript:show(&apos;topmenus&apos;, &apos;showNavigationLink&apos;)' id='showNavigationLink' class='mobile align-center'>Show Navigation</a>
    <div id='topmenus'>
      <nav class='secondarymenu' id='secondarymenu'><ul>
  <li>
    <a href='https://grails.org/learning.html'>Learning</a>
  </li>
  <li>
    <a href='https://grails.org/community.html'>Community</a>
  </li>
  <li>
    <a href='https://grails.org/search.html'>Search</a>
  </li>
</ul></nav>
      <nav class='mainmenu' id='mainmenu'><ul>
  <li>
    <a href='https://grails.org/documentation.html'>Documentation</a>
  </li>
  <li>
    <a href='https://grails.org/download.html'>Download</a>
  </li>
  <li>
    <a href='https://plugins.grails.org'>Plugins</a>
  </li>
  <li>
    <a href='https://guides.grails.org/index.html'>Guides</a>
  </li>
  <li>
    <a href='https://grails.org/faq.html'>FAQ</a>
  </li>
  <li>
    <a href='https://grails.org/support.html'>Support</a>
  </li>
</ul></nav>
    </div>
  </div>
</header><div class='fullwidth'><article class="guide">
    <aside>
        <a href="https://travis-ci.org/grails-guides/grails-custom-security-tenant-resolver"><img src="https://travis-ci.org/grails-guides/grails-custom-security-tenant-resolver.svg?branch=master"></a>

        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/grails-guides/grails-custom-security-tenant-resolver&quot;"><img height="15" src="../img/github_white.svg" alt="Github"/><span>&nbsp;Get the Code</span></button>


        <ul class="githublinks">
            <li><button type="button" class="btn btn-default" href="#" onclick="document.getElementById('github-url').value='git@github.com:grails-guides/grails-custom-security-tenant-resolver.git'" class="codeButton">SSH</button></li>
            <li><button type="button" class="btn btn-default" onclick="document.getElementById('github-url').value='https://github.com/grails-guides/grails-custom-security-tenant-resolver.git'" class="codeButton">HTTPS</button></li>
        </ul>
        <div class="input-group">
            <!-- Target -->
            <input id="github-url" value="git@github.com:grails-guides/grails-custom-security-tenant-resolver.git" type="text" />
            <!-- Trigger -->
            <button type="button" class="clippy btn btn-default" type="button" data-clipboard-target="#github-url">
                <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
            </button>
        </div>
        <script>var clipboard = new Clipboard('.clippy');</script>
        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/grails-guides/grails-custom-security-tenant-resolver/archive/master.zip&quot;">Download ZIP</button>
        
        <div id="table-of-content">
            <h3>Table of Contents</h3>
            
            <div class="toc-item" style="margin-left:0px"><a href="#training"><strong>1</strong><span>Grails Training</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#gettingStarted"><strong>2</strong><span>Getting Started</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#requirements"><strong>2.1</strong><span>What you will need</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#howto"><strong>2.2</strong><span>How to complete the guide</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#writingTheApp"><strong>3</strong><span>Writing the Application</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#domain"><strong>3.1</strong><span>Create Domain Class</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#controller"><strong>3.2</strong><span>Controller</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#security"><strong>3.3</strong><span>Wire up Security</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#tenantResolver"><strong>3.4</strong><span>Custom Tenant Resolver</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#tenantResolverByJWT"><strong>3.5</strong><span>Tenant Resolver by JWT</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#tenantResolverByUser"><strong>3.6</strong><span>Tenant Resolver by User</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#test"><strong>3.7</strong><span>Functional Test</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#runTests"><strong>4</strong><span>Run the tests</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#helpWithGrails"><strong>5</strong><span>Help with Grails</span></a></div>
            
            <div style="clear:both" ></div>
        </div>
        
    </aside>
    <header>
        <h1>Custom Tenant Resolver by Current Logged in User</h1>
        <p>Learn how to create a custom tenant resolver and use Grails Multi-Tenancy capabilities to switch tenants based on the current logged user or by a JWT.</p>
        <p><strong>Authors:</strong> Sergio del Amo</p>
        <p><strong>Grails Version:</strong> 4.0.1</p>
    </header>
    

<h1 id="training">1 Grails Training</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-custom-security-tenant-resolver/edit/master/src/main/docs/guide/training.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p><strong>Grails Training</strong> - Developed and delivered by the folks who created and actively maintain the Grails framework!.</p>
</div>
<div id="ocitraining"></div>
<script type="text/javascript">
var getJSON = function(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.responseType = 'json';
    xhr.onload = function() {
      var status = xhr.status;
      if (status == 200) {
        callback(null, xhr.response);
      } else {
        callback(status);
      }
    };
    xhr.send();
};
getJSON('https://oci-training.cfapps.io/training', function(err, data) {
  var msg = '';
  if (err != null) {
      msg = 'Something went wrong while retrieving OCI training offerings';

  } else {
      if ( data.length == 0 ) {
         msg = '<p><b>Nothing scheduled at the moment - please check back again soon!</b></p>.';

      } else {
        msg += '<table>';
        msg += '<thead>';
        msg += '<tr><th>Course</th><th>Date(s)</th><th>Instructor(s)</th><th>Hour(s)</th></tr>';
        msg += '</thead>';
        msg += '<tbody>';

        var hrefs = new Array();
        for (var i = 0; i < data.length; i++) {
            var href = data[i].enrollmentLink;
            if (hrefs.indexOf(href) == -1) {
                msg += '<tr><td><a href="'+ href + '">'+ data[i].course + '</a></td><td>'+ data[i].dates + '</td><td>'+ data[i].instructors + '</td><td>'+ data[i].hours + '</td></tr>';
                hrefs.push(href);
            }

        }
        msg += '</tbody>';
        msg += '</table>';
      }
  }
  var ociTraining = document.getElementById("ocitraining");
  ociTraining.innerHTML = msg;
});
</script>


<h1 id="gettingStarted">2 Getting Started</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-custom-security-tenant-resolver/edit/master/src/main/docs/guide/gettingStarted.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>GORM Multi-Tenancy Support includes
<a href="http://gorm.grails.org/latest/hibernate/manual/index.html#_built_in_tenant_resolvers">several Built-In Tenant resolvers</a>.
In this guide, you are going to create your own tenant resolver to switch tenants based on the logged user in a Grails rest-api application
which uses <a href="http://alvarosanchez.github.io/grails-spring-security-rest/latest/docs/">Spring Security REST plugin</a>.</p>
</div>


<h2 id="requirements">2.1 What you will need</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-custom-security-tenant-resolver/edit/master/src/main/docs/guide/requirements.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 1.8 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
</ul>
</div>


<h2 id="howto">2.2 How to complete the guide</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-custom-security-tenant-resolver/edit/master/src/main/docs/guide/howto.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To get started do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/grails-guides/grails-custom-security-tenant-resolver/archive/master.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone the <a href="https://git-scm.com/">Git</a> repository:<br>
<code>git clone <a href="https://github.com/grails-guides/grails-custom-security-tenant-resolver.git" class="bare">https://github.com/grails-guides/grails-custom-security-tenant-resolver.git</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Grails guides repositories contain two folders:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>initial</code>  Initial project. Often a simple Grails app with some additional code to give you a head-start.</p>
</li>
<li>
<p><code>complete</code> A completed example. It is the result of working through the steps presented by the guide and applying those changes to the <code>initial</code> folder.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To complete the guide, go to the <code>initial</code> folder</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cd</code> into <code>grails-guides/grails-custom-security-tenant-resolver/initial</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>and follow the instructions in the next sections.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can go right to the <strong>completed example</strong> if you <code>cd</code> into <code>grails-guides/grails-custom-security-tenant-resolver/complete</code>
</td>
</tr>
</table>
</div>


<h1 id="writingTheApp">3 Writing the Application</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-custom-security-tenant-resolver/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This guide uses Multi-Tenancy DISCRIMINATOR mode. To learn more, read <a href="http://guides.grails.org/discriminator-per-tenant/guide/index.html">Single Database Multi-Tenancy Discriminator Column</a> Guide.
</td>
</tr>
</table>
</div>


<h2 id="domain">3.1 Create Domain Class</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-custom-security-tenant-resolver/edit/master/src/main/docs/guide/domain.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="listingblock">
<div class="title">grails-app/domain/demo/Plan.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.gorm.MultiTenant</span>

<span class="type">class</span> <span class="class">Plan</span> <span class="directive">implements</span> MultiTenant&lt;Plan&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="predefined-type">String</span> title
    <span class="predefined-type">String</span> username

    <span class="directive">static</span> mapping = {
        tenantId <span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">username</span><span class="delimiter">'</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Implement <a href="http://gorm.grails.org/latest/hibernate/api/grails/gorm/MultiTenant.html">MultiTenant</a> trait to regard this domain class as multi tenant.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Setup the tenant identifier as a column named <code>username</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create an interface <code>PlanService</code> which is a <a href="http://gorm.grails.org/latest/hibernate/manual/index.html#dataServices">GORM Data Service</a>.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/demo/PlanDataService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.gorm.multitenancy.CurrentTenant</span>
<span class="keyword">import</span> <span class="include">grails.gorm.services.Service</span>

<span class="annotation">@Service</span>(Plan) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@CurrentTenant</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="type">interface</span> PlanDataService {
    <span class="predefined-type">List</span>&lt;Plan&gt; findAll()
    Plan save(<span class="predefined-type">String</span> title)
    <span class="type">void</span> deleteByTitle(<span class="predefined-type">String</span> title)
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate it with the <code>grails.gorm.services.Service</code> annotation with the domain class the service applies to.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Resolve the current tenant for the context of this class</td>
</tr>
</table>
</div>


<h2 id="controller">3.2 Controller</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-custom-security-tenant-resolver/edit/master/src/main/docs/guide/controller.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a simple controller which uses with the previously defined <code>PlanService</code> service.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/demo/PlanController.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">PlanController</span> {
    PlanDataService planDataService

    <span class="keyword">def</span> <span class="function">index</span>() {
        [<span class="key">planList</span>: planDataService.findAll()]
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We render the <code>Plan</code> instances as JSON with the help of <a href="http://views.grails.org">JSON Views</a></p>
</div>
<div class="listingblock">
<div class="title">grails-app/views/plan/index.gson</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">demo.Plan</span>

model {
    <span class="predefined-type">Iterable</span>&lt;Plan&gt; planList
}

json tmpl.plan(<span class="string"><span class="delimiter">'</span><span class="content">plan</span><span class="delimiter">'</span></span>, planList)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/views/plan/_plan.gson</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">demo.Plan</span>

model {
    Plan plan
}

json {
    title plan.title
}</code></pre>
</div>
</div>


<h2 id="security">3.3 Wire up Security</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-custom-security-tenant-resolver/edit/master/src/main/docs/guide/security.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create security domain classes. You could create these classes with Spring Security Core <code>s2-quickstart</code>.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/domain/demo/User.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">groovy.transform.EqualsAndHashCode</span>
<span class="keyword">import</span> <span class="include">groovy.transform.ToString</span>
<span class="keyword">import</span> <span class="include">grails.compiler.GrailsCompileStatic</span>

<span class="annotation">@GrailsCompileStatic</span>
<span class="annotation">@EqualsAndHashCode</span>(includes=<span class="string"><span class="delimiter">'</span><span class="content">username</span><span class="delimiter">'</span></span>)
<span class="annotation">@ToString</span>(includes=<span class="string"><span class="delimiter">'</span><span class="content">username</span><span class="delimiter">'</span></span>, includeNames=<span class="predefined-constant">true</span>, includePackage=<span class="predefined-constant">false</span>)
<span class="type">class</span> <span class="class">User</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">long</span> serialVersionUID = <span class="integer">1</span>

    <span class="predefined-type">String</span> username
    <span class="predefined-type">String</span> password
    <span class="type">boolean</span> enabled = <span class="predefined-constant">true</span>
    <span class="type">boolean</span> accountExpired
    <span class="type">boolean</span> accountLocked
    <span class="type">boolean</span> passwordExpired

    <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Role</span>&gt; getAuthorities() {
        (UserRole.findAllByUser(<span class="local-variable">this</span>) <span class="keyword">as</span> <span class="predefined-type">List</span>&lt;UserRole&gt;)*.role <span class="keyword">as</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Role</span>&gt;
    }

    <span class="directive">static</span> constraints = {
        password <span class="key">nullable</span>: <span class="predefined-constant">false</span>, <span class="key">blank</span>: <span class="predefined-constant">false</span>, <span class="key">password</span>: <span class="predefined-constant">true</span>
        username <span class="key">nullable</span>: <span class="predefined-constant">false</span>, <span class="key">blank</span>: <span class="predefined-constant">false</span>, <span class="key">unique</span>: <span class="predefined-constant">true</span>
    }

    <span class="directive">static</span> mapping = {
            password <span class="key">column</span>: <span class="string"><span class="delimiter">'</span><span class="content">`password`</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/domain/demo/Role.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">groovy.transform.EqualsAndHashCode</span>
<span class="keyword">import</span> <span class="include">groovy.transform.ToString</span>
<span class="keyword">import</span> <span class="include">grails.compiler.GrailsCompileStatic</span>

<span class="annotation">@GrailsCompileStatic</span>
<span class="annotation">@EqualsAndHashCode</span>(includes=<span class="string"><span class="delimiter">'</span><span class="content">authority</span><span class="delimiter">'</span></span>)
<span class="annotation">@ToString</span>(includes=<span class="string"><span class="delimiter">'</span><span class="content">authority</span><span class="delimiter">'</span></span>, includeNames=<span class="predefined-constant">true</span>, includePackage=<span class="predefined-constant">false</span>)
<span class="type">class</span> <span class="class">Role</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

        <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">long</span> serialVersionUID = <span class="integer">1</span>

        <span class="predefined-type">String</span> authority

        <span class="directive">static</span> constraints = {
                authority <span class="key">nullable</span>: <span class="predefined-constant">false</span>, <span class="key">blank</span>: <span class="predefined-constant">false</span>, <span class="key">unique</span>: <span class="predefined-constant">true</span>
        }

        <span class="directive">static</span> mapping = {
                cache <span class="predefined-constant">true</span>
        }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a class <code>UserPasswordEncoderListener</code> which deals with the User&#8217;s password encoding.</p>
</div>
<div class="paragraph">
<p>It uses the <code>@Listener</code> annotation to listen <strong>synchronously</strong> to <a href="https://async.grails.org/latest/guide/index.html#gormEvents">Events from GORM</a>.</p>
</div>
<div class="listingblock">
<div class="title">src/main/groovy/demo/UserPasswordEncoderListener.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.plugin.springsecurity.SpringSecurityService</span>
<span class="keyword">import</span> <span class="include">org.grails.datastore.mapping.engine.event.AbstractPersistenceEvent</span>
<span class="keyword">import</span> <span class="include">org.grails.datastore.mapping.engine.event.PreInsertEvent</span>
<span class="keyword">import</span> <span class="include">org.grails.datastore.mapping.engine.event.PreUpdateEvent</span>
<span class="keyword">import</span> <span class="include">org.springframework.beans.factory.annotation.Autowired</span>
<span class="keyword">import</span> <span class="include">grails.events.annotation.gorm.Listener</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">UserPasswordEncoderListener</span> {

    <span class="annotation">@Autowired</span>
    SpringSecurityService springSecurityService

    <span class="annotation">@Listener</span>(User)
    <span class="type">void</span> onPreInsertEvent(PreInsertEvent event) {
        encodePasswordForEvent(event)
    }

    <span class="annotation">@Listener</span>(User)
    <span class="type">void</span> onPreUpdateEvent(PreUpdateEvent event) {
        encodePasswordForEvent(event)
    }

    <span class="directive">private</span> <span class="type">void</span> encodePasswordForEvent(AbstractPersistenceEvent event) {
        <span class="keyword">if</span> (event.entityObject <span class="keyword">instanceof</span> User) {
            User u = event.entityObject <span class="keyword">as</span> User
            <span class="keyword">if</span> (u.password &amp;&amp; ((event <span class="keyword">instanceof</span> PreInsertEvent) || (event <span class="keyword">instanceof</span> PreUpdateEvent &amp;&amp; u.isDirty(<span class="string"><span class="delimiter">'</span><span class="content">password</span><span class="delimiter">'</span></span>)))) {
                event.getEntityAccess().setProperty(<span class="string"><span class="delimiter">'</span><span class="content">password</span><span class="delimiter">'</span></span>, encodePassword(u.password))
            }
        }
    }

    <span class="directive">private</span> <span class="predefined-type">String</span> encodePassword(<span class="predefined-type">String</span> password) {
        springSecurityService?.passwordEncoder ? springSecurityService.encodePassword(password) : password
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Define the previous listener as a bean:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/spring/resources.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">demo.UserPasswordEncoderListener</span>
beans = {
    userPasswordEncoderListener(UserPasswordEncoderListener)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure Spring Security Core in <code>application.yml</code></p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="error">grails</span>
<span class="key">grails</span>:
    <span class="key">plugin</span>:
        <span class="key">springsecurity</span>:
            <span class="key">rest</span>:
                <span class="key">token</span>:
                    <span class="key">storage</span>:
                        <span class="key">jwt</span>:
                            <span class="key">secret</span>: <span class="string"><span class="content">pleaseChangeThisSecretForANewOne</span></span>
            <span class="key">securityConfigType</span>: <span class="string"><span class="content">InterceptUrlMap</span></span>
            <span class="key">userLookup</span>:
                <span class="key">userDomainClassName</span>: <span class="string"><span class="content">demo.User</span></span>
                <span class="key">authorityJoinClassName</span>: <span class="string"><span class="content">demo.UserRole</span></span>
            <span class="key">authority</span>:
                <span class="key">className</span>: <span class="string"><span class="content">demo.Role</span></span>
            <span class="key">filterChain</span>:
                <span class="key">chainMap</span>:
                    - <span class="comment"># Stateless chain</span>
                        <span class="key">pattern</span>: <span class="string"><span class="content">/**</span></span>
                        <span class="key">filters</span>: <span class="string"><span class="content">'JOINED_FILTERS,-exceptionTranslationFilter,-authenticationProcessingFilter,-securityContextPersistenceFilter,-rememberMeAuthenticationFilter'</span></span>
            <span class="key">interceptUrlMap</span>:
                -
                    <span class="key">pattern</span>: <span class="string"><span class="content">/</span></span>
                    <span class="key">access</span>:
                        - <span class="string"><span class="content">ROLE_VILLAIN</span></span>
                -
                    <span class="key">pattern</span>: <span class="string"><span class="content">/error</span></span>
                    <span class="key">access</span>:
                        - <span class="string"><span class="content">permitAll</span></span>
                -
                    <span class="key">pattern</span>: <span class="string"><span class="content">/api/login</span></span>
                    <span class="key">access</span>:
                        - <span class="string"><span class="content">ROLE_ANONYMOUS</span></span>
                -
                    <span class="key">pattern</span>: <span class="string"><span class="content">/api/validate</span></span>
                    <span class="key">access</span>:
                        - <span class="string"><span class="content">ROLE_ANONYMOUS</span></span>
                -
                    <span class="key">pattern</span>: <span class="string"><span class="content">/oauth/access_token</span></span>
                    <span class="key">access</span>:
                        - <span class="string"><span class="content">ROLE_ANONYMOUS</span></span>
                -
                    <span class="key">pattern</span>: <span class="string"><span class="content">/plan</span></span>
                    <span class="key">access</span>:
                        - <span class="string"><span class="content">ROLE_VILLAIN</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Create several <a href="http://gorm.grails.org/latest/hibernate/manual/index.html#dataServices">GORM Data Services</a> to work with the Domain Classes involved in the securization of our app.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/demo/RoleDataService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.gorm.services.Service</span>

<span class="annotation">@Service</span>(<span class="predefined-type">Role</span>)
<span class="type">interface</span> RoleDataService {
    <span class="type">void</span> delete(<span class="predefined-type">Serializable</span> id)
    <span class="type">void</span> deleteByAuthority(<span class="predefined-type">String</span> authority)
    <span class="predefined-type">Role</span> findByAuthority(<span class="predefined-type">String</span> authority)
    <span class="predefined-type">Role</span> saveByAuthority(<span class="predefined-type">String</span> authority)
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/services/demo/UserDataService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.gorm.services.Service</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="annotation">@Service</span>(User)
<span class="type">interface</span> UserDataService {
    User save(<span class="predefined-type">String</span> username, <span class="predefined-type">String</span> password)
    <span class="type">void</span> delete(<span class="predefined-type">Serializable</span> id)
    User findByUsername(<span class="predefined-type">String</span> username)
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/services/demo/UserRoleDataService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.gorm.services.Query</span>
<span class="keyword">import</span> <span class="include">grails.gorm.services.Service</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@Service</span>(UserRole)
<span class="annotation">@CompileStatic</span>
<span class="type">interface</span> UserRoleDataService {

    <span class="annotation">@Query</span>(<span class="string"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">select </span><span class="inline"><span class="inline-delimiter">$</span>user</span><span class="content">.username from </span><span class="inline"><span class="inline-delimiter">${</span>UserRole userRole<span class="inline-delimiter">}</span></span><span class="content">
    inner join </span><span class="inline"><span class="inline-delimiter">${</span>User user = userRole.user<span class="inline-delimiter">}</span></span><span class="content">
    inner join </span><span class="inline"><span class="inline-delimiter">${</span><span class="predefined-type">Role</span> role = userRole.role<span class="inline-delimiter">}</span></span><span class="content">
    where </span><span class="inline"><span class="inline-delimiter">$</span>role</span><span class="content">.authority = </span><span class="inline"><span class="inline-delimiter">$</span>authority</span><span class="delimiter">&quot;&quot;&quot;</span></span>)
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; findAllUsernameByAuthority(<span class="predefined-type">String</span> authority)

    UserRole save(User user, <span class="predefined-type">Role</span> role)

    <span class="type">void</span> delete(User user, <span class="predefined-type">Role</span> role)

    <span class="type">void</span> deleteByUser(User user)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a service to handle User creation with a specific role.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/demo/UserService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.gorm.transactions.Transactional</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">UserService</span> {
    RoleDataService roleDataService

    UserRoleDataService userRoleDataService

    UserDataService userDataService

    <span class="annotation">@Transactional</span>
    User save(<span class="predefined-type">String</span> username, <span class="predefined-type">String</span> password, <span class="predefined-type">String</span> authority) {
        <span class="predefined-type">Role</span> role = roleDataService.findByAuthority(authority)
        <span class="keyword">if</span> ( !role ) {
            role = roleDataService.saveByAuthority(authority)
        }
        User user = userDataService.save(username, password)
        userRoleDataService.save(user, role)
        user
    }
}</code></pre>
</div>
</div>


<h2 id="tenantResolver">3.4 Custom Tenant Resolver</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-custom-security-tenant-resolver/edit/master/src/main/docs/guide/tenantResolver.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The following table contains all of the <code>TenantResolver</code> implementations that ship with GORM and are usable out of the box. The package name has been shorted from <code>org.grails.datastore.mapping</code> to <code>o.g.d.m</code> for brevity:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">name</th>
<th class="tableblock halign-left valign-top">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>o.g.d.m.multitenancy.resolvers.FixedTenantResolver</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolves against a fixed tenant id</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>o.g.d.m.multitenancy.resolvers.SystemPropertyTenantResolver</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolves the tenant id from a system property called <code>gorm.tenantId</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>o.g.d.m.multitenancy.web.SubDomainTenantResolver</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolves the tenant id from the subdomain via DNS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>o.g.d.m.multitenancy.web.CookieTenantResolver</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolves the current tenant from an HTTP cookie named <code>gorm.tenantId</code> by default</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>o.g.d.m.multitenancy.web.SessionTenantResolver</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolves the current tenant from the HTTP session using the attribute <code>gorm.tenantId</code> by default</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>However, you have the flexibility to create your a custom tenant resolver is easy. In order to do that, create a class which implements
<code>org.grails.datastore.mapping.multitenancy.TenantResolver</code>.</p>
</div>
<div class="paragraph">
<p>The next sections will show you how to create two custom tenant resolvers.</p>
</div>


<h2 id="tenantResolverByJWT">3.5 Tenant Resolver by JWT</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-custom-security-tenant-resolver/edit/master/src/main/docs/guide/tenantResolverByJWT.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p><a href="http://alvarosanchez.github.io/grails-spring-security-rest/latest/docs/">Grails Spring Security REST plugin</a> allows you to authenticate your application with a JWT token present in the <code>Authorization</code> header.</p>
</div>
<div class="paragraph">
<p>Example: A request to <code>/plan</code> contains a JWT token in the <code>Authorization</code> header.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">## Request Duplicate
curl &quot;http://localhost:8080/plan&quot; \
     -H &quot;Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.....&quot; \
     -H &quot;Accept: application/json&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can create Custom Tenant Resolver which extracts the JWT token, re-hydrates it and extracts the username.</p>
</div>
<div class="listingblock">
<div class="title">src/main/groovy/demo/CurrentUserByJwtTenantResolver.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.gorm.DetachedCriteria</span>
<span class="keyword">import</span> <span class="include">grails.plugin.springsecurity.rest.token.storage.TokenStorageService</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">org.grails.datastore.mapping.multitenancy.AllTenantsResolver</span>
<span class="keyword">import</span> <span class="include">org.grails.datastore.mapping.multitenancy.TenantResolver</span>
<span class="keyword">import</span> <span class="include">org.grails.datastore.mapping.multitenancy.exceptions.TenantNotFoundException</span>
<span class="keyword">import</span> <span class="include">org.springframework.beans.factory.annotation.Autowired</span>
<span class="keyword">import</span> <span class="include">org.springframework.security.core.userdetails.UserDetails</span>
<span class="keyword">import</span> <span class="include">org.springframework.web.context.request.RequestAttributes</span>
<span class="keyword">import</span> <span class="include">org.springframework.web.context.request.RequestContextHolder</span>
<span class="keyword">import</span> <span class="include">org.springframework.web.context.request.ServletWebRequest</span>

<span class="keyword">import</span> <span class="include">javax.servlet.http.HttpServletRequest</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">CurrentUserByJwtTenantResolver</span> <span class="directive">implements</span> AllTenantsResolver { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> HEADER_NAME = <span class="string"><span class="delimiter">'</span><span class="content">Authorization</span><span class="delimiter">'</span></span>
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> HEADER_VALUE_PREFFIX = <span class="string"><span class="delimiter">'</span><span class="content">Bearer </span><span class="delimiter">'</span></span>

    <span class="predefined-type">String</span> headerName = HEADER_NAME
    <span class="predefined-type">String</span> headerValuePreffix = HEADER_VALUE_PREFFIX

    <span class="annotation">@Autowired</span>
    TokenStorageService tokenStorageService

    <span class="annotation">@Override</span>
    <span class="predefined-type">Serializable</span> resolveTenantIdentifier() <span class="directive">throws</span> TenantNotFoundException {

        RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes()
        <span class="keyword">if</span>(requestAttributes <span class="keyword">instanceof</span> ServletWebRequest) {

            HttpServletRequest httpServletRequest = ((ServletWebRequest) requestAttributes).getRequest()
            <span class="predefined-type">String</span> token = httpServletRequest.getHeader(headerName.toLowerCase())
            <span class="keyword">if</span> ( !token ) {
                <span class="keyword">throw</span> <span class="keyword">new</span> TenantNotFoundException(<span class="string"><span class="delimiter">&quot;</span><span class="content">Tenant could not be resolved from HTTP Header: </span><span class="inline"><span class="inline-delimiter">${</span>headerName<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>)
            }

            <span class="keyword">if</span> (token.startsWith(headerValuePreffix)) {
                token = token.substring(headerValuePreffix.length())
            }
            UserDetails userDetails = tokenStorageService.loadUserByToken(token)
            <span class="predefined-type">String</span> username = userDetails?.username
            <span class="keyword">if</span> ( username ) {
                <span class="keyword">return</span> username
            }
            <span class="keyword">throw</span> <span class="keyword">new</span> TenantNotFoundException(<span class="string"><span class="delimiter">&quot;</span><span class="content">Tenant could not be resolved from HTTP Header: </span><span class="inline"><span class="inline-delimiter">${</span>headerName<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>)
        }
        <span class="keyword">throw</span> <span class="keyword">new</span> TenantNotFoundException(<span class="string"><span class="delimiter">&quot;</span><span class="content">Tenant could not be resolved outside a web request</span><span class="delimiter">&quot;</span></span>)
    }

    <span class="annotation">@Override</span>
    <span class="predefined-type">Iterable</span>&lt;<span class="predefined-type">Serializable</span>&gt; resolveTenantIds() {
        <span class="keyword">new</span> DetachedCriteria(User)
                .distinct(<span class="string"><span class="delimiter">'</span><span class="content">username</span><span class="delimiter">'</span></span>)
                .list()
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>When using discriminator-based multi-tenancy then you may need to implement the <a href="http://gorm.grails.org/latest/hibernate/api/org/grails/datastore/mapping/multitenancy/AllTenantsResolver.html">AllTenantsResolver</a> interface in your TenantResolver implentation if you want to at any point iterate over all available tenants. <code>AllTenantsResolver extends `TenantResolver</code>. To create your own tenant resolver implement <code>org.grails.datastore.mapping.multitenancy.TenantResolver</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Define the Custom Tenant Resolver as a bean:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/spring/resources.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">demo.CurrentUserByJwtTenantResolver</span>
beans = {
    currentUserByJwtTenantResolver(CurrentUserByJwtTenantResolver)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create an Integration Test to test the custom Tenant Resolver.</p>
</div>
<div class="listingblock">
<div class="title">src/integration-test/groovy/demo/CurrentUserByJwtTenantResolverSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.testing.mixin.integration.Integration</span>
<span class="keyword">import</span> <span class="include">org.grails.datastore.mapping.multitenancy.exceptions.TenantNotFoundException</span>
<span class="keyword">import</span> <span class="include">org.springframework.beans.factory.annotation.Autowired</span>
<span class="keyword">import</span> <span class="include">org.springframework.mock.web.MockHttpServletRequest</span>
<span class="keyword">import</span> <span class="include">org.springframework.web.context.request.RequestContextHolder</span>
<span class="keyword">import</span> <span class="include">org.springframework.web.context.request.ServletWebRequest</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>
<span class="keyword">import</span> <span class="include">spock.lang.IgnoreIf</span>

<span class="annotation">@IgnoreIf</span>( { <span class="predefined-type">System</span>.getenv(<span class="string"><span class="delimiter">'</span><span class="content">TRAVIS</span><span class="delimiter">'</span></span>) <span class="keyword">as</span> <span class="type">boolean</span> } )
<span class="annotation">@Integration</span>
<span class="type">class</span> <span class="class">CurrentUserByJwtTenantResolverSpec</span> <span class="directive">extends</span> Specification {

    <span class="annotation">@Autowired</span>
    CurrentUserByJwtTenantResolver currentUserTenantResolver

    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Test HttpHeader resolver throws an exception outside a web request</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">when</span>:
        currentUserTenantResolver.resolveTenantIdentifier()

        <span class="key">then</span>:
        <span class="keyword">def</span> e = thrown(TenantNotFoundException)
        e.message == <span class="string"><span class="delimiter">&quot;</span><span class="content">Tenant could not be resolved outside a web request</span><span class="delimiter">&quot;</span></span>
    }


    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Test not tenant id found</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">setup</span>:
        <span class="keyword">def</span> request = <span class="keyword">new</span> MockHttpServletRequest(<span class="string"><span class="delimiter">&quot;</span><span class="content">GET</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">/foo</span><span class="delimiter">&quot;</span></span>)
        RequestContextHolder.setRequestAttributes(<span class="keyword">new</span> ServletWebRequest(request))

        <span class="key">when</span>:
        currentUserTenantResolver.resolveTenantIdentifier()

        <span class="key">then</span>:
        <span class="keyword">def</span> e = thrown(TenantNotFoundException)
        e.message == <span class="string"><span class="delimiter">&quot;</span><span class="content">Tenant could not be resolved from HTTP Header: </span><span class="inline"><span class="inline-delimiter">${</span>CurrentUserByJwtTenantResolver.HEADER_NAME<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>

        <span class="key">cleanup</span>:
        RequestContextHolder.setRequestAttributes(<span class="predefined-constant">null</span>)
    }

    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Test HttpHeader value is the tenant id when a request is present</span><span class="delimiter">&quot;</span></span>() {

        <span class="key">setup</span>:
        MockHttpServletRequest request = <span class="keyword">new</span> MockHttpServletRequest(<span class="string"><span class="delimiter">&quot;</span><span class="content">GET</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">/foo</span><span class="delimiter">&quot;</span></span>)
        <span class="predefined-type">String</span> jwt = <span class="string"><span class="delimiter">'''</span><span class="content">\
</span><span class="content">eyJhbGciOiJIUzI1NiJ9.eyJwcmluY2lwYWwiOiJINHNJQUFBQUFBQUFBSlZTdjA4VVFSUitleHhDZ2xF</span><span class="content">\
</span><span class="content">d2tjUUNHN0V6ZXdtV1Z3RkJBcGtjeHZNc01OSE03VDZXZ2RtWmRXYjJ1R3ZJVlZKUVFGUVNFbHBMXC9oT</span><span class="content">\
</span><span class="content">nRcL0FPTUZMVFV0THhaT1BhMElVNjFlZlB0OSt2TjZRV01XZ012RThPRnRHRW04MFNvMEdaR3FNUmlsQn</span><span class="content">\
</span><span class="content">ZoZW1GdTBjVG9Dc1J5QVd6UkJLNVBVSUdBUVVYRURoNnhMZDdoTmNsVlVsdHJiMkhrNmwwRGM5b2tONHd</span><span class="content">\
</span><span class="content">iaHFlNG84MTJlTXNkYVlOXC9DWlRVd2ZjS2pLM0RGSThpblN2WDBHcXBtd21EOFRwTWxqT21vMjBcL2Vo</span><span class="content">\
</span><span class="content">elJEU29udUxURDBERlV2QzB4WmpEQmM3ZXBTVldnZGZEdzJtenVoS3cxMGRVWmpHZmNXbkwzVDVLbTg5Yj</span><span class="content">\
</span><span class="content">l2YmVwS01FbjJJVnFOd3ZvVUhmUFBUVDBQT0dpbHBKU0M2M3NiRXVsT2hZYndvc1RmM1wvbXk2K0RrMzZy</span><span class="content">\
</span><span class="content">QWtDZHZMajduM0wrWkFINlB6NWNQaTJLRGlJSDAwUFdTMWk5bTVHYnFaTDVyVUd2XC9QdjQ5ZGVqaTczM0</span><span class="content">\
</span><span class="content">k2VHNFYVwvK2Z4K3o4emZOOVJaMW1uSERuUjdhRWRIdVZQMDNrU1wvY1RUN1lRaTlzaWpTVFNDOUtPWXh2</span><span class="content">\
</span><span class="content">SlVwaWlsczFXZzc2ZG5EXC96UnBiK3ZodWhiSDVsWVlmM090UWRtMUkrRUdSMnk4c1pKcld0WDkrK1BQZ</span><span class="content">\
</span><span class="content">zJSOGlXWVhSRHBjNVV1MlRKYWlScDIwMG4wK1BaaWErbmUwWElRWVArZ3JPZUdRVkZBTUFBQT09Iiwic3</span><span class="content">\
</span><span class="content">ViIjoidmVjdG9yIiwicm9sZXMiOlsiUk9MRV9WSUxMQUlOIl0sImlhdCI6MTUwNDc4MTEyNX0.cf5rGNrNolchQ3QyMsPB544fwzYGiihBkRF8KU6soxc</span><span class="delimiter">'''</span></span>

        request.addHeader(<span class="string"><span class="delimiter">'</span><span class="content">Authorization</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bearer </span><span class="inline"><span class="inline-delimiter">$</span>jwt</span><span class="delimiter">&quot;</span></span>)
        RequestContextHolder.setRequestAttributes(<span class="keyword">new</span> ServletWebRequest(request))


        <span class="key">when</span>:
        <span class="keyword">def</span> tenantId = currentUserTenantResolver.resolveTenantIdentifier()

        <span class="key">then</span>:
        tenantId == <span class="string"><span class="delimiter">&quot;</span><span class="content">vector</span><span class="delimiter">&quot;</span></span>

        <span class="key">cleanup</span>:
        RequestContextHolder.setRequestAttributes(<span class="predefined-constant">null</span>)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next were are going to configure our app to use this custom tenant resolver.</p>
</div>
<div class="paragraph">
<p>Configure Multi-Tenancy by modifying <code>application.yml</code>.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="error">grails</span>
    <span class="key">gorm</span>:
        <span class="key">multiTenancy</span>:
            <span class="key">mode</span>: <span class="string"><span class="content">DISCRIMINATOR </span></span><i class="conum" data-value="1"></i><b>(1)</b>
            <span class="key">tenantResolverClass</span>: <span class="string"><span class="content">demo.CurrentUserByJwtTenantResolver </span></span><i class="conum" data-value="2"></i><b>(2)</b>
        <span class="key">reactor</span>:
            <span class="comment"># Whether to translate GORM events into Reactor events</span>
            <span class="comment"># Disabled by default for performance reasons</span>
            <span class="key">events</span>: <span class="string"><span class="content">false</span></span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define Multi-Tenancy mode as <code>DISCRIMINATOR</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the Tenant Resolver class with a custom class which you will write later in this guide.</td>
</tr>
</table>
</div>


<h2 id="tenantResolverByUser">3.6 Tenant Resolver by User</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-custom-security-tenant-resolver/edit/master/src/main/docs/guide/tenantResolverByUser.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Alternatively, you may want to use a combination of Stateless
endpoints secured by Spring Security REST and Stateful endpoints secured by Spring Security Core. You will be interested to
create a custom resolver by the current logged in user.</p>
</div>
<div class="listingblock">
<div class="title">src/main/groovy/demo/CurrentUserTenantResolver.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.gorm.DetachedCriteria</span>
<span class="keyword">import</span> <span class="include">grails.plugin.springsecurity.SpringSecurityService</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileDynamic</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">org.grails.datastore.mapping.multitenancy.AllTenantsResolver</span>
<span class="keyword">import</span> <span class="include">org.grails.datastore.mapping.multitenancy.TenantResolver</span>
<span class="keyword">import</span> <span class="include">org.grails.datastore.mapping.multitenancy.exceptions.TenantNotFoundException</span>
<span class="keyword">import</span> <span class="include">org.springframework.beans.factory.annotation.Autowired</span>
<span class="keyword">import</span> <span class="include">org.springframework.context.annotation.Lazy</span>
<span class="keyword">import</span> <span class="include">org.springframework.security.core.userdetails.UserDetails</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">CurrentUserTenantResolver</span> <span class="directive">implements</span> AllTenantsResolver { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@Autowired</span>
    <span class="annotation">@Lazy</span>
    SpringSecurityService springSecurityService

    <span class="annotation">@Autowired</span>
    <span class="annotation">@Lazy</span>
    UserDataService userDataService

    <span class="annotation">@Override</span>
    <span class="predefined-type">Serializable</span> resolveTenantIdentifier() <span class="directive">throws</span> TenantNotFoundException {
        <span class="predefined-type">String</span> username = loggedUsername()
        <span class="keyword">if</span> ( username ) {
            <span class="keyword">return</span> username
        }
        <span class="keyword">throw</span> <span class="keyword">new</span> TenantNotFoundException(<span class="string"><span class="delimiter">&quot;</span><span class="content">Tenant could not be resolved from Spring Security Principal</span><span class="delimiter">&quot;</span></span>)
    }

    <span class="predefined-type">String</span> loggedUsername() {
        <span class="keyword">if</span> ( springSecurityService.principal <span class="keyword">instanceof</span> <span class="predefined-type">String</span> ) {
            <span class="keyword">return</span> springSecurityService.principal
        }
        <span class="keyword">if</span> (springSecurityService.principal <span class="keyword">instanceof</span> UserDetails) {
            <span class="keyword">return</span> ((UserDetails) springSecurityService.principal).username
        }
        <span class="predefined-constant">null</span>
    }

    <span class="annotation">@Override</span>
    <span class="predefined-type">Iterable</span>&lt;<span class="predefined-type">Serializable</span>&gt; resolveTenantIds() {
        userDataService.findUserUsername() <span class="keyword">as</span> <span class="predefined-type">Iterable</span>&lt;<span class="predefined-type">Serializable</span>&gt;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>When using discriminator-based multi-tenancy then you may need to implement the <a href="http://gorm.grails.org/latest/hibernate/api/org/grails/datastore/mapping/multitenancy/AllTenantsResolver.html">AllTenantsResolver</a> interface in your TenantResolver implentation if you want to at any point iterate over all available tenants. <code>AllTenantsResolver extends `TenantResolver</code>. To create your own tenant resolver implement <code>org.grails.datastore.mapping.multitenancy.TenantResolver</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Define the Custom Tenant Resolver as a bean:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/spring/resources.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">demo.CurrentUserTenantResolver</span>
beans = {
    currentUserTenantResolver(CurrentUserTenantResolver)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create an Integration Test to test the custom Tenant Resolver.</p>
</div>
<div class="listingblock">
<div class="title">src/integration-test/groovy/demo/CurrentUserTenantResolverSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.testing.mixin.integration.Integration</span>
<span class="keyword">import</span> <span class="include">org.grails.datastore.mapping.multitenancy.exceptions.TenantNotFoundException</span>
<span class="keyword">import</span> <span class="include">org.springframework.beans.factory.annotation.Autowired</span>
<span class="keyword">import</span> <span class="include">org.springframework.security.authentication.UsernamePasswordAuthenticationToken</span>
<span class="keyword">import</span> <span class="include">org.springframework.security.core.GrantedAuthority</span>
<span class="keyword">import</span> <span class="include">org.springframework.security.core.authority.AuthorityUtils</span>
<span class="keyword">import</span> <span class="include">org.springframework.security.core.context.SecurityContextHolder</span>
<span class="keyword">import</span> <span class="include">org.springframework.test.annotation.Rollback</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@Integration</span>
<span class="type">class</span> <span class="class">CurrentUserTenantResolverSpec</span> <span class="directive">extends</span> Specification {

    UserDataService userDataService
    RoleDataService roleDataService
    UserRoleDataService userRoleDataService

    <span class="annotation">@Autowired</span>
    CurrentUserTenantResolver currentUserTenantResolver

    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Test Current User throws a TenantNotFoundException if not logged in</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">when</span>:
        currentUserTenantResolver.resolveTenantIdentifier()

        <span class="key">then</span>:
        <span class="keyword">def</span> e = thrown(TenantNotFoundException)
        e.message == <span class="string"><span class="delimiter">&quot;</span><span class="content">Tenant could not be resolved from Spring Security Principal</span><span class="delimiter">&quot;</span></span>
    }

    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Test current logged in user is resolved </span><span class="delimiter">&quot;</span></span>() {
        <span class="key">given</span>:
        <span class="predefined-type">Role</span> role = roleDataService.saveByAuthority(<span class="string"><span class="delimiter">'</span><span class="content">ROLE_USER</span><span class="delimiter">'</span></span>)
        User user = userDataService.save(<span class="string"><span class="delimiter">'</span><span class="content">admin</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">admin</span><span class="delimiter">'</span></span>)
        userRoleDataService.save(user, role)

        <span class="key">when</span>:
        loginAs(<span class="string"><span class="delimiter">'</span><span class="content">admin</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">ROLE_USER</span><span class="delimiter">'</span></span>)
        <span class="predefined-type">Serializable</span> username = currentUserTenantResolver.resolveTenantIdentifier()

        <span class="key">then</span>:
        username == user.username

        <span class="key">when</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">verify AllTenantsResolver::resolveTenantIds</span><span class="delimiter">&quot;</span></span>
        <span class="predefined-type">Iterable</span>&lt;<span class="predefined-type">Serializable</span>&gt; tenantIds
        demo.User.withNewSession {
            tenantIds = currentUserTenantResolver.resolveTenantIds()
        }

        <span class="key">then</span>:
        tenantIds.toList().size() == <span class="integer">1</span>
        tenantIds.toList().get(<span class="integer">0</span>) == <span class="string"><span class="delimiter">'</span><span class="content">admin</span><span class="delimiter">'</span></span>

        <span class="key">cleanup</span>:
        userRoleDataService.delete(user, role)
        roleDataService.delete(role)
        userDataService.delete(user.id)
    }

    <span class="type">void</span> loginAs(<span class="predefined-type">String</span> username, <span class="predefined-type">String</span> authority) {
        User user = userDataService.findByUsername(username)
        <span class="keyword">if</span> ( user ) {
            <span class="comment">// have to be authenticated as an admin to create ACLs</span>
            <span class="predefined-type">List</span>&lt;GrantedAuthority&gt; authorityList = AuthorityUtils.createAuthorityList(authority)
            SecurityContextHolder.context.authentication = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(user.username,
                    user.password,
                    authorityList)
        }
    }


}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next were are going to configure our app to use this custom tenant resolver.</p>
</div>
<div class="paragraph">
<p>Configure Multi-Tenancy by modifying <code>application.yml</code>.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span class="error">grails</span>
    <span class="key">gorm</span>:
        <span class="key">multiTenancy</span>:
            <span class="key">mode</span>: <span class="string"><span class="content">DISCRIMINATOR </span></span><i class="conum" data-value="1"></i><b>(1)</b>
            <span class="key">tenantResolverClass</span>: <span class="string"><span class="content">demo.CurrentUserTenantResolver </span></span><i class="conum" data-value="2"></i><b>(2)</b>
        <span class="key">reactor</span>:
            <span class="comment"># Whether to translate GORM events into Reactor events</span>
            <span class="comment"># Disabled by default for performance reasons</span>
            <span class="key">events</span>: <span class="string"><span class="content">false</span></span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define Multi-Tenancy mode as <code>DISCRIMINATOR</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the Tenant Resolver class with a custom class which you will write later in this guide.</td>
</tr>
</table>
</div>


<h2 id="test">3.7 Functional Test</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-custom-security-tenant-resolver/edit/master/src/main/docs/guide/test.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a functional test which verifies that we can consume the API switching users.</p>
</div>
<div class="listingblock">
<div class="title">src/integration-test/groovy/demo/PlanControllerSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.gorm.multitenancy.Tenants</span>
<span class="keyword">import</span> <span class="include">grails.testing.mixin.integration.Integration</span>
<span class="keyword">import</span> <span class="include">grails.testing.spock.OnceBefore</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpRequest</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpResponse</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpStatus</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.HttpClient</span>
<span class="keyword">import</span> <span class="include">spock.lang.Shared</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>
<span class="keyword">import</span> <span class="include">spock.lang.IgnoreIf</span>

<span class="annotation">@IgnoreIf</span>( { <span class="predefined-type">System</span>.getenv(<span class="string"><span class="delimiter">'</span><span class="content">TRAVIS</span><span class="delimiter">'</span></span>) <span class="keyword">as</span> <span class="type">boolean</span> } )
<span class="annotation">@Integration</span>
<span class="type">class</span> <span class="class">PlanControllerSpec</span> <span class="directive">extends</span> Specification {
    PlanDataService planDataService
    UserDataService userDataService
    UserRoleDataService userRoleDataService
    UserService userService
    RoleDataService roleDataService

    <span class="annotation">@Shared</span>
    HttpClient client

    <span class="annotation">@OnceBefore</span>
    <span class="type">void</span> init() {
        <span class="predefined-type">String</span> baseUrl = <span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:</span><span class="inline"><span class="inline-delimiter">$</span>serverPort</span><span class="delimiter">&quot;</span></span>
        <span class="local-variable">this</span>.client  = HttpClient.create(baseUrl.toURL())
    }

    <span class="predefined-type">String</span> accessToken(<span class="predefined-type">String</span> u, <span class="predefined-type">String</span> p) {
        HttpRequest request = HttpRequest.POST(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/login</span><span class="delimiter">&quot;</span></span>, [<span class="key">username</span>: u, <span class="key">password</span>: p])
        HttpResponse&lt;<span class="predefined-type">Map</span>&gt; resp = client.toBlocking().exchange(request, <span class="predefined-type">Map</span>)
        <span class="keyword">if</span> ( resp.status == HttpStatus.OK) {
            <span class="keyword">return</span> resp.body().access_token
        }
        <span class="predefined-constant">null</span>
    }

    <span class="keyword">def</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Plans for current logged user are retrieved</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">given</span>:
        User vector = userService.save(<span class="string"><span class="delimiter">'</span><span class="content">vector</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">secret</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">ROLE_VILLAIN</span><span class="delimiter">'</span></span>)
        User gru = userService.save(<span class="string"><span class="delimiter">'</span><span class="content">gru</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">secret</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">ROLE_VILLAIN</span><span class="delimiter">'</span></span>)
        Tenants.withId(<span class="string"><span class="delimiter">&quot;</span><span class="content">gru</span><span class="delimiter">&quot;</span></span>) { <i class="conum" data-value="1"></i><b>(1)</b>
            planDataService.save(<span class="string"><span class="delimiter">'</span><span class="content">Steal the Moon</span><span class="delimiter">'</span></span>)
        }
        Tenants.withId(<span class="string"><span class="delimiter">&quot;</span><span class="content">vector</span><span class="delimiter">&quot;</span></span>) {
            planDataService.save(<span class="string"><span class="delimiter">'</span><span class="content">Steal a Pyramid</span><span class="delimiter">'</span></span>)
        }

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">login with the gru</span><span class="delimiter">'</span></span>
        <span class="predefined-type">String</span> gruAccessToken = accessToken(<span class="string"><span class="delimiter">'</span><span class="content">gru</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">secret</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>:
        gruAccessToken

        <span class="key">when</span>:
        HttpRequest request = HttpRequest.GET(<span class="string"><span class="delimiter">&quot;</span><span class="content">/plan</span><span class="delimiter">&quot;</span></span>).bearerAuth(gruAccessToken)
        HttpResponse&lt;<span class="predefined-type">Map</span>&gt; resp = client.toBlocking().exchange(request, <span class="predefined-type">Map</span>)

        <span class="key">then</span>:
        resp.status == HttpStatus.OK
        resp.body().toString() == <span class="string"><span class="delimiter">'</span><span class="content">[{&quot;title&quot;:&quot;Steal the Moon&quot;}]</span><span class="delimiter">'</span></span>

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">login with the vector</span><span class="delimiter">'</span></span>
        <span class="predefined-type">String</span> vectorAccessToken = accessToken(<span class="string"><span class="delimiter">'</span><span class="content">vector</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">secret</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>:
        vectorAccessToken

        <span class="key">when</span>:
        request = HttpRequest.GET(<span class="string"><span class="delimiter">&quot;</span><span class="content">/plan</span><span class="delimiter">&quot;</span></span>).bearerAuth(vectorAccessToken)
        resp = client.toBlocking().exchange(request, <span class="predefined-type">Map</span>)

        <span class="key">then</span>:
        resp.status == HttpStatus.OK
        resp.body().toString() == <span class="string"><span class="delimiter">'</span><span class="content">[{&quot;title&quot;:&quot;Steal a Pyramid&quot;}]</span><span class="delimiter">'</span></span>

        <span class="key">cleanup</span>:
        Tenants.withId(<span class="string"><span class="delimiter">&quot;</span><span class="content">gru</span><span class="delimiter">&quot;</span></span>) { <i class="conum" data-value="1"></i><b>(1)</b>
            planDataService.deleteByTitle(<span class="string"><span class="delimiter">'</span><span class="content">Steal the Moon</span><span class="delimiter">'</span></span>)
        }
        Tenants.withId(<span class="string"><span class="delimiter">&quot;</span><span class="content">vector</span><span class="delimiter">&quot;</span></span>) {
            planDataService.deleteByTitle(<span class="string"><span class="delimiter">'</span><span class="content">Steal the Pyramid</span><span class="delimiter">'</span></span>)
        }
        userRoleDataService.deleteByUser(gru)
        userDataService.delete(gru.id)
        userRoleDataService.deleteByUser(vector)
        userDataService.delete(vector.id)
        roleDataService.deleteByAuthority(<span class="string"><span class="delimiter">'</span><span class="content">ROLE_VILLAIN</span><span class="delimiter">'</span></span>)
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You can use a specific tenant id using the withId method</td>
</tr>
</table>
</div>


<h1 id="runTests">4 Run the tests</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-custom-security-tenant-resolver/edit/master/src/main/docs/guide/runTests.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To run the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./grailsw
grails&gt; test-app
grails&gt; open test-report</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./gradlew check
open build/reports/tests/index.html</code></pre>
</div>
</div>


<h1 id="helpWithGrails">5 Help with Grails</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-custom-security-tenant-resolver/edit/master/src/main/docs/guide/helpWithGrails.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<h3 style="color: #333;">OCI sponsored the creation of this Guide. OCI offers several <a href="https://objectcomputing.com/products/grails/consulting-support/">Grails services</a>:</h3>

<img src="../img/oci-grails-services.svg"/>

<h3>Free consultation </h3>

<!-- This is the code that is needed to run the form -->

<!--Copy and paste into the document's head or body.-->

<script type="text/javascript">

    /** This section is only needed once per page if manually copying **/
    if (typeof MauticSDKLoaded == 'undefined') {
        var MauticSDKLoaded = true;
        var head            = document.getElementsByTagName('head')[0];
        var script          = document.createElement('script');
        script.type         = 'text/javascript';
        script.src          = 'https://mautic.objectcomputing.com/media/js/mautic-form.js';
        script.onload       = function() {
            MauticSDK.onLoad();
        };
        head.appendChild(script);
        var MauticDomain = 'https://mautic.objectcomputing.com';
        var MauticLang   = {
            'submittingMessage': "Please wait..."
        }
    }
</script>

<!--Copy and paste into the document's body.-->

<style type="text/css" scoped>
    .mauticform_wrapper { max-width: 600px; margin: 10px auto; }
    .mauticform-innerform {}
    .mauticform-post-success {}
    .mauticform-name { font-weight: bold; font-size: 1.5em; margin-bottom: 3px; }
    .mauticform-description { margin-top: 2px; margin-bottom: 10px; }
    .mauticform-error { margin-bottom: 10px; color: red; }
    .mauticform-message { margin-bottom: 10px;color: green; }
    .mauticform-row { display: block; margin-bottom: 20px; }
    .mauticform-label { font-size: 1.1em; display: block; font-weight: bold; margin-bottom: 5px; }
    .mauticform-row.mauticform-required .mauticform-label:after { color: #e32; content: " *"; display: inline; }
    .mauticform-helpmessage { display: block; font-size: 0.9em; margin-bottom: 3px; }
    .mauticform-errormsg { display: block; color: red; margin-top: 2px; }
    .mauticform-selectbox, .mauticform-input, .mauticform-textarea { width: 100%; padding: 0.5em 0.5em; border: 1px solid #CCC; background: #fff; box-shadow: 0px 0px 0px #fff inset; border-radius: 4px; box-sizing: border-box; }
    .mauticform-checkboxgrp-row {}
    .mauticform-checkboxgrp-label { font-weight: normal; }
    .mauticform-checkboxgrp-checkbox {}
    .mauticform-radiogrp-row {}
    .mauticform-radiogrp-label { font-weight: normal; }
    .mauticform-radiogrp-radio {}
    .mauticform-button-wrapper .mauticform-button.btn-default, .mauticform-pagebreak-wrapper .mauticform-pagebreak.btn-default { font-size: 14px; color: #fff;background-color: #feb672 ;border-color: #dddddd; padding: 15px 30px;}
    .mauticform-button-wrapper .mauticform-button, .mauticform-pagebreak-wrapper .mauticform-pagebreak { display: inline-block;margin-bottom: 0;font-weight: 600;text-align: center;vertical-align: middle;cursor: pointer;background-image: none;border: 1px solid transparent;white-space: nowrap;padding: 6px 12px;font-size: 13px;line-height: 1.3856;border-radius: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;}
    .mauticform-button-wrapper .mauticform-button.btn-default[disabled], .mauticform-pagebreak-wrapper .mauticform-pagebreak.btn-default[disabled] { background-color:#feb672; border-color: #dddddd; opacity: 0.75; cursor: not-allowed; font-size: 14px; color: #fff; padding: 15px 30px;}
    .mauticform-pagebreak-wrapper .mauticform-button-wrapper {  display: inline; }
</style>
<div id="mauticform_wrapper_grailsorgconsultationform" class="mauticform_wrapper">
    <form autocomplete="false" role="form" method="post" action="https://mautic.objectcomputing.com/form/submit?formId=3" id="mauticform_grailsorgconsultationform" data-mautic-form="grailsorgconsultationform">

        <div class="mauticform-innerform">

          <div class="mauticform-page-wrapper mauticform-page-1" data-mautic-form-page="1">

            <div id="mauticform_grailsorgconsultationform_first_name"  data-validate="first_name" data-validation-type="text" class="mauticform-row mauticform-text mauticform-field-1 mauticform-required col-lg-6 col-md-6 col-sm-12 col-xs-12">
                <input id="mauticform_input_grailsorgconsultationform_first_name" name="mauticform[first_name]" value="" placeholder="First Name *" class="mauticform-input" type="text" />
                <span class="mauticform-errormsg" style="display: none;">This is required.</span>
            </div>

            <div id="mauticform_grailsorgconsultationform_last_name"  data-validate="last_name" data-validation-type="text" class="mauticform-row mauticform-text mauticform-field-2 mauticform-required col-lg-6 col-md-6 col-sm-12 col-xs-12">
                <input id="mauticform_input_grailsorgconsultationform_last_name" name="mauticform[last_name]" value="" placeholder="Last Name *" class="mauticform-input" type="text" />
                <span class="mauticform-errormsg" style="display: none;">This is required.</span>
            </div>

            <div id="mauticform_grailsorgconsultationform_email"  data-validate="email" data-validation-type="email" class="mauticform-row mauticform-email mauticform-field-3 mauticform-required col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <input id="mauticform_input_grailsorgconsultationform_email" name="mauticform[email]" value="" placeholder="Email *" class="mauticform-input" type="email" />
                <span class="mauticform-errormsg" style="display: none;">This is required.</span>
            </div>

            <div id="mauticform_grailsorgconsultationform_phone"  class="mauticform-row mauticform-tel mauticform-field-4 col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <input id="mauticform_input_grailsorgconsultationform_phone" name="mauticform[phone]" value="" placeholder="Phone" class="mauticform-input" type="tel" />
                <span class="mauticform-errormsg" style="display: none;"></span>
            </div>

            <div id="mauticform_grailsorgconsultationform_company"  class="mauticform-row mauticform-text mauticform-field-5 col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <input id="mauticform_input_grailsorgconsultationform_company" name="mauticform[company]" value="" placeholder="Company" class="mauticform-input" type="text" />
                <span class="mauticform-errormsg" style="display: none;"></span>
            </div>

            <div id="mauticform_grailsorgconsultationform_submit"  class="mauticform-row mauticform-button-wrapper mauticform-field-6" style="">
                <button type="submit" name="mauticform[submit]" id="mauticform_input_grailsorgconsultationform_submit" name="mauticform[submit]" value="" class="mauticform-button btn btn-default" value="1" style="border: none; margin-left: 14px;">SUBMIT</button>
            </div>
            </div>
        </div>

        <input type="hidden" name="mauticform[formId]" id="mauticform_grailsorgconsultationform_id" value="3"/>
        <input type="hidden" name="mauticform[return]" id="mauticform_grailsorgconsultationform_return" value=""/>
        <input type="hidden" name="mauticform[formName]" id="mauticform_grailsorgconsultationform_name" value="grailsorgconsultationform"/>
</form>
</div>

<!--The code below is the message that appears when someone hits submit. Feel free to style this how you see fit for Grails.org. All CSS is handled in the above code.-->

<div class="mauticform-error" id="mauticform_grailsorgconsultationform_error"></div>
<div class="mauticform-message" id="mauticform_grailsorgconsultationform_message"></div>

<h3 style="color: #333;">The <a href="https://objectcomputing.com/products/grails/consulting-support/">OCI Grails Team</a>
includes Grails co-founders, <b>Jeff Scott Brown and Graeme Rocher</b>.
Check our <a href="https://objectcomputing.com/training/catalog/grails/">Grails courses</a> and learn from the engineers who developed,
matured and maintain Grails.</h3>

<img src="../img/ocigrailsteam.png" style="max-width: 748px; width: 100%;" alt="Grails OCI Team">

</article></div><footer>
  <div class='content'>
    <div class='ocihometograils'>
      <span>Sponsored by</span>
      <a href='https://objectcomputing.com/products/grails/'><img class='' src='/images/oci_home_to_grails.svg' alt='Object Computing - Home to Grails' width='300px' /></a>
    </div>
    <nav class='socialmedianav'><ul>
  <li>
    <a href='https://grails-slack.cfapps.io'><img class='' src='/images/slack.svg' alt='Slack Icon' /></a>
  </li>
  <li>
    <a href='https://www.youtube.com/watch?v=XnRNfDGkBVg&amp;list=PLI74De5M9T73uH3WilDCePP2qfSDpMaGu'><img class='' src='/images/youtube.svg' alt='Youtube Icon' /></a>
  </li>
  <li>
    <a href='https://www.linkedin.com/groups/39757'><img class='' src='/images/linkedin.svg' alt='LinkedIn Icon' /></a>
  </li>
  <li>
    <a href='https://github.com/grails/'><img class='' src='/images/github.svg' alt='Github Icon' /></a>
  </li>
  <li>
    <a href='https://twitter.com/grailsframework'><img class='' src='/images/twitter.svg' alt='Twitter Icon' /></a>
  </li>
</ul></nav>
    <nav class='partnersnav'><ul>
  <li>Grails' repositories are hosted by
    <a href='http://artifactoryonline.com/'>Artifactory</a>
  </li>
  <li>Website hosting provided by
    <a href='http://run.pivotal.io/'>Pivotal</a>
  </li>
  <li>YourKit supports Grails with its 
    <a href='https://www.yourkit.com/java/profiler/index.jsp'>Java Profiler</a>
  </li>
  <li>Grails is Open Source
    <a href='http://www.apache.org/licenses/LICENSE-2.0.html'>Apache 2 License</a>
  </li>
  <li>
    <a href='https://grails.org/buildstatus.html'>Build Status</a>
  </li>
</ul></nav>
  </div>
</footer><div>
  <script type='text/javascript'>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-82213539-2', 'auto');
              ga('send', 'pageview');
</script>
  <script type='text/javascript'>
adroll_adv_id = "HBWJH4CQCJGS5DJRSB4Z4D";
adroll_pix_id = "IVEQYFOZXZAPZMDVQH7BFE";
/* OPTIONAL: provide email to improve user identification */
/* adroll_email = "username@example.com"; */
(function () {
    var _onload = function(){
        if (document.readyState && !/loaded|complete/.test(document.readyState)){setTimeout(_onload, 10);return}
        if (!window.__adroll_loaded){__adroll_loaded=true;setTimeout(_onload, 50);return}
        var scr = document.createElement("script");
        var host = (("https:" == document.location.protocol) ? "https://s.adroll.com" : "http://a.adroll.com");
        scr.setAttribute('async', 'true');
        scr.type = "text/javascript";
        scr.src = host + "/j/roundtrip.js";
        ((document.getElementsByTagName('head') || [null])[0] ||
            document.getElementsByTagName('script')[0].parentNode).appendChild(scr);
    };
    if (window.addEventListener) {window.addEventListener('load', _onload, false);}
    else {window.attachEvent('onload', _onload)}
}());            
</script>
</div></body>
</html>