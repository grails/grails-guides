<!DOCTYPE html>
<html>
  <head>
    <meta name='google-site-verification' content='REYQ1_I6HGowAE7LOLVqfQbnKaB4IfFpMlGzMbJj55Q' />
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <link rel='icon' href='/images/favicon.ico' />
    <link rel='mask-icon' href='//images/grails-pinned-icon.svg' color='feb672' />
    <meta charset='UTF-8' />
    <title>Send Email and Spock Spring | Grails Guides | Grails Framework</title>
    <meta name='description' content='Send Email and Spock Spring. Learn how to send emails with AWS SES and SendGrid from a Grails app and leverage Spock Spring integration to verify interaction.' />
    <link rel='stylesheet' href='../css/main.css' />
    <link rel='stylesheet' href='../css/screen.css' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js'></script>
  </head>
  <body class='guide'><header class='mainheader'>
  <div class='content'>
    <a href='https://grails.org/index.html'><img class='grailslogo' src='/images/grails_logo.svg' alt='Grails Logo' /></a>
    <a href='javascript:show(&apos;topmenus&apos;, &apos;showNavigationLink&apos;)' id='showNavigationLink' class='mobile align-center'>Show Navigation</a>
    <div id='topmenus'>
      <nav class='secondarymenu' id='secondarymenu'><ul>
  <li>
    <a href='https://grails.org/learning.html'>Learning</a>
  </li>
  <li>
    <a href='https://grails.org/community.html'>Community</a>
  </li>
  <li>
    <a href='https://grails.org/search.html'>Search</a>
  </li>
</ul></nav>
      <nav class='mainmenu' id='mainmenu'><ul>
  <li>
    <a href='https://grails.org/documentation.html'>Documentation</a>
  </li>
  <li>
    <a href='https://grails.org/download.html'>Download</a>
  </li>
  <li>
    <a href='https://plugins.grails.org'>Plugins</a>
  </li>
  <li>
    <a href='https://guides.grails.org/index.html'>Guides</a>
  </li>
  <li>
    <a href='https://grails.org/faq.html'>FAQ</a>
  </li>
  <li>
    <a href='https://grails.org/support.html'>Support</a>
  </li>
</ul></nav>
    </div>
  </div>
</header><div class='fullwidth'><article class="guide">
    <aside>
        <a href="https://travis-ci.org/grails-guides/grails-email"><img src="https://travis-ci.org/grails-guides/grails-email.svg?branch=master"></a>

        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/grails-guides/grails-email&quot;"><img height="15" src="../img/github_white.svg" alt="Github"/><span>&nbsp;Get the Code</span></button>


        <ul class="githublinks">
            <li><button type="button" class="btn btn-default" href="#" onclick="document.getElementById('github-url').value='git@github.com:grails-guides/grails-email.git'" class="codeButton">SSH</button></li>
            <li><button type="button" class="btn btn-default" onclick="document.getElementById('github-url').value='https://github.com/grails-guides/grails-email.git'" class="codeButton">HTTPS</button></li>
        </ul>
        <div class="input-group">
            <!-- Target -->
            <input id="github-url" value="git@github.com:grails-guides/grails-email.git" type="text" />
            <!-- Trigger -->
            <button type="button" class="clippy btn btn-default" type="button" data-clipboard-target="#github-url">
                <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
            </button>
        </div>
        <script>var clipboard = new Clipboard('.clippy');</script>
        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/grails-guides/grails-email/archive/master.zip&quot;">Download ZIP</button>
        
        <div id="table-of-content">
            <h3>Table of Contents</h3>
            
            <div class="toc-item" style="margin-left:0px"><a href="#gettingStarted"><strong>1</strong><span>Getting Started</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#requirements"><strong>1.1</strong><span>What you will need</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#howto"><strong>1.2</strong><span>How to complete the guide</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#writingTheApp"><strong>2</strong><span>Writing the App</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#controller"><strong>2.1</strong><span>Controller</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#services"><strong>2.2</strong><span>Email Service</span></a></div>
            
            <div class="toc-item" style="margin-left:20px"><a href="#awsSesService"><strong>2.2.1</strong><span>AWS SES</span></a></div>
            
            <div class="toc-item" style="margin-left:20px"><a href="#sendGridService"><strong>2.2.2</strong><span>SendGrid</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#resources"><strong>2.3</strong><span>Resources</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#test"><strong>2.4</strong><span>Test</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#helpWithGrails"><strong>3</strong><span>Do you need help with Grails?</span></a></div>
            
            <div style="clear:both" ></div>
        </div>
        
    </aside>
    <header>
        <h1>Send Email and Spock Spring</h1>
        <p>Learn how to send emails with AWS SES and SendGrid from a Grails app and leverage Spock Spring integration to verify interaction.</p>
        <p><strong>Authors:</strong> Sergio del Amo</p>
        <p><strong>Grails Version:</strong> 4.0.1</p>
    </header>
    

<h1 id="gettingStarted">1 Getting Started</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-email/edit/master/src/main/docs/guide/gettingStarted.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>





<h2 id="requirements">1.1 What you will need</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-email/edit/master/src/main/docs/guide/requirements.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 1.8 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
</ul>
</div>


<h2 id="howto">1.2 How to complete the guide</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-email/edit/master/src/main/docs/guide/howto.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To get started do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/grails-guides/grails-email/archive/master.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone the <a href="https://git-scm.com/">Git</a> repository:<br>
<code>git clone <a href="https://github.com/grails-guides/grails-email.git" class="bare">https://github.com/grails-guides/grails-email.git</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Grails guides repositories contain two folders:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>initial</code>  Initial project. Often a simple Grails app with some additional code to give you a head-start.</p>
</li>
<li>
<p><code>complete</code> A completed example. It is the result of working through the steps presented by the guide and applying those changes to the <code>initial</code> folder.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To complete the guide, go to the <code>initial</code> folder</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cd</code> into <code>grails-guides/grails-email/initial</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>and follow the instructions in the next sections.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can go right to the <strong>completed example</strong> if you <code>cd</code> into <code>grails-guides/grails-email/complete</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you want to start from scratch, create a new Grails 3 application using
<a href="http://start.grails.org/">Grails Application Forge</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/forgeDefault.png" alt="forgeDefault">
</div>
</div>


<h1 id="writingTheApp">2 Writing the App</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-email/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create an app with the <code>rest-api</code> profile</p>
</div>
<div class="paragraph">
<p><code>grails create-app example --profile=rest-api</code></p>
</div>


<h2 id="controller">2.1 Controller</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-email/edit/master/src/main/docs/guide/writingTheApp/controller.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Add an entry to <code>UrlMappings</code>:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/example/grails/UrlMappings.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.grails

<span class="type">class</span> <span class="class">UrlMappings</span> {

    <span class="directive">static</span> mappings = {
    ...
    ..
    .
        post <span class="string"><span class="delimiter">&quot;</span><span class="content">/mail/send</span><span class="delimiter">&quot;</span></span>(<span class="key">controller</span>: <span class="string"><span class="delimiter">'</span><span class="content">mail</span><span class="delimiter">'</span></span>, <span class="key">action</span>: <span class="string"><span class="delimiter">'</span><span class="content">send</span><span class="delimiter">'</span></span>)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create <code>MailController</code> which use a collaborator, <code>emailService</code> to send and email.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/example/grails/MailController.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.grails

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">groovy.util.logging.Slf4j</span>

<span class="annotation">@Slf4j</span>
<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">MailController</span> {

    EmailService emailService

    <span class="directive">static</span> allowedMethods = [<span class="key">send</span>: <span class="string"><span class="delimiter">'</span><span class="content">POST</span><span class="delimiter">'</span></span>]

    <span class="keyword">def</span> <span class="function">send</span>(EmailCmd cmd) {
        <span class="keyword">if</span> ( cmd.hasErrors() ) {
            render <span class="key">status</span>: <span class="integer">422</span>
            <span class="keyword">return</span>
        }
        log.info <span class="string"><span class="delimiter">'</span><span class="content">{}</span><span class="delimiter">'</span></span>, cmd.toString()
        emailService.send(cmd)
        render <span class="key">status</span>: <span class="integer">200</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The previous controller uses a <a href="http://docs.grails.org/snapshot/guide/single.html#commandObjects">command object</a>:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/example/grails/EmailCmd.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.grails

<span class="keyword">import</span> <span class="include">grails.compiler.GrailsCompileStatic</span>
<span class="keyword">import</span> <span class="include">grails.validation.Validateable</span>
<span class="keyword">import</span> <span class="include">groovy.transform.ToString</span>

<span class="annotation">@ToString</span>
<span class="annotation">@GrailsCompileStatic</span>
<span class="type">class</span> <span class="class">EmailCmd</span> <span class="directive">implements</span> Validateable, Email {
    <span class="predefined-type">String</span> recipient
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; cc = <span class="type">[]</span>
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; bcc = <span class="type">[]</span>
    <span class="predefined-type">String</span> subject
    <span class="predefined-type">String</span> htmlBody
    <span class="predefined-type">String</span> textBody
    <span class="predefined-type">String</span> replyTo

    <span class="directive">static</span> constraints = {
        recipient <span class="key">nullable</span>: <span class="predefined-constant">false</span> <i class="conum" data-value="1"></i><b>(1)</b>
        subject <span class="key">nullable</span>: <span class="predefined-constant">false</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        htmlBody <span class="key">nullable</span>: <span class="predefined-constant">true</span>
        textBody <span class="key">nullable</span>: <span class="predefined-constant">true</span>, <span class="key">validator</span>: { <span class="predefined-type">String</span> val, EmailCmd obj -&gt;  <i class="conum" data-value="3"></i><b>(3)</b>
            !(!obj.htmlBody &amp;&amp; !val)
        }
        replyTo <span class="key">nullable</span>: <span class="predefined-constant">true</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>recipient</code> is required</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>subject</code> is required</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>You must specify either <code>textBody</code> or <code>htmlBody</code></td>
</tr>
</table>
</div>


<h2 id="services">2.2 Email Service</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-email/edit/master/src/main/docs/guide/writingTheApp/services.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create an interface - <code>EmailService</code>. Any email integration present in the application should implement it.</p>
</div>
<div class="listingblock">
<div class="title">src/groovy/main/example/grails/EmailService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.grails

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="type">interface</span> EmailService {
    <span class="type">void</span> send(Email email)
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/groovy/main/example/grails/Email.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.grails

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="type">interface</span> Email {
    <span class="predefined-type">String</span> getRecipient()
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getCc()
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getBcc()
    <span class="predefined-type">String</span> getSubject()
    <span class="predefined-type">String</span> getHtmlBody()
    <span class="predefined-type">String</span> getTextBody()
    <span class="predefined-type">String</span> getReplyTo()
}</code></pre>
</div>
</div>


<h2 id="awsSesService">2.2.1 AWS SES</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-email/edit/master/src/main/docs/guide/writingTheApp/services/awsSesService.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Amazon Simple Email Service (Amazon SES) is a cloud-based email sending service designed to help digital marketers and application developers send marketing, notification, and transactional emails. It is a reliable, cost-effective service for businesses of all sizes that use email to keep in contact with their customers.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>There is a <a href="http://plugins.grails.org/plugin/agorapulse/aws-sdk-ses">AWS SDK SES Grails plugin</a>. However, in this guide we are going to integrate AWS SDK SES directly.</p>
</div>
<div class="paragraph">
<p>Add a dependency to AWS SES SDK:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">    compile <span class="string"><span class="delimiter">'</span><span class="content">software.amazon.awssdk:ses:2.10.24</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, add configuration properties which can be passed via system properties / command line arguments:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">aws</span>:
    <span class="key">ses</span>:
        <span class="key">source</span>: <span class="string"><span class="delimiter">'</span><span class="content">${AWS_SOURCE}</span><span class="delimiter">'</span></span>
        <span class="key">region</span>: <span class="string"><span class="delimiter">'</span><span class="content">${AWS_REGION}</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Create one service which encapsulates the integration with SES. There are several way to provide programmatic credentials.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The client searches for credentials using the default credentials provider chain, in the following order:</p>
</div>
<div class="paragraph">
<p>In the Java system properties: aws.accessKeyId and aws.secretKey.</p>
</div>
<div class="paragraph">
<p>In system environment variables: AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY.</p>
</div>
<div class="paragraph">
<p>In the default credentials file (the location of this file varies by platform).</p>
</div>
<div class="paragraph">
<p>In the Amazon ECS environment variable: AWS_CONTAINER_CREDENTIALS_RELATIVE_URI.</p>
</div>
<div class="paragraph">
<p>In the instance profile credentials, which exist within the instance metadata associated with the IAM role for the EC2 instance.</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="title">grails-app/services/example/grails/AwsSesMailService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.grails

<span class="keyword">import</span> <span class="include">grails.config.Config</span>
<span class="keyword">import</span> <span class="include">grails.core.support.GrailsConfigurationAware</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">groovy.util.logging.Slf4j</span>
<span class="keyword">import</span> <span class="include">software.amazon.awssdk.regions.Region</span>
<span class="keyword">import</span> <span class="include">software.amazon.awssdk.services.ses.SesClient</span>
<span class="keyword">import</span> <span class="include">software.amazon.awssdk.services.ses.model.Body</span>
<span class="keyword">import</span> <span class="include">software.amazon.awssdk.services.ses.model.Content</span>
<span class="keyword">import</span> <span class="include">software.amazon.awssdk.services.ses.model.Destination</span>
<span class="keyword">import</span> <span class="include">software.amazon.awssdk.services.ses.model.Message</span>
<span class="keyword">import</span> <span class="include">software.amazon.awssdk.services.ses.model.SendEmailRequest</span>
<span class="keyword">import</span> <span class="include">software.amazon.awssdk.services.ses.model.SendEmailResponse</span>

<span class="annotation">@Slf4j</span>
<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">AwsSesMailService</span> <span class="directive">implements</span> EmailService, GrailsConfigurationAware {  <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="predefined-type">String</span> sourceEmail

    SesClient sesClient

    <span class="annotation">@Override</span>
    <span class="type">void</span> setConfiguration(Config co) {

        <span class="predefined-type">String</span> awsRegion = co.getProperty(<span class="string"><span class="delimiter">'</span><span class="content">aws.ses.region</span><span class="delimiter">'</span></span>)
        <span class="keyword">if</span> (!awsRegion) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">'</span><span class="content">aws.ses.region not set</span><span class="delimiter">'</span></span>)
        }
        <span class="local-variable">this</span>.sesClient = SesClient.builder().region(<span class="predefined-type">Region</span>.of(awsRegion)).build();

        <span class="local-variable">this</span>.sourceEmail = co.getProperty(<span class="string"><span class="delimiter">'</span><span class="content">aws.ses.source</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>)
        <span class="keyword">if</span> (!<span class="local-variable">this</span>.sourceEmail) {
            log.warn(<span class="string"><span class="delimiter">'</span><span class="content">aws.sourceEmail not set</span><span class="delimiter">'</span></span>)
        }
    }

    <span class="directive">private</span> Body bodyOfEmail(Email email) {
        <span class="keyword">if</span> (email.htmlBody) {
            Content htmlBody = Content.builder().data(email.htmlBody).build()
            <span class="keyword">return</span> Body.builder().html(htmlBody).build()
        }
        <span class="keyword">if</span> (email.textBody) {
            Content textBody = Content.builder().data(email.textBody).build()
            <span class="keyword">return</span> Body.builder().text(textBody).build()
        }
        Body.builder().build()
    }

    <span class="directive">private</span> <span class="predefined-type">Destination</span> destination(Email email) {
        <span class="predefined-type">Destination</span>.Builder destinationBuilder = <span class="predefined-type">Destination</span>.builder().toAddresses(email.recipient)
        <span class="keyword">if</span> ( email.getCc() ) {
            destinationBuilder = destinationBuilder.ccAddresses(email.getCc())
        }
        <span class="keyword">if</span> ( email.getBcc() ) {
            destinationBuilder = destinationBuilder.bccAddresses(email.getBcc())
        }
        destinationBuilder.build()
    }

    <span class="directive">private</span> Message composeMessage(Email email) {
        Content subject = Content.builder().data(email.getSubject()).build()
        Body body = bodyOfEmail(email)
        Message.builder().subject(subject).body(body).build()
    }

    <span class="annotation">@Override</span>
     <span class="type">void</span> send(Email email) {
        <span class="keyword">try</span> {
            <span class="predefined-type">Destination</span> destination = destination(email)
            Message message = composeMessage(email)
            SendEmailRequest sendEmailRequest = SendEmailRequest.builder()
                    .source(sourceEmail)
                    .destination(destination)
                    .message(message)
                    .build()
            SendEmailResponse response = sesClient.sendEmail(sendEmailRequest)
            log.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">Email sent! {}</span><span class="delimiter">&quot;</span></span>, response.messageId())

        } <span class="keyword">catch</span> (<span class="exception">Exception</span> ex) {
            log.warn(<span class="string"><span class="delimiter">&quot;</span><span class="content">The email was not sent.</span><span class="delimiter">&quot;</span></span>)
            log.warn(<span class="string"><span class="delimiter">&quot;</span><span class="content">Error message: {}</span><span class="delimiter">&quot;</span></span>, ex.message)
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="http://grailsblog.objectcomputing.com/posts/2016/08/31/retrieving-config-values.html">Retrieve configuration values</a> with <code>GrailsConfigurationAware</code></td>
</tr>
</table>
</div>


<h2 id="sendGridService">2.2.2 SendGrid</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-email/edit/master/src/main/docs/guide/writingTheApp/services/sendGridService.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p><a href="http://sendgrid.com">SendGrid</a> is a transactional email service.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>SendGrid is responsible for sending billions of emails for some of the best and brightest companies in the world.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>There is a <a href="http://plugins.grails.org/plugin/desirable-objects/grails-sendgrid">SendGrid Grails Plugin</a>. However, in this guide we are going to integrate AWS SDK SES directly.</p>
</div>
<div class="paragraph">
<p>Add a dependency to SendGrid SDK:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">    compile <span class="string"><span class="delimiter">'</span><span class="content">com.sendgrid:sendgrid-java:4.1.2</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Add configuration properties which can be passed via system properties / command line arguments:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">sendgrid</span>:
    <span class="key">api</span>: <span class="string"><span class="delimiter">'</span><span class="content">${SENDGRID_APIKEY}</span><span class="delimiter">'</span></span>
    <span class="key">from</span>: <span class="string"><span class="delimiter">'</span><span class="content">${SENDGRID_FROM_EMAIL}</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a service which encapsulates the integration with SendGrid:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/example/grails/SendGridEmailService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.grails

<span class="keyword">import</span> <span class="include">com.sendgrid.Personalization</span>
<span class="keyword">import</span> <span class="include">com.sendgrid.Content</span>
<span class="keyword">import</span> <span class="include">com.sendgrid.Mail</span>
<span class="keyword">import</span> <span class="include">com.sendgrid.SendGrid</span>
<span class="keyword">import</span> <span class="include">com.sendgrid.Request</span>
<span class="keyword">import</span> <span class="include">com.sendgrid.Response</span>
<span class="keyword">import</span> <span class="include">com.sendgrid.Method</span>
<span class="keyword">import</span> <span class="include">grails.config.Config</span>
<span class="keyword">import</span> <span class="include">grails.core.support.GrailsConfigurationAware</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">groovy.util.logging.Slf4j</span>

<span class="annotation">@Slf4j</span>
<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">SendGridEmailService</span> <span class="directive">implements</span> EmailService, GrailsConfigurationAware {  <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="predefined-type">String</span> api

    <span class="predefined-type">String</span> from

    <span class="annotation">@Override</span>
    <span class="type">void</span> setConfiguration(Config co) {
        <span class="local-variable">this</span>.api = co.getProperty(<span class="string"><span class="delimiter">'</span><span class="content">sendgrid.api</span><span class="delimiter">'</span></span>, <span class="predefined-type">String</span>)
        <span class="keyword">if</span> (!<span class="local-variable">this</span>.api) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">'</span><span class="content">sendgrid.api not set</span><span class="delimiter">'</span></span>)
        }
        <span class="local-variable">this</span>.from = co.getProperty(<span class="string"><span class="delimiter">'</span><span class="content">sendgrid.from</span><span class="delimiter">'</span></span>, <span class="predefined-type">String</span>)
        <span class="keyword">if</span> (!<span class="local-variable">this</span>.from) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">'</span><span class="content">sendgrid.apiKey not set</span><span class="delimiter">'</span></span>)
        }
    }

    <span class="annotation">@Override</span>
    <span class="type">void</span> send(Email email) {
        Mail mail = buildEmail(email)
        SendGrid sg = <span class="keyword">new</span> SendGrid(api)
        Request request = <span class="keyword">new</span> Request()
        <span class="keyword">try</span> {
            request.with {
                method = <span class="predefined-type">Method</span>.POST
                endpoint = <span class="string"><span class="delimiter">&quot;</span><span class="content">mail/send</span><span class="delimiter">&quot;</span></span>
                body = mail.build()
            }
            Response response = sg.api(request)
            log.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">Status Code: {}</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.valueOf(response.getStatusCode()))
            log.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">Body: {}</span><span class="delimiter">&quot;</span></span>, response.getBody())
            <span class="keyword">if</span> ( log.infoEnabled ) {
                response.getHeaders().each { <span class="predefined-type">String</span> k, <span class="predefined-type">String</span> v -&gt;
                    log.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">Response Header {} =&gt; {}</span><span class="delimiter">&quot;</span></span>, k, v)
                }
            }

        } <span class="keyword">catch</span> (<span class="exception">IOException</span> ex) {
            log.error(ex.getMessage())
        }
    }

    <span class="directive">private</span> Content contentOfEmail(Email email) {
        <span class="keyword">if</span> ( email.textBody ) {
            <span class="keyword">return</span> <span class="keyword">new</span> Content(<span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>, email.textBody)
        }
        <span class="keyword">if</span> ( email.htmlBody ) {
            <span class="keyword">return</span> <span class="keyword">new</span> Content(<span class="string"><span class="delimiter">&quot;</span><span class="content">text/html</span><span class="delimiter">&quot;</span></span>, email.htmlBody)
        }
        <span class="keyword">return</span> <span class="predefined-constant">null</span>
    }

    <span class="directive">private</span> Personalization buildPersonalization(Email email) {
        Personalization personalization = <span class="keyword">new</span> Personalization()
        personalization.subject = email.subject

        com.sendgrid.Email to = <span class="keyword">new</span> com.sendgrid.Email(email.recipient)
        personalization.addTo(to)

        <span class="keyword">if</span> ( email.getCc() ) {
            <span class="keyword">for</span> ( <span class="predefined-type">String</span> cc : email.getCc() ) {
                com.sendgrid.Email ccEmail = <span class="keyword">new</span> com.sendgrid.Email()
                ccEmail.email = cc
                personalization.addCc(ccEmail)
            }
        }
        <span class="keyword">if</span> ( email.getBcc() ) {
            <span class="keyword">for</span> ( <span class="predefined-type">String</span> bcc : email.getBcc() ) {
                com.sendgrid.Email bccEmail = <span class="keyword">new</span> com.sendgrid.Email()
                bccEmail.email = bcc
                personalization.addBcc(bccEmail)
            }
        }
        personalization
    }

    <span class="directive">private</span> Mail buildEmail(Email email) {
        Personalization personalization = buildPersonalization(email)
        Mail mail = <span class="keyword">new</span> Mail()
        com.sendgrid.Email from = <span class="keyword">new</span> com.sendgrid.Email()
        from.email = from
        mail.from = from
        mail.addPersonalization(personalization)
        Content content = contentOfEmail(email)
        mail.addContent(content)
        mail
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="http://grailsblog.objectcomputing.com/posts/2016/08/31/retrieving-config-values.html">Retrieve configuration values</a> with <code>GrailsConfigurationAware</code></td>
</tr>
</table>
</div>


<h2 id="resources">2.3 Resources</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-email/edit/master/src/main/docs/guide/writingTheApp/resources.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Grails integrates with and builds on the <a href="http://spring.io/">Spring Framework</a>.</p>
</div>
<div class="paragraph">
<p>You can easily register new (or override existing) beans by configuring them in <code>grails-app/conf/spring/resources.groovy</code> which uses the <a href="http://docs.grails.org/snapshot/guide/single.html#springdsl">Grails Spring DSL</a>.</p>
</div>
<div class="paragraph">
<p>Depending on the presence of the required system properties we are going to enable SendGrid or AWS SES integration.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/spring/resources.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">example.grails.AwsSesMailService</span>
<span class="keyword">import</span> <span class="include">example.grails.SendGridEmailService</span>

beans = {
    <span class="keyword">if</span> ( <span class="predefined-type">System</span>.getProperty(<span class="string"><span class="delimiter">'</span><span class="content">SENDGRID_FROM_EMAIL</span><span class="delimiter">'</span></span>) &amp;&amp; <span class="predefined-type">System</span>.getProperty(<span class="string"><span class="delimiter">'</span><span class="content">SENDGRID_APIKEY</span><span class="delimiter">'</span></span>) ) {
        emailService(SendGridEmailService)
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="predefined-type">System</span>.getProperty(<span class="string"><span class="delimiter">'</span><span class="content">AWS_REGION</span><span class="delimiter">'</span></span>) &amp;&amp; <span class="predefined-type">System</span>.getProperty(<span class="string"><span class="delimiter">'</span><span class="content">AWS_SOURCE</span><span class="delimiter">'</span></span>)) {
        emailService(AwsSesMailService)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add a logger to get more visibility:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/logback.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">...
..
.
logger(<span class="string"><span class="delimiter">'</span><span class="content">example.grails</span><span class="delimiter">'</span></span>, INFO, [<span class="string"><span class="delimiter">'</span><span class="content">STDOUT</span><span class="delimiter">'</span></span>], <span class="predefined-constant">false</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use SendGrid, start the app with the necessary system properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ ./gradlew -DSENDGRID_FROM_EMAIL=email@email.com -DSENDGRID_APIKEY=XXXXXX bootRun</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use AWS SES, start the app with the necessary system properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ export AWS_ACCESS_KEY_ID=XXXXXXXX
$ export AWS_SECRET_ACCESS_KEY=XXXXXXXX
$ ./gradlew -DAWS_REGION=eu-west-1 -DAWS_SOURCE=email@email.com  bootRun</code></pre>
</div>
</div>


<h2 id="test">2.4 Test</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-email/edit/master/src/main/docs/guide/writingTheApp/test.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>In our acceptance test we don&#8217;t want bean <code>emailService</code> to be <code>SendGridEmailService</code> or <code>AwsSesMailService</code>. Instead we want it to be a Mock which we can verify interactions against.</p>
</div>
<div class="paragraph">
<p>The <code>spock-spring</code> module provides support for defining Spock mocks and stubs as Spring beans.</p>
</div>
<div class="paragraph">
<p>Add a dependency to <code>spock-spring</code>:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">    testCompile <span class="string"><span class="delimiter">'</span><span class="content">org.spockframework:spock-spring:1.3-groovy-2.5</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>First, you need to annotate <code>Application.groovy</code> with <code>@ComponentScan</code>.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/init/example/grails/Application.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.grails

<span class="keyword">import</span> <span class="include">grails.boot.GrailsApp</span>
<span class="keyword">import</span> <span class="include">grails.boot.config.GrailsAutoConfiguration</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">org.springframework.context.annotation.ComponentScan</span>

<span class="annotation">@ComponentScan</span>(<span class="string"><span class="delimiter">'</span><span class="content">example.grails</span><span class="delimiter">'</span></span>)
<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">Application</span> <span class="directive">extends</span> GrailsAutoConfiguration {
    <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        GrailsApp.run(Application, args)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the next test, we use an embedded config annotated with <code>@TestConfiguration</code>. We create an <code>EmailService</code> mock using a <code>DetachedMockFactory</code>.</p>
</div>
<div class="listingblock">
<div class="title">src/integration-test/groovy/example/grails/MailControllerSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.grails

<span class="keyword">import</span> <span class="include">grails.testing.mixin.integration.Integration</span>
<span class="keyword">import</span> <span class="include">grails.testing.spock.OnceBefore</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpStatus</span>
<span class="keyword">import</span> <span class="include">org.springframework.boot.test.context.TestConfiguration</span>
<span class="keyword">import</span> <span class="include">org.springframework.context.annotation.Bean</span>
<span class="keyword">import</span> <span class="include">spock.lang.Shared</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpRequest</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpResponse</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.HttpClient</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>
<span class="keyword">import</span> <span class="include">spock.mock.DetachedMockFactory</span>

<span class="annotation">@Integration</span>
<span class="type">class</span> <span class="class">MailControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="annotation">@Shared</span>
    HttpClient client

    EmailService emailService

    <span class="annotation">@OnceBefore</span>
    <span class="type">void</span> init() {
        <span class="predefined-type">String</span> baseUrl = <span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:</span><span class="inline"><span class="inline-delimiter">$</span>serverPort</span><span class="delimiter">&quot;</span></span>
        <span class="local-variable">this</span>.client  = HttpClient.create(baseUrl.toURL())
    }

    <span class="keyword">def</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/mail/send interacts once email service</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">when</span>:
        HttpRequest request = HttpRequest.POST(<span class="string"><span class="delimiter">'</span><span class="content">/mail/send</span><span class="delimiter">'</span></span>, [
                <span class="key">subject</span>: <span class="string"><span class="delimiter">'</span><span class="content">Test</span><span class="delimiter">'</span></span>,
                <span class="key">recipient</span>: <span class="string"><span class="delimiter">'</span><span class="content">delamos@grails.example</span><span class="delimiter">'</span></span>,
                <span class="key">textBody</span>: <span class="string"><span class="delimiter">'</span><span class="content">Hola hola</span><span class="delimiter">'</span></span>
        ])
        HttpResponse resp = client.toBlocking().exchange(request)

        <span class="key">then</span>:
        resp.status == HttpStatus.OK
        <span class="integer">1</span> * emailService.send(_) <i class="conum" data-value="1"></i><b>(1)</b>
    }

    <span class="annotation">@TestConfiguration</span>
    <span class="directive">static</span> <span class="type">class</span> <span class="class">EmailServiceConfiguration</span> {
        <span class="directive">private</span> DetachedMockFactory factory = <span class="keyword">new</span> DetachedMockFactory()

        <span class="annotation">@Bean</span>
        EmailService emailService() {
            factory.Mock(EmailService)
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>emailService.send</code> method is invoked once.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Learn more about <a href="http://spockframework.org/spock/docs/1.1/module_spring.html">Spring Spock integration</a> in Spock documentation.</p>
</div>


<h1 id="helpWithGrails">3 Do you need help with Grails?</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-email/edit/master/src/main/docs/guide/helpWithGrails.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<h3 style="color: #333; margin-bottom:25px;"><a href="https://objectcomputing.com/" target="_blank">Object Computing, Inc.</a> (OCI) sponsored the creation of this Guide. A variety of consulting and support services are available.</h3>

<!-- BEGIN HubSpot Consultation Form -->

<!--[if lte IE 8]>
<script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2-legacy.js"></script>
<![endif]-->
<script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2.js"></script>
<script>
  hbspt.forms.create({
	portalId: "4547412",
	formId: "f8bc9b16-d5f6-4226-a24e-da0eb8b73363"
});
</script>

<!-- END HubSpot Consultation Form -->

<h3 style="color: #333;">OCI is Home to Grails</h3>

<p><a href="https://objectcomputing.com/products/2gm-team" target="_blank">Meet the Team</a></p>

</article></div><footer>
  <div class='content'>
    <div class='ocihometograils'>
      <span>Sponsored by</span>
      <a href='https://objectcomputing.com/products/grails/'><img class='' src='/images/oci_home_to_grails.svg' alt='Object Computing - Home to Grails' width='300px' /></a>
    </div>
    <nav class='socialmedianav'><ul>
  <li>
    <a href='https://slack.grails.org'><img class='' src='/images/slack.svg' alt='Slack Icon' /></a>
  </li>
  <li>
    <a href='https://www.youtube.com/watch?v=XnRNfDGkBVg&amp;list=PLI74De5M9T73uH3WilDCePP2qfSDpMaGu'><img class='' src='/images/youtube.svg' alt='Youtube Icon' /></a>
  </li>
  <li>
    <a href='https://www.linkedin.com/groups/39757'><img class='' src='/images/linkedin.svg' alt='LinkedIn Icon' /></a>
  </li>
  <li>
    <a href='https://github.com/grails/'><img class='' src='/images/github.svg' alt='Github Icon' /></a>
  </li>
  <li>
    <a href='https://twitter.com/grailsframework'><img class='' src='/images/twitter.svg' alt='Twitter Icon' /></a>
  </li>
</ul></nav>
    <nav class='partnersnav'><ul>
  <li>Grails' repositories are hosted by
    <a href='https://repo.grails.org/'>Artifactory</a>
  </li>
  <li>Website hosting provided by
    <a href='https://aws.amazon.com/'>AWS</a>
  </li>
  <li>JetBrains supports Grails with its 
    <a href='https://www.jetbrains.com/idea/'>IntelliJ IDEA IDE</a>
  </li>
  <li>YourKit supports Grails with its 
    <a href='https://www.yourkit.com/java/profiler/index.jsp'>Java Profiler</a>
  </li>
  <li>Grails is Open Source
    <a href='http://www.apache.org/licenses/LICENSE-2.0.html'>Apache 2 License</a>
  </li>
  <li>
    <a href='https://grails.org/buildstatus.html'>Build Status</a>
  </li>
</ul></nav>
  </div>
</footer><div>
  <script type='text/javascript'>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-82213539-2', 'auto');
              ga('send', 'pageview');
</script>
  <script type='text/javascript'>
adroll_adv_id = "HBWJH4CQCJGS5DJRSB4Z4D";
adroll_pix_id = "IVEQYFOZXZAPZMDVQH7BFE";
/* OPTIONAL: provide email to improve user identification */
/* adroll_email = "username@example.com"; */
(function () {
    var _onload = function(){
        if (document.readyState && !/loaded|complete/.test(document.readyState)){setTimeout(_onload, 10);return}
        if (!window.__adroll_loaded){__adroll_loaded=true;setTimeout(_onload, 50);return}
        var scr = document.createElement("script");
        var host = (("https:" == document.location.protocol) ? "https://s.adroll.com" : "http://a.adroll.com");
        scr.setAttribute('async', 'true');
        scr.type = "text/javascript";
        scr.src = host + "/j/roundtrip.js";
        ((document.getElementsByTagName('head') || [null])[0] ||
            document.getElementsByTagName('script')[0].parentNode).appendChild(scr);
    };
    if (window.addEventListener) {window.addEventListener('load', _onload, false);}
    else {window.attachEvent('onload', _onload)}
}());            
</script>
</div></body>
</html>
