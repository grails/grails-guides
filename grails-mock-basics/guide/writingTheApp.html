<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>3 Writing the Application</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/guide.css" type="text/css" media="screen, print" title="Style" charset="utf-8" />            
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Grails Framework Guide 
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/training.html"><strong>1</strong><span>Grails Training</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/gettingStarted.html"><strong>2</strong><span>Getting Started</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/writingTheApp.html"><strong>3</strong><span>Writing the Application</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/summary.html"><strong>4</strong><span>Summary</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/runningTheApp.html"><strong>5</strong><span>Running the Application</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/gettingStarted.html">&lt;&lt; <strong>2</strong><span>Getting Started</span></a></div>
                

                
                    <div class="toc-item next-right"><a href="../guide/summary.html"><strong>4</strong><span>Summary</span> >></a></div>
                


                
                <div id="table-of-content">
                    <h2>Table of Contents</h2>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#domainClasses"><strong>3.1</strong><span>Domain Classes</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#gormHibernate"><strong>3.2</strong><span>Gorm Hibernate</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#dynamicFinderService"><strong>3.3</strong><span>DynamicFinder Service</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#dynamicFinderServiceTests"><strong>3.4</strong><span>HibernateSpec</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#gormService"><strong>3.5</strong><span>Projection Query</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#integrationTests"><strong>3.6</strong><span>Service Integration tests</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#serviceWithCollaborators"><strong>3.7</strong><span>Service with Collaborators</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#testEmailWithMock"><strong>3.8</strong><span>Test Email with Mock Collaborators</span></a>
                    </div>
                    
                </div>
                

                

<h1 id="writingTheApp">3 Writing the Application</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-mock-basics/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We are going to write a simple application involving a <code>Classroom</code> and a <code>Student</code> domain class.</p>
</div>
<div class="paragraph">
<p>Several services will interact with those domain classes. We will use those services to discuss several testing topics.</p>
</div>


<h2 id="domainClasses">3.1 Domain Classes</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-mock-basics/edit/master/src/main/docs/guide/domainClasses.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We will create Domain classes that serve as the basis for the application. The <code>Student</code> and <code>Classroom</code> have a one-to-many relationship, where the <code>Classroom</code> holds many <code>Student</code>(s).
A <code>Student</code> can be enrolled in one <code>Classroom</code> or none.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&gt; grails create-domain-class Student</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add domain properties to the created class file.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/domain/grails/mock/basics/Student.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> grails.mock.basics

<span class="keyword">import</span> <span class="include">grails.compiler.GrailsCompileStatic</span>

<span class="annotation">@GrailsCompileStatic</span>
<span class="type">class</span> <span class="class">Student</span> {
    <span class="predefined-type">String</span> name
    <span class="predefined-type">BigDecimal</span> grade
    Classroom classroom

    <span class="directive">static</span> constraints = {
        classroom <span class="key">nullable</span>: <span class="predefined-constant">true</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&gt; grails create-domain-class Classroom</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, add domain properties to the created class file. This time note that Classroom <code>hasMany</code> Students. This creates the one-to-many relationship.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/domain/grails/mock/basics/Classroom.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> grails.mock.basics

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">Classroom</span> {

    <span class="predefined-type">String</span> teacher
    <span class="directive">static</span> hasMany = [<span class="key">students</span>: Student]
}</code></pre>
</div>
</div>


<h2 id="gormHibernate">3.2 Gorm Hibernate</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-mock-basics/edit/master/src/main/docs/guide/gormHibernate.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We are using the GORM 6.1.6.RELEASE.</p>
</div>
<div class="listingblock">
<div class="title">gradle.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">grailsVersion=<span class="float">3.3</span><span class="float">.0</span>
grailsWrapperVersion=<span class="float">1.0</span><span class="float">.0</span>
gormVersion=<span class="float">6.1</span><span class="float">.6</span>.RELEASE
gradleWrapperVersion=<span class="float">3.5</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">buildscript {
    repositories {
        mavenLocal()
        maven { url <span class="string"><span class="delimiter">&quot;</span><span class="content">https://repo.grails.org/grails/core</span><span class="delimiter">&quot;</span></span> }
    }
    dependencies {
        classpath <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails:grails-gradle-plugin:</span><span class="inline"><span class="inline-delimiter">$</span>grailsVersion</span><span class="delimiter">&quot;</span></span>
        classpath <span class="string"><span class="delimiter">&quot;</span><span class="content">com.bertramlabs.plugins:asset-pipeline-gradle:2.14.2</span><span class="delimiter">&quot;</span></span>
        classpath <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails.plugins:hibernate5:</span><span class="inline"><span class="inline-delimiter">${</span>gormVersion-<span class="string"><span class="delimiter">&quot;</span><span class="content">.RELEASE</span><span class="delimiter">&quot;</span></span><span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
    }
}

version <span class="string"><span class="delimiter">&quot;</span><span class="content">0.1</span><span class="delimiter">&quot;</span></span>
group <span class="string"><span class="delimiter">&quot;</span><span class="content">grails.mock.basics</span><span class="delimiter">&quot;</span></span>

apply <span class="key">plugin</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">eclipse</span><span class="delimiter">&quot;</span></span>
apply <span class="key">plugin</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">idea</span><span class="delimiter">&quot;</span></span>
apply <span class="key">plugin</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">war</span><span class="delimiter">&quot;</span></span>
apply <span class="key">plugin</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails.grails-web</span><span class="delimiter">&quot;</span></span>
apply <span class="key">plugin</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">asset-pipeline</span><span class="delimiter">&quot;</span></span>
apply <span class="key">plugin</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails.grails-gsp</span><span class="delimiter">&quot;</span></span>
apply <span class="key">plugin</span>: <span class="string"><span class="delimiter">'</span><span class="content">codenarc</span><span class="delimiter">'</span></span>

repositories {
    mavenLocal()
    maven { url <span class="string"><span class="delimiter">&quot;</span><span class="content">https://repo.grails.org/grails/core</span><span class="delimiter">&quot;</span></span> }
}

dependencies {
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.boot:spring-boot-starter-logging</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.boot:spring-boot-autoconfigure</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails:grails-core</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.boot:spring-boot-starter-actuator</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.boot:spring-boot-starter-tomcat</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails:grails-web-boot</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails:grails-logging</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails:grails-plugin-rest</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails:grails-plugin-databinding</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails:grails-plugin-i18n</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails:grails-plugin-services</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails:grails-plugin-url-mappings</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails:grails-plugin-interceptors</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails.plugins:cache</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails.plugins:async</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails.plugins:scaffolding</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails.plugins:events</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails.plugins:hibernate5</span><span class="delimiter">&quot;</span></span>  <i class="conum" data-value="1"></i><b>(1)</b>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate:hibernate-core:5.1.5.Final</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails.plugins:gsp</span><span class="delimiter">&quot;</span></span>
    console <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails:grails-console</span><span class="delimiter">&quot;</span></span>
    profile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails.profiles:web</span><span class="delimiter">&quot;</span></span>
    runtime <span class="string"><span class="delimiter">&quot;</span><span class="content">org.glassfish.web:el-impl:2.1.2-b03</span><span class="delimiter">&quot;</span></span>
    runtime <span class="string"><span class="delimiter">&quot;</span><span class="content">com.h2database:h2</span><span class="delimiter">&quot;</span></span>
    runtime <span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.tomcat:tomcat-jdbc</span><span class="delimiter">&quot;</span></span>
    runtime <span class="string"><span class="delimiter">&quot;</span><span class="content">com.bertramlabs.plugins:asset-pipeline-grails:2.14.2</span><span class="delimiter">&quot;</span></span>
    testCompile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails:grails-gorm-testing-support</span><span class="delimiter">&quot;</span></span>
    testCompile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails.plugins:geb</span><span class="delimiter">&quot;</span></span>
    testCompile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails:grails-web-testing-support</span><span class="delimiter">&quot;</span></span>
    testRuntime <span class="string"><span class="delimiter">&quot;</span><span class="content">org.seleniumhq.selenium:selenium-htmlunit-driver:2.47.1</span><span class="delimiter">&quot;</span></span>
    testRuntime <span class="string"><span class="delimiter">&quot;</span><span class="content">net.sourceforge.htmlunit:htmlunit:2.18</span><span class="delimiter">&quot;</span></span>
}

bootRun {
    jvmArgs(<span class="string"><span class="delimiter">'</span><span class="content">-Dspring.output.ansi.enabled=always</span><span class="delimiter">'</span></span>)
    addResources = <span class="predefined-constant">true</span>
}

assets {
    minifyJs = <span class="predefined-constant">true</span>
    minifyCss = <span class="predefined-constant">true</span>
}

codenarc {
    toolVersion = <span class="string"><span class="delimiter">'</span><span class="content">0.27.0</span><span class="delimiter">'</span></span>
    configFile = file(<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span>project.projectDir<span class="inline-delimiter">}</span></span><span class="content">/config/codenarc/rules.groovy</span><span class="delimiter">&quot;</span></span>)
    reportFormat = <span class="string"><span class="delimiter">'</span><span class="content">html</span><span class="delimiter">'</span></span>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For this guide we are using GORM Hibernate implementation</td>
</tr>
</table>
</div>


<h2 id="dynamicFinderService">3.3 DynamicFinder Service</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-mock-basics/edit/master/src/main/docs/guide/dynamicFinderService.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The next service uses a <a href="http://gorm.grails.org/latest/hibernate/manual/index.html#finders">GORM Dynamic Finder</a> to get a list of students with a grade above a threshold.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/grails/mock/basics/StudentService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> grails.mock.basics

<span class="keyword">import</span> <span class="include">grails.compiler.GrailsCompileStatic</span>
<span class="keyword">import</span> <span class="include">grails.transaction.Transactional</span>

<span class="annotation">@GrailsCompileStatic</span>
<span class="annotation">@Transactional</span>(readOnly = <span class="predefined-constant">true</span>)
<span class="type">class</span> <span class="class">StudentService</span> {

    <span class="predefined-type">List</span>&lt;Student&gt; findStudentsWithGradeAbove(<span class="predefined-type">BigDecimal</span> grade) {
        Student.findAllByGradeGreaterThanEquals(grade)
    }
}</code></pre>
</div>
</div>


<h2 id="dynamicFinderServiceTests">3.4 HibernateSpec</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-mock-basics/edit/master/src/main/docs/guide/dynamicFinderServiceTests.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We are going to use a unit test for the dynamic finder with the help of <code>HibernateSpec</code>. It allows Hibernate to be used in Grails unit tests. It uses a H2 in-memory database.</p>
</div>
<div class="listingblock">
<div class="title">src/test/groovy/grails/mock/basics/StudentServiceSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> grails.mock.basics

<span class="keyword">import</span> <span class="include">grails.test.hibernate.HibernateSpec</span>
<span class="keyword">import</span> <span class="include">grails.testing.services.ServiceUnitTest</span>

<span class="annotation">@SuppressWarnings</span>([<span class="string"><span class="delimiter">'</span><span class="content">MethodName</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">DuplicateNumberLiteral</span><span class="delimiter">'</span></span>])
<span class="type">class</span> <span class="class">StudentServiceSpec</span> <span class="directive">extends</span> HibernateSpec <span class="directive">implements</span> ServiceUnitTest&lt;StudentService&gt; {

    <span class="predefined-type">List</span>&lt;<span class="predefined-type">Class</span>&gt; getDomainClasses() { [Student] } <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="keyword">def</span> <span class="string"><span class="delimiter">'</span><span class="content">test find students with grades above</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">students are already stored in db</span><span class="delimiter">'</span></span>
        Student.saveAll(
            <span class="keyword">new</span> Student(<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">Nirav</span><span class="delimiter">'</span></span>, <span class="key">grade</span>: <span class="integer">91</span>),
            <span class="keyword">new</span> Student(<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">Sergio</span><span class="delimiter">'</span></span>, <span class="key">grade</span>: <span class="integer">95</span>),
            <span class="keyword">new</span> Student(<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">Jeff</span><span class="delimiter">'</span></span>, <span class="key">grade</span>: <span class="integer">93</span>),
        )

        <span class="key">then</span>:
        Student.count() == <span class="integer">3</span>

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">service is called to search</span><span class="delimiter">'</span></span>
        <span class="predefined-type">List</span>&lt;Student&gt; students = service.findStudentsWithGradeAbove(<span class="integer">92</span>)

        <span class="key">then</span>: <span class="string"><span class="delimiter">'</span><span class="content">students are found with appropriate grades</span><span class="delimiter">'</span></span>
        students.size() == <span class="integer">2</span>
        students[<span class="integer">0</span>].name == <span class="string"><span class="delimiter">'</span><span class="content">Sergio</span><span class="delimiter">'</span></span>
        students[<span class="integer">0</span>].grade == <span class="integer">95</span>
        students[<span class="integer">1</span>].name == <span class="string"><span class="delimiter">'</span><span class="content">Jeff</span><span class="delimiter">'</span></span>
        students[<span class="integer">1</span>].grade == <span class="integer">93</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Test a limited set of domain classes, override <code>getDomainClasses</code> method and specify exactly which ones you wish to test.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If the service under test uses <code>@Transactional</code> you will need to assign the transaction manager within the unit testâ€™s setup method.</td>
</tr>
</table>
</div>


<h2 id="gormService">3.5 Projection Query</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-mock-basics/edit/master/src/main/docs/guide/gormService.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The next service uses Criteria query with a projection to calculate the average grade of the students enrolled in a classroom, identified by its teacher name.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/grails/mock/basics/ClassroomService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> grails.mock.basics

<span class="keyword">import</span> <span class="include">grails.transaction.Transactional</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="annotation">@Transactional</span>(readOnly = <span class="predefined-constant">true</span>)
<span class="type">class</span> <span class="class">ClassroomService</span> {

    <span class="predefined-type">BigDecimal</span> calculateAvgGrade(<span class="predefined-type">String</span> teacherName) {
        Student.where {
            classroom.teacher == teacherName
        }.projections {
            avg(<span class="string"><span class="delimiter">'</span><span class="content">grade</span><span class="delimiter">'</span></span>)
        }.get() <span class="keyword">as</span> <span class="predefined-type">BigDecimal</span>
    }
}</code></pre>
</div>
</div>


<h2 id="integrationTests">3.6 Service Integration tests</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-mock-basics/edit/master/src/main/docs/guide/integrationTests.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We could unit test a project query with a unit test. See:</p>
</div>
<div class="paragraph">
<p><code>.src/test/groovy/grails/mock/basics/ClassroomServiceSpec.groovy</code></p>
</div>
<div class="paragraph">
<p>However, you may want to use an integration test. For example, you may want to test the query against the same database which you use in production.</p>
</div>
<div class="paragraph">
<p>Just use <code>@Autowired</code> to inject your service into your integration tests as displayed below:</p>
</div>
<div class="listingblock">
<div class="title">src/integration-test/groovy/grails/mock/basics/ClassroomServiceIntegrationSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> grails.mock.basics

<span class="keyword">import</span> <span class="include">grails.testing.mixin.integration.Integration</span>
<span class="keyword">import</span> <span class="include">grails.transaction.Rollback</span>
<span class="keyword">import</span> <span class="include">org.springframework.beans.factory.annotation.Autowired</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">'</span><span class="content">MethodName</span><span class="delimiter">'</span></span>)
<span class="annotation">@Rollback</span>
<span class="annotation">@Integration</span>
<span class="type">class</span> <span class="class">ClassroomServiceIntegrationSpec</span> <span class="directive">extends</span> Specification {

    <span class="annotation">@Autowired</span> ClassroomService service

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test calculate average grade of classroom</span><span class="delimiter">'</span></span>() {
        <span class="key">when</span>:
        <span class="keyword">def</span> classroom = <span class="keyword">new</span> Classroom(<span class="key">teacher</span>: <span class="string"><span class="delimiter">'</span><span class="content">Smith</span><span class="delimiter">'</span></span>)
        [
                [<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">Nirav</span><span class="delimiter">'</span></span>, <span class="key">grade</span>: <span class="integer">91</span>],
                [<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">Sergio</span><span class="delimiter">'</span></span>, <span class="key">grade</span>: <span class="integer">95</span>],
                [<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">Jeff</span><span class="delimiter">'</span></span>, <span class="key">grade</span>: <span class="integer">93</span>],
        ].each {
            classroom.addToStudents(<span class="keyword">new</span> Student(<span class="key">name</span>: <span class="local-variable">it</span>.name, <span class="key">grade</span>: <span class="local-variable">it</span>.grade))
        }
        classroom.save()

        <span class="key">then</span>:
        Classroom.count() == <span class="integer">1</span>
        Student.count() == <span class="integer">3</span>

        <span class="key">when</span>:
        <span class="predefined-type">BigDecimal</span> avgGrade = service.calculateAvgGrade(<span class="string"><span class="delimiter">'</span><span class="content">Smith</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>:
        avgGrade == <span class="float">93.0</span>
    }
}</code></pre>
</div>
</div>


<h2 id="serviceWithCollaborators">3.7 Service with Collaborators</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-mock-basics/edit/master/src/main/docs/guide/serviceWithCollaborators.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We have a service which collaborates with another service to perform an action. This is a common use case. We are going to
learn how to mock collaborators to test the service logic in isolation.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/grails/mock/basics/ClassroomGradesNotificationService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> grails.mock.basics

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">ClassroomGradesNotificationService</span> {

    EmailService emailService

    <span class="type">int</span> emailClassroomStudents(Classroom classroom) {
        <span class="type">int</span> emailCount = <span class="integer">0</span>
        <span class="keyword">for</span> ( Student student <span class="keyword">in</span> classroom.students ) {
            <span class="keyword">def</span> email = emailFromTeacherToStudent(classroom.teacher, student)
            emailCount += emailService.sendEmail(email)
        }
        emailCount
    }

    <span class="predefined-type">Map</span> emailFromTeacherToStudent(<span class="predefined-type">String</span> teacher, Student student) {
        [
                <span class="key">to</span>: <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span>student.name<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>,
                <span class="key">from</span>: <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span>teacher<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>,
                <span class="key">note</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Grade is </span><span class="inline"><span class="inline-delimiter">${</span>student.grade<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>,
        ]
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/services/grails/mock/basics/EmailService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> grails.mock.basics

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">groovy.util.logging.Slf4j</span>

<span class="annotation">@Slf4j</span>
<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">EmailService</span> {

    <span class="type">int</span> sendEmail(<span class="predefined-type">Map</span> message) {
        log.info <span class="string"><span class="delimiter">&quot;</span><span class="content">Send email: </span><span class="inline"><span class="inline-delimiter">${</span>message<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>
        <span class="integer">1</span>
    }
}</code></pre>
</div>
</div>


<h2 id="testEmailWithMock">3.8 Test Email with Mock Collaborators</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-mock-basics/edit/master/src/main/docs/guide/testEmailWithMock.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The Spock framework gives the ability to mock collaborators. We are able to substitute dependencies within a service with a mock implementation. This gives the advantage of focusing on the functionality under test, while delegating the dependent functionality to a mock object. In addition, mock collaborators can be verified to see how many times they are called and which parameters are being sent.</p>
</div>
<div class="paragraph">
<p>Implement the code to test email with a mock collaborator. Essentially, we want to verify the email service is called for each <code>Student</code> in a <code>Classroom</code>.</p>
</div>
<div class="listingblock">
<div class="title">src/test/groovy/grails/mock/basics/ClassroomGradesNotificationServiceSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> grails.mock.basics


<span class="keyword">import</span> <span class="include">grails.testing.gorm.DataTest</span>
<span class="keyword">import</span> <span class="include">grails.testing.services.ServiceUnitTest</span>
<span class="keyword">import</span> <span class="include">spock.lang.Shared</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>


<span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">'</span><span class="content">MethodName</span><span class="delimiter">'</span></span>)
<span class="type">class</span> <span class="class">ClassroomGradesNotificationServiceSpec</span> <span class="directive">extends</span> Specification
        <span class="directive">implements</span> DataTest, ServiceUnitTest&lt;ClassroomGradesNotificationService&gt; {

    <span class="annotation">@Shared</span> Classroom classroom

    <span class="keyword">def</span> <span class="function">setupSpec</span>() { <i class="conum" data-value="1"></i><b>(1)</b>
        mockDomain Student
        mockDomain Classroom
    }

    <span class="keyword">def</span> <span class="function">setup</span>() {
        classroom = <span class="keyword">new</span> Classroom(<span class="key">teacher</span>: <span class="string"><span class="delimiter">'</span><span class="content">Smith</span><span class="delimiter">'</span></span>)
        [
                [<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">Nirav</span><span class="delimiter">'</span></span>, <span class="key">grade</span>: <span class="integer">91</span>],
                [<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">Sergio</span><span class="delimiter">'</span></span>, <span class="key">grade</span>: <span class="integer">95</span>],
                [<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">Jeff</span><span class="delimiter">'</span></span>, <span class="key">grade</span>: <span class="integer">93</span>],
        ].each {
            classroom.addToStudents(<span class="keyword">new</span> Student(<span class="key">name</span>: <span class="local-variable">it</span>.name, <span class="key">grade</span>: <span class="local-variable">it</span>.grade))
        }
    }

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test email students with mock collaborator</span><span class="delimiter">'</span></span>() {
        <span class="key">given</span>: <span class="string"><span class="delimiter">'</span><span class="content">students are part of a classroom</span><span class="delimiter">'</span></span>
        <span class="keyword">def</span> mockService = Mock(EmailService) <i class="conum" data-value="2"></i><b>(2)</b>
        service.emailService = mockService <i class="conum" data-value="3"></i><b>(3)</b>

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">service is called to email students</span><span class="delimiter">'</span></span>
        <span class="type">int</span> emailCount = service.emailClassroomStudents(classroom) <i class="conum" data-value="4"></i><b>(4)</b>

        <span class="key">then</span>:
        <span class="integer">1</span> * mockService.sendEmail([<span class="key">to</span>: <span class="string"><span class="delimiter">'</span><span class="content">Sergio</span><span class="delimiter">'</span></span>, <span class="key">from</span>: <span class="string"><span class="delimiter">'</span><span class="content">Smith</span><span class="delimiter">'</span></span>, <span class="key">note</span>: <span class="string"><span class="delimiter">'</span><span class="content">Grade is 95</span><span class="delimiter">'</span></span>]) &gt;&gt; <span class="integer">1</span> <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="integer">1</span> * mockService.sendEmail([<span class="key">to</span>: <span class="string"><span class="delimiter">'</span><span class="content">Nirav</span><span class="delimiter">'</span></span>, <span class="key">from</span>: <span class="string"><span class="delimiter">'</span><span class="content">Smith</span><span class="delimiter">'</span></span>, <span class="key">note</span>: <span class="string"><span class="delimiter">'</span><span class="content">Grade is 91</span><span class="delimiter">'</span></span>]) &gt;&gt; <span class="integer">1</span>
        <span class="integer">1</span> * mockService.sendEmail([<span class="key">to</span>: <span class="string"><span class="delimiter">'</span><span class="content">Jeff</span><span class="delimiter">'</span></span>, <span class="key">from</span>: <span class="string"><span class="delimiter">'</span><span class="content">Smith</span><span class="delimiter">'</span></span>, <span class="key">note</span>: <span class="string"><span class="delimiter">'</span><span class="content">Grade is 93</span><span class="delimiter">'</span></span>]) &gt;&gt; <span class="integer">1</span>
        emailCount == <span class="integer">3</span>
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Mock domain classes</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Instantiate the mock implementation of <code>EmailService</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Inject the mock into the service.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Invoke the service under test, which now has a mock implementation of <code>EmailService</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Use the spock syntax to verify invocation, params, and return a value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the <code>then:</code> clause, we use spock to verify the mock was called. With <code>1 *</code>, this verfies it was called once. The parameters defined verify what was passed in during execution. The <code>&gt;&gt; 1</code> give the mock stub capability where it will return 1.</p>
</div>
<div class="paragraph">
<p>Essentially, we are verifying the mock was called three different times with different <code>Student</code> parameters.</p>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/gettingStarted.html">&lt;&lt; <strong>2</strong><span>Getting Started</span></a></div>
                
                    <div class="toc-item next-right"><a href="../guide/summary.html"><strong>4</strong><span>Summary</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title" style="text-align: right"><a href="https://travis-ci.org/grails-guides/grails-mock-basics"><img src="https://travis-ci.org/grails-guides/grails-mock-basics.svg?branch=master" /></a></div>            
                 <div class="local-title">
                    <a href="https://github.com/grails-guides/grails-mock-basics">
                    <svg height="35" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="35" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></a> &nbsp;&nbsp;Get the Code
                </div>
                <div class="menu">
                    <div class="input-group">                        
                        <button href="#" onclick="document.getElementById('github-url').value='git@github.com:grails-guides/grails-mock-basics.git'" class="codeButton">SSH</button>
                        <button onclick="document.getElementById('github-url').value='https://github.com/grails-guides/grails-mock-basics.git'" class="codeButton">HTTPS</button>
                        <button onclick="document.getElementById('github-url').value='https://github.com/grails-guides/grails-mock-basics'" class="codeButton">Subversion</button>
                    </div>
       
                    <div class="input-group">                    
                        <!-- Target -->
                        <input id="github-url" value="git@github.com:grails-guides/grails-mock-basics.git" type="text" />

                        <!-- Trigger -->
                        <button class="clipbtn" type="button" data-clipboard-target="#github-url">

                            <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
                        </button>       

                    </div>
                    <div class="input-group">
                      <a href="https://github.com/grails-guides/grails-mock-basics/archive/master.zip" class="downloadButton">Download ZIP</a>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing.
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
